//+------------------------------------------------------------------+
//| Expert tick function (V2.0 é€»è¾‘ä¿®æ­£ç‰ˆ)                             |
//+------------------------------------------------------------------+
void OnTick()
{
   // ==================================================================
   // 1. å…¨å±€æ€»å¼€å…³ (Master Switch) - ä¼˜å…ˆçº§æœ€é«˜
   // ==================================================================
   if (!EA_Master_Switch) return;

   // ==================================================================
   // 2. æ•°æ®æ›´æ–° (Data Update) - å¿…é¡»åœ¨åšå†³ç­–å‰æ›´æ–°æ•°æ®
   // ==================================================================
   // å…ˆåˆ·æ–°æ­¤æ—¶æ­¤åˆ»çš„ç›ˆäºçŠ¶æ€å’Œè¿æŸçŠ¶æ€ï¼Œç¡®ä¿åç»­åˆ¤æ–­ä½¿ç”¨çš„æ˜¯æœ€æ–°æ•°æ®
   // åŒæ—¶ä¹Ÿå¤„ç†è·¨å¤©é‡ç½®é€»è¾‘
   UpdateCSLByHistory();  // æ›´æ–°è¿æŸè®¡æ•° & é”å®šæ—¶é—´
   UpdateDailyProfit();   // æ›´æ–°ä»Šæ—¥ç›ˆäº & è·¨å¤©é‡ç½®

   // ==================================================================
   // 3. æŒä»“ç®¡ç† (Trade Management) - å¿…é¡»æ— è®ºé£æ§ä¸å¦éƒ½æ‰§è¡Œ
   // ==================================================================
   // ğŸš¨ ä¿®æ­£ï¼šç§»åˆ°é£æ§æ£€æŸ¥ä¹‹å‰ã€‚
   // å³ä½¿ä¸èƒ½å¼€æ–°å•ï¼Œä¹Ÿè¦ç…§é¡¾å¥½æ‰‹é‡Œçš„è€å•å­ (è¿½è¸ªæ­¢æŸã€ä¿æœ¬ç­‰)
   ManageOpenTrades(); 

   // ==================================================================
   // 4. å¼€ä»“é£æ§æ£€æŸ¥ (Opening Filters) - å†³å®šæ˜¯å¦å…è®¸"å¼€æ–°ä»“"
   // ==================================================================
   // A. è¿ç»­æ­¢æŸé”å®šæ£€æŸ¥
   if (IsTradingLocked()) return; 

   // B. æ—¥å†…äºæŸé™é¢æ£€æŸ¥
   if (IsDailyLossLimitReached()) return;

   // C. äº¤æ˜“æ—¶æ®µæ£€æŸ¥
   if (!IsCurrentTimeInSlots()) return;

   // D. æœ€å¤§æŒä»“é‡æ£€æŸ¥ (æå‰åˆ°è¿™é‡Œï¼Œçœå»ä¸å¿…è¦çš„ä¿¡å·è®¡ç®—)
   if (GetOpenPositionsCount() >= Max_Positions) return;

   // ==================================================================
   // 5. æ–°Kçº¿æ£€æµ‹ (New Bar Check) - ä»…é™å¼€ä»“é€»è¾‘
   // ==================================================================
   if(Time[0] == g_last_bar_time) return;
   g_last_bar_time = Time[0]; 

   // ==================================================================
   // 6. æ¸…ç†å·¥ä½œ (Housekeeping)
   // ==================================================================
   // æ–°Kçº¿å¼€å§‹ï¼Œæ¸…ç†ä¸Šä¸€æ ¹Kçº¿çš„æ—§æ•°æ®
   CleanOldContextLinks();   // æ¸…ç†å¯è§†åŒ–è¿çº¿
   CleanUpShadowLedger();    // æ¸…ç†æ— æ•ˆçš„å½±å­è´¦æœ¬ (å¦‚æœæ²¡ç”¨OnTimerï¼Œè¿™é‡Œå¿…é¡»ä¿ç•™)

   // ==================================================================
   // 7. ä¿¡å·æ”¶é›†ä¸å¤„ç† (Signal Processing)
   // ==================================================================
   
   // A. æ”¶é›†åŸå§‹ä¿¡å·
   KBarSignal signals[];
   CollectAllSignals(signals);

   // B. è¿‡æ»¤å¼±åŠ¿ä¿¡å·
   KBarSignal filtered_signals[];
   FilterWeakSignals(signals, filtered_signals);

   // C. åˆå¹¶ä¸æ’åº
   KBarSignal final_signals[];
   MergeAndSortSignals(filtered_signals, final_signals);

   // ==================================================================
   // 8. ä¿¡å·æ‰§è¡Œå¾ªç¯ (Signal Execution Funnel)
   // ==================================================================
   int total = ArraySize(final_signals);
   
   for(int i = 0; i < total; i++)
   {
      KBarSignal signal_item = final_signals[i];
      int current_shift = iBarShift(NULL, 0, signal_item.OpenTime);
      
      // --- æ¼æ–—å±‚ 1: ä¸Šä¸‹æ–‡ç»“æ„æ£€æŸ¥ (Context) ---
      // åŒ…å«å¯è§†åŒ–è¿çº¿çš„ç»˜åˆ¶
      if (CheckSignalContext(signal_item, current_shift) == false)
         continue;
         
      // --- æ¼æ–—å±‚ 2: ç›ˆäºç©ºé—´æ£€æŸ¥ (Profit Space) ---
      if (CheckProfitSpace(signal_item) == false)
         continue;

      // --- æ¼æ–—å±‚ 3: åå‘æŒä»“è·ç¦»æ£€æŸ¥ (Hedge Distance) ---
      // é˜²æ­¢åœ¨æçª„åŒºé—´å†…éœ‡è¡åŒå‘å¼€ä»“
      if (CheckHedgeDistance(signal_item.type) == false)
         continue;

      // --- æ¼æ–—å±‚ 4: æŠ€æœ¯æŒ‡æ ‡å…±æŒ¯ (Filters) ---
      int trade_command = CheckSignalAndFilter_V2(signal_item, current_shift);
      
      if(trade_command != OP_NONE)
      {
         // --- æœ€ç»ˆå±‚: æ‰§è¡Œäº¤æ˜“ ---
         CalculateTradeAndExecute_V2(signal_item, trade_command);
         
         // è¿™é‡Œçš„ return æ„å‘³ç€ï¼šæ¯ä¸ª Tick (æ¯æ ¹Kçº¿) æœ€å¤šåªå¼€ä¸€å•ã€‚
         // å¼€å®Œä¸€å•å°±ä¼‘æ¯ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªå¾ªç¯ã€‚
         return; 
      }
   }
}