void OnTick()
{
   // 1. å…¨å±€å¼€å…³ä¸æ•°æ®æ›´æ–° (ä¿ç•™)
   if (!EA_Master_Switch) return;
   UpdateCSLByHistory_V3();
   UpdateDailyProfit_V4();

   // 2. é£æ§æ£€æŸ¥ (ä¿ç•™ - ä¿æŠ¤æ‰€æœ‰å¼•æ“)
   UpdateDashboard_V4(); 
   if (!IsCurrentTimeInSlots()) return;
   if (IsTradingLocked()) return;
   if (IsDailyLossLimitReached_V2()) return;
   if (GetOpenPositionsCount() >= Max_Open_Orders) return;

   // 3. æŒä»“ç®¡ç† (ä¿ç•™)
   // ManageOpenTrades(); // åŸæœ‰çš„

   // 4. æ–°Kçº¿æ£€æŸ¥ (ä¿ç•™)
   if(Time[0] == g_last_bar_time) return;
   g_last_bar_time = Time[0];
   CleanOldContextLinks();

   // =========================================================
   // ğŸ”€ å¼•æ“è·¯ç”± (The Router) - ç¨åæˆ‘ä»¬å°†åœ¨è¿™é‡Œæ’å…¥åˆ‡æ¢å¼€å…³
   // =========================================================

   // ç›®å‰æš‚æ—¶åªè°ƒç”¨æ—§å¼•æ“ï¼Œç¡®ä¿ä»£ç æ²¡å
   OnTick_Legacy_V1(); 
}
----------------------------------------------------------------------
// ... åŸæœ‰çš„ include ...
#include <KBot_Draw.mqh>

// ğŸš¨ [æ­¥éª¤ 2.1] å¼•å…¥ v3 æ–°å¤§è„‘
#include <K_Logic_v3.mqh> 

// ==========================================================================
// ğŸ›ï¸ [æ­¥éª¤ 2.2] å¼•æ“æ§åˆ¶å° (Engine Control)
// ==========================================================================
input string   __ENGINE_SETTINGS__    = "=== æ ¸å¿ƒå¼•æ“è®¾ç½® ===";
input bool     Enable_V3_Engine       = true;       // [æ€»å¼€å…³] True=å¯ç”¨æ™ºèƒ½å†…æ ¸; False=ä½¿ç”¨åŸå§‹é€»è¾‘
input bool     Enable_Active_Exit     = true;       // [é£æ§] æ˜¯å¦å¯ç”¨ä¸»åŠ¨ç¦»åœº (å‡çªç ´/æ—¶é—´æ­¢æŸ)
input bool     Show_Debug_Marks       = true;       // [è°ƒè¯•] å½±å­æ¨¡å¼ï¼šä»…ç”»å‰ä¸å¹³ä»“ (å»ºè®®åˆæœŸå¼€å¯)

// v3 ç­–ç•¥å‚æ•°
input ENUM_SIGNAL_GRADE Min_Trade_Grade = GRADE_B;  // æœ€ä½å¼€å•è¯„çº§ (å»ºè®® B æˆ– A)
input double   Min_Space_Factor       = 0.8;        // æœ€å°ç©ºé—´å› å­ (ATRå€æ•°)

// ä¸»åŠ¨é£æ§å‚æ•° (ä¹‹å‰è®¾è®¡çš„)
input bool     Use_P1_Break_Exit      = true;       // è·Œå› P1 ç¦»åœº
input int      P1_Buffer_Mode         = 1;          // 0=ç‚¹æ•°, 1=ATR
input double   P1_Tolerance           = 0.5;        // å®¹å¿é˜ˆå€¼
input int      P1_Confirm_Bars        = 1;          // ç¡®è®¤Kçº¿æ•°
input int      Max_Stagnant_Bars      = 12;         // æ—¶é—´æ­¢æŸ: å¤šå°‘æ ¹Kçº¿æ»æ¶¨
input double   Time_Exit_Min_Profit   = 100;        // åˆ©æ¶¦ä¿æŠ¤ç‚¹æ•°
input bool     Allow_Reentry          = true;       // å…è®¸å›å¤´è‰
input int      Reentry_Cooldown       = 5;          // å†·å´æœŸ