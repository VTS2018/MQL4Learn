//+------------------------------------------------------------------+
//| OnTick V2.1: æ ¸å¿ƒé€»è¾‘å¾ªç¯ (æœ€ç»ˆä¿®æ­£ç‰ˆ)
//+------------------------------------------------------------------+
void OnTick()
{
   // ==================================================================
   // 1. å…¨å±€æ€»å¼€å…³ (Master Switch) - ä¼˜å…ˆçº§æœ€é«˜
   // ==================================================================
   if (!EA_Master_Switch) return;

   // ==================================================================
   // 2. æ•°æ®æ›´æ–° (Data Update) - å¿…é¡»åœ¨åšå†³ç­–å‰æ›´æ–°æ•°æ®
   // ==================================================================
   // ğŸš¨ ä¿®æ­£ï¼šç§»åˆ°æœ€å‰é¢ã€‚æ— è®ºæ˜¯å¦åœ¨äº¤æ˜“æ—¶æ®µï¼Œéƒ½è¦æ›´æ–°è¿æŸå’Œç›ˆäºçŠ¶æ€ã€‚
   // ç¡®ä¿è·¨å¤©é‡ç½®é€»è¾‘ (Reset) èƒ½åœ¨ 00:00 å‡†æ—¶æ‰§è¡Œï¼Œé¿å…æ­»é”ã€‚
   UpdateCSLByHistory_V2();  // æ›´æ–°è¿æŸè®¡æ•° & é”å®šæ—¶é—´
   UpdateDailyProfit_V2();   // æ›´æ–°ä»Šæ—¥ç›ˆäº & è·¨å¤©é‡ç½®

   // ==================================================================
   // 3. æŒä»“ç®¡ç† (Trade Management) - å¿…é¡»æ— è®ºé£æ§ä¸å¦éƒ½æ‰§è¡Œ
   // ==================================================================
   // å³ä½¿ä¸åœ¨äº¤æ˜“æ—¶æ®µï¼Œåªè¦æœ‰å•å­åœ¨åœºå†…ï¼Œå°±å¿…é¡»è¿½è¸ªæ­¢æŸï¼
   ManageOpenTrades(); 

   // ==================================================================
   // 4. å¼€ä»“é£æ§æ£€æŸ¥ (Opening Filters) - å†³å®šæ˜¯å¦å…è®¸"å¼€æ–°ä»“"
   // ==================================================================
   
   // A. äº¤æ˜“æ—¶æ®µæ£€æŸ¥
   if (!IsCurrentTimeInSlots())
   {
      // (å¯é€‰) å‡å°‘æ‰“å°é¢‘ç‡ï¼Œæˆ–ä»…åœ¨è°ƒè¯•æ¨¡å¼æ‰“å°
      // Print("å½“å‰éäº¤æ˜“æ—¶æ®µï¼ŒEA æš‚åœå¼€æ–°ä»“..."); 
      return; 
   }

   // B. è¿ç»­æ­¢æŸé”å®šæ£€æŸ¥
   if (IsTradingLocked()) return; 

   // C. æ—¥å†…äºæŸé™é¢æ£€æŸ¥
   if (IsDailyLossLimitReached_V2()) return;

   // D. æœ€å¤§æŒä»“é‡æ£€æŸ¥ (æå‰æ£€æŸ¥ï¼Œçœå»åé¢å¤æ‚çš„ä¿¡å·è®¡ç®—)
   if (GetOpenPositionsCount() >= Max_Open_Orders) return;

   // ==================================================================
   // 5. æ–°Kçº¿æ£€æµ‹ (New Bar Check) - ä»…é™å¼€ä»“é€»è¾‘
   // ==================================================================
   if(Time[0] == g_last_bar_time) return;
   g_last_bar_time = Time[0]; 

   // ==================================================================
   // 6. æ¸…ç†å·¥ä½œ (Housekeeping)
   // ==================================================================
   CleanOldContextLinks();   // æ¸…ç†ä¸Šä¸€æ ¹Kçº¿çš„å¯è§†åŒ–è¿çº¿
   CleanUpShadowLedger();    // æ¸…ç†æ— æ•ˆçš„å½±å­è´¦æœ¬æ•°æ®

   // ==================================================================
   // 7. ä¿¡å·æ”¶é›†ä¸æ‰§è¡Œ (V4.0 æ ¸å¿ƒé€»è¾‘)
   // ==================================================================
   
   // 7.1 å®šä¹‰æ•°ç»„
   FilteredSignal raw_bulls[], raw_bears[];     
   FilteredSignal clean_bulls[], clean_bears[]; 
   FilteredSignal sorted_valid_signals[];       

   // 7.2 æ”¶é›†ä¸æ¸…æ´—
   CollectAllSignals(raw_bulls, raw_bears);
   FilterWeakBullishSignals(raw_bulls, clean_bulls); 
   FilterWeakBearishSignals(raw_bears, clean_bears); 

   // (å¯é€‰) è¿è¡Œæµ‹è¯•æŸ¥çœ‹ç»“æœ
   // Test_FilterWeakBullish_And_BearishSignals(raw_bulls, raw_bears, clean_bulls, clean_bears);
   
   // 7.3 åˆå¹¶å¹¶æ’åº (ç”Ÿæˆåˆ—è¡¨ X)
   MergeAndSortSignals(clean_bulls, clean_bears, sorted_valid_signals);

   int total_valid_signals = ArraySize(sorted_valid_signals);
   // Test_MergeAndSortSignals(sorted_valid_signals);

   if (total_valid_signals <= 0) return; // æ— ä¿¡å·ï¼Œç›´æ¥é€€å‡º

   // 7.4 ç²¾è‹±ä¿¡å·å†³ç­–å¾ªç¯
   for (int i = 0; i < total_valid_signals; i++)
   {
      FilteredSignal signal_item = sorted_valid_signals[i];
      int current_shift = signal_item.shift;

      // A. è·å–å®Œæ•´æ•°æ®
      KBarSignal full_data = GetIndicatorBarData(current_shift);

      // B. æ¼æ–—å±‚ 1: ä¸Šä¸‹æ–‡ç»“æ„æ£€æŸ¥ (Context)
      int context_result = CheckSignalContext(current_shift, signal_item.type, clean_bulls, clean_bears);
      
      if (context_result > 0)
      {
         // Print("===> [Pass] ä¸Šä¸‹æ–‡æ£€æŸ¥é€šè¿‡ (ä»£ç :", context_result, ")ã€‚è¿›å…¥ç©ºé—´æ£€æŸ¥...");

         // C. æ¼æ–—å±‚ 2: åˆ©æ¶¦ç©ºé—´æ£€æŸ¥ (Reward/Risk)
         bool is_space_sufficient = false;
         double check_entry = Close[current_shift];
         double check_sl = (signal_item.type == OP_SELL) ? full_data.BearishStopLossPrice : full_data.BullishStopLossPrice;
         
         if (signal_item.type == OP_SELL)
             is_space_sufficient = CheckProfitSpace(OP_SELL, check_entry, check_sl, clean_bulls);
         else
             is_space_sufficient = CheckProfitSpace(OP_BUY, check_entry, check_sl, clean_bears);
         
         if (!is_space_sufficient) continue; // ç©ºé—´ä¸è¶³ï¼Œè·³è¿‡

         // D. æ¼æ–—å±‚ 3: åå‘æŒä»“è·ç¦»æ£€æŸ¥ (Hedge Distance)
         if (CheckHedgeDistance(signal_item.type) == false) return; // è·ç¦»å¤ªè¿‘ï¼Œæ”¾å¼ƒæœ¬æ¬¡å¼€ä»“

         // E. æ¼æ–—å±‚ 4: æŠ€æœ¯æŒ‡æ ‡å…±æŒ¯ (Filters) & æ‰§è¡Œ
         int trade_command = CheckSignalAndFilter_V2(full_data, current_shift);

         if (trade_command != OP_NONE)
         {
            // F. æœ€ç»ˆæ‰§è¡Œäº¤æ˜“
            CalculateTradeAndExecute_V2(full_data, trade_command);
            return; // å¼€å®Œä¸€å•å°±ä¼‘æ¯ï¼Œéµå¾ªä¸€æ ¹Kçº¿åªåšä¸€å•åŸåˆ™
         }
      }
   }
}