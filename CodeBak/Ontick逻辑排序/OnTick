//+------------------------------------------------------------------+
//| OnTick: æ ¸å¿ƒé€»è¾‘å¾ªç¯ (æ¯æ¬¡æŠ¥ä»·è·³åŠ¨è§¦å‘)
//+------------------------------------------------------------------+
void OnTick()
{
   //+------------------------------------------------------------------+
   // ğŸš¨ 1. å…¨å±€å¼€å…³æ§åˆ¶ ğŸš¨
   if (!EA_Master_Switch)
   {
      return; // å¼€å…³æœªå¯ç”¨ï¼Œç«‹å³é€€å‡º OnTick
   }
   
   // A. ğŸš¨ CSL çŠ¶æ€æ›´æ–°ï¼ˆæ¯ä¸ª Tick éƒ½æ£€æŸ¥å†å²è®°å½•ï¼‰ğŸš¨
   UpdateCSLByHistory();
   // ğŸš¨ NEW: æ—¥å†…ç›ˆäºå¢é‡æ›´æ–°
   UpdateDailyProfit(); 

   // B. CSL é”å®šæ£€æŸ¥ (é˜»æ­¢æ‰€æœ‰äº¤æ˜“)
   if (IsTradingLocked()) return;
   
   // 2. æ—¥å†…äºæŸé™é¢æ£€æŸ¥ (ç›´æ¥è¯»å–å…¨å±€å˜é‡)
   if (IsDailyLossLimitReached()) return;

   // ----------------------------------------------------
   // ğŸš¨ ä¼˜å…ˆçº§ 1.5: æœ€å¤§æŒä»“é™åˆ¶æ£€æŸ¥ (NEW!) ğŸš¨
   // ----------------------------------------------------
   // ä½¿ç”¨ä¿®æ­£åçš„é€»è¾‘ï¼Œå¦‚æœè¶…é™ï¼Œåœ¨å›¾è¡¨å³ä¸‹è§’æ˜¾ç¤ºè­¦å‘Š
   int current_positions = GetOpenPositionsCount(); 

   if (current_positions >= Max_Open_Orders)
   {
       // è­¦å‘Šæ˜¾ç¤ºé€»è¾‘å·²é›†æˆåœ¨ GetOpenPositionsCount æˆ–å¤–éƒ¨è°ƒç”¨ä¸­
       // å¦‚æœä½¿ç”¨äº†ä¹‹å‰çš„ä»£ç å»ºè®®ï¼Œè¿™é‡Œç›´æ¥ return å³å¯
       return; 
   }

   // --- 1. æ–°Kçº¿æ£€æµ‹æœºåˆ¶ (New Bar Check) ---
   if(Time[0] == g_last_bar_time) return;
   g_last_bar_time = Time[0]; // æ›´æ–°æ—¶é—´

   //+------------------------------------------------------------------+
   // 2. ğŸš¨ äº¤æ˜“ç®¡ç†æ”¿ç­–ï¼šé˜²æ­¢é‡å¤å¼€ä»“ (å¯é€‰) ğŸš¨
   // ...

   // 3.0 ç‰ˆæœ¬ å¿…é¡»ä½¿ç”¨æ‰«æé€»è¾‘
   Found_First_Qualified_Signal = false;

   //+------------------------------------------------------------------+
   // 4.0 ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®å‡†å¤‡ (æ”¶é›† -> æ¸…æ´— -> åˆå¹¶)
   // ==========================================================================
   
   FilteredSignal raw_bulls[], raw_bears[];
   FilteredSignal clean_bulls[], clean_bears[]; 
   FilteredSignal sorted_valid_signals[];

   // 1. æ”¶é›†
   CollectAllSignals(raw_bulls, raw_bears);
   
   // 2. æ¸…æ´— (ä¼˜èƒœåŠ£æ±°)
   FilterWeakBullishSignals(raw_bulls, clean_bulls); 
   FilterWeakBearishSignals(raw_bears, clean_bears);

   // 3. åˆå¹¶å¹¶æ’åº
   MergeAndSortSignals(clean_bulls, clean_bears, sorted_valid_signals);

   int total_valid_signals = ArraySize(sorted_valid_signals);
   if (total_valid_signals <= 0)
   {
      // Print("--- æ²¡æœ‰æ‰¾åˆ°å†å²ä¿¡å·æ•°æ® ä¸äº¤æ˜“!!! ---");
      return;
   }

   // ==========================================================================
   // ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæ‰§è¡Œå¾ªç¯ (åªé’ˆå¯¹ç²¾è‹±ä¿¡å·è¿›è¡Œå†³ç­–)
   // ==========================================================================

   // ğŸš¨ æ–°ç‰ˆæ ¸å¿ƒæ‰«æé€»è¾‘ï¼šå¾ªç¯â€œæœ‰æ•ˆä¿¡å·åˆ—è¡¨ Xâ€ ğŸš¨
   for (int i = 0; i < total_valid_signals; i++)
   {
      // A. ä»åˆ—è¡¨ä¸­æå–å…³é”®ä¿¡æ¯
      FilteredSignal signal_item = sorted_valid_signals[i];
      int current_shift = signal_item.shift;
      
      Print("===> æ£€æŸ¥ä¿¡å· K[", current_shift, "] ç±»å‹: ", (signal_item.type == OP_BUY ? "BUY" : "SELL"));

      // B. é‡æ–°è·å–å®Œæ•´çš„æŒ‡æ ‡æ•°æ®
      KBarSignal full_data = GetIndicatorBarData(current_shift);

      // ----------------------------------------------------
      // ğŸš¨ 4.0 ä¸Šä¸‹æ–‡é€»è¾‘ï¼šä½ç½®ä¼˜å…ˆåŸåˆ™
      // ----------------------------------------------------
      int context_result = CheckSignalContext(current_shift, signal_item.type, clean_bulls, clean_bears);
      
      // åˆ¤å®šé€»è¾‘ï¼š
      // å¦‚æœè¿”å› > 0 (1=åè½¬, 2=å›è¸©)ï¼Œè¯´æ˜æ˜¯ä¼˜è´¨ä¿¡å· (ä½ç½®æ­£ç¡®)
      if (context_result > 0)
      {
         Print("===> [Pass] ä¸Šä¸‹æ–‡æ£€æŸ¥é€šè¿‡ (ä»£ç :", context_result, ")ã€‚è¿›å…¥ç©ºé—´æ£€æŸ¥...");

         // ==========================================================================
         // ğŸš¨ 4.1 æ–°å¢ï¼šåˆ©æ¶¦ç©ºé—´æ£€æŸ¥ (Reward/Risk Check) ğŸš¨
         // ä½ç½®å¯¹äº†ï¼Œè¿˜è¦çœ‹æœ‰æ²¡æœ‰è‚‰åƒï¼ˆç›ˆäºæ¯”ï¼‰
         // ==========================================================================
         
         bool is_space_sufficient = false;
         
         // å‡†å¤‡è®¡ç®—å‚æ•°
         double check_entry = Close[current_shift]; // å‡è®¾ä»¥ä¿¡å·Kçº¿æ”¶ç›˜ä»·å…¥åœº
         double check_sl    = 0.0;
         
         // --- åˆ†ç±»æ£€æŸ¥ ---
         if (signal_item.type == OP_SELL)
         {
             check_sl = High[current_shift]; // åšç©ºæ­¢æŸé€šå¸¸åœ¨Kçº¿é«˜ç‚¹
             
             // æ£€æŸ¥åšç©ºç©ºé—´ï¼šä¼ å…¥ã€çœ‹æ¶¨åˆ—è¡¨ clean_bullsã€‘ä½œä¸ºä¸‹æ–¹çš„éšœç¢ç‰©
             is_space_sufficient = CheckProfitSpace(OP_SELL, check_entry, check_sl, clean_bulls);
         }
         else if (signal_item.type == OP_BUY)
         {
             check_sl = Low[current_shift];  // åšå¤šæ­¢æŸé€šå¸¸åœ¨Kçº¿ä½ç‚¹
             
             // æ£€æŸ¥åšå¤šç©ºé—´ï¼šä¼ å…¥ã€çœ‹è·Œåˆ—è¡¨ clean_bearsã€‘ä½œä¸ºä¸Šæ–¹çš„éšœç¢ç‰©
             is_space_sufficient = CheckProfitSpace(OP_BUY, check_entry, check_sl, clean_bears);
         }
         
         // --- å†³ç­– ---
         if (!is_space_sufficient)
         {
             Print("ğŸ›‘ [RiskControl] ä¿¡å· K[", current_shift, "] è¢«æ‹’ç»ï¼šç›ˆäºæ¯”ç©ºé—´ä¸è¶³ (Reward/Risk < é˜ˆå€¼)ã€‚");
             continue; // ğŸš¨ è·³è¿‡å½“å‰ä¿¡å·ï¼Œç»§ç»­å¾ªç¯æ£€æŸ¥ä¸‹ä¸€ä¸ªï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œæˆ–è€…ç›´æ¥é€€å‡ºå¾ªç¯
         }
         
         // ==========================================================================
         
         Print("âœ… [Pass] ç©ºé—´æ£€æŸ¥é€šè¿‡ã€‚å‡†å¤‡æ‰§è¡Œäº¤æ˜“é€»è¾‘...");

         // C. æ ¸å¿ƒå†³ç­–ï¼šæ‰§è¡Œå…¶ä»– L2/L3 è¿‡æ»¤ (è¶‹åŠ¿çº¿ã€åŠ¨é‡ã€æ–°é²œåº¦ç­‰)
         int trade_command = CheckSignalAndFilter_V2(full_data, current_shift);

         if (trade_command != OP_NONE)
         {
            // D. æ‰¾åˆ°æœ€æ–°ä¸”é€šè¿‡æ‰€æœ‰æ£€æŸ¥çš„ä¿¡å·ï¼Œæ‰§è¡Œäº¤æ˜“
            CalculateTradeAndExecute(full_data, trade_command);

            // E. ç«‹å³é€€å‡ºï¼
            // æ—¢ç„¶å·²ç»æ‰¾åˆ°äº†ä¸€ä¸ªå®Œç¾çš„ä¿¡å·å¹¶æ‰§è¡Œäº†ï¼Œæœ¬è½® OnTick ä»»åŠ¡å®Œæˆã€‚
            return;
         }
         
         // æ³¨æ„ï¼šå¦‚æœç©ºé—´å¤Ÿäº†ï¼Œä½† CheckSignalAndFilter_V2 æ²¡è¿‡ï¼ˆæ¯”å¦‚è¶‹åŠ¿ä¸ç¬¦ï¼‰ï¼Œ
         // ä»£ç ä¼šç»§ç»­å¾ªç¯ï¼Œæˆ–è€…åœ¨è¿™é‡Œ return (å–å†³äºæ‚¨çš„ç­–ç•¥æ˜¯åªæƒ³åšä¸€ä¸ªè¿˜æ˜¯ç»§ç»­æ‰¾)
         return; 
      }
   }
}