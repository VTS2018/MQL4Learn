//+------------------------------------------------------------------+
//| UpdateDailyProfit V3.0 (é€»è¾‘å®‰å…¨ + è°ƒè¯•ç‰ˆ)
//| ä¿®å¤ï¼šé˜²æ­¢å› æ€§èƒ½ä¼˜åŒ–é€»è¾‘å¯¼è‡´è·¨å¤©é‡ç½®è¢«è·³è¿‡
//+------------------------------------------------------------------+
void UpdateDailyProfit_V3()
{
   // =========================================================
   // 1. è·å–åŸºç¡€æ•°æ®
   // =========================================================
   datetime today_start = iTime(NULL, PERIOD_D1, 0); // ä»Šå¤© 00:00
   
   // =========================================================
   // 2. ğŸš¨ è·¨å¤©é‡ç½®é€»è¾‘ (æœ€é«˜ä¼˜å…ˆçº§ - å¿…é¡»å…ˆæ‰§è¡Œ) ğŸš¨
   // =========================================================
   if (g_Last_Calc_Date != today_start)
   {
      Print("ğŸ“… [æ–°çš„ä¸€å¤©] æ—¥æœŸå˜æ›´: ", TimeToString(g_Last_Calc_Date), " -> ", TimeToString(today_start));
      Print("   [é‡ç½®å‰] æ˜¨æ—¥ç›ˆäº: ", DoubleToString(g_Today_Realized_PL, 2));
      
      // å¼ºåˆ¶å½’é›¶
      g_Today_Realized_PL = 0.0;
      
      // æ›´æ–°æ—¥æœŸæ ‡è®°
      g_Last_Calc_Date = today_start;
      
      Print("   [é‡ç½®å] ä»Šæ—¥ç›ˆäºå·²å½’é›¶ã€‚");
   }

   // =========================================================
   // 3. æ€§èƒ½ä¼˜åŒ–é€»è¾‘ (åªæœ‰åœ¨å¤„ç†å®Œè·¨å¤©é‡ç½®åï¼Œæ‰å…è®¸ Return)
   // =========================================================
   static int s_last_history_total = 0;
   int current_history_total = OrdersHistoryTotal();

   // å¦‚æœå†å²è®¢å•æ•°æ²¡å˜ï¼Œè¯´æ˜æ²¡æœ‰æ–°å¹³ä»“ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—ç´¯åŠ 
   // æ³¨æ„ï¼šè¿™é‡Œ return ä¹‹å‰ï¼Œä¸Šé¢çš„é‡ç½®é€»è¾‘å·²ç»æ‰§è¡Œè¿‡äº†ï¼Œæ‰€ä»¥æ˜¯å®‰å…¨çš„ã€‚
   if (current_history_total == s_last_history_total) return;

   // =========================================================
   // 4. å…¨é‡æ‰«æé€»è¾‘ (è®¡ç®—ç›ˆäº)
   // =========================================================
   double temp_daily_profit = 0.0;
   
   for (int i = 0; i < current_history_total; i++)
   {
      if (OrderSelect(i, SELECT_BY_POS, MODE_HISTORY) == false) continue;
      if (OrderSymbol() != Symbol() || OrderMagicNumber() != MagicNumber) continue;
      if (OrderType() > OP_SELL) continue;

      // åªè®¡ç®—ä»Šå¤©äº§ç”Ÿçš„è®¢å•
      if (OrderCloseTime() < today_start) continue;

      temp_daily_profit += OrderProfit() + OrderCommission() + OrderSwap();
   }

   // =========================================================
   // 5. æ›´æ–°å…¨å±€çŠ¶æ€
   // =========================================================
   g_Today_Realized_PL = temp_daily_profit;
   
   // æ›´æ–°ç¼“å­˜å¿«ç…§
   s_last_history_total = current_history_total; 
   g_Last_Daily_Check_Time = TimeCurrent();
   
   // ä»…åœ¨æ•°æ®å˜åŒ–æ—¶æ‰“å°ï¼Œé¿å…åˆ·å±
   // Print("[ç›ˆäºå˜åŠ¨] æœ€æ–°ä»Šæ—¥ç›ˆäº: ", DoubleToString(g_Today_Realized_PL, 2));
}