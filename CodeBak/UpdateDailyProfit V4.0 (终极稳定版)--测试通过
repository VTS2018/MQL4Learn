//+------------------------------------------------------------------+
//| UpdateDailyProfit V4.0 (ç»ˆæç¨³å®šç‰ˆ)
//| æ ¸å¿ƒæ€æƒ³ï¼šæ— çŠ¶æ€è®¡ç®—ã€‚æ¯ä¸€å¸§éƒ½æ ¹æ®å½“å‰æ—¶é—´ï¼Œé‡æ–°ç»Ÿè®¡å½“æ—¥ç›ˆäºã€‚
//| ä¿®å¤ï¼šå½»åº•è§£å†³ iTime å»¶è¿Ÿå’Œé™æ€å˜é‡å¯¼è‡´çš„æ•°æ®å†»ç»“é—®é¢˜ã€‚
//+------------------------------------------------------------------+
void UpdateDailyProfit_V4()
{
   // =========================================================
   // 1. æ‰‹åŠ¨è®¡ç®—â€œä»Šå¤© 00:00:00â€çš„æ—¶é—´æˆ³ (ä¸ä¾èµ– iTime)
   // =========================================================
   datetime current_time = TimeCurrent();
   
   MqlDateTime dt;
   TimeToStruct(current_time, dt);
   
   // å°†æ—¶åˆ†ç§’å½’é›¶ï¼Œå¾—åˆ°ç»å¯¹çš„å½“å¤©èµ·å§‹æ—¶é—´
   dt.hour = 0;
   dt.min  = 0;
   dt.sec  = 0;
   
   datetime today_start = StructToTime(dt);

   // =========================================================
   // 2. æš´åŠ›å…¨é‡æ‰«æ (Stateless Calculation)
   // =========================================================
   // æ”¾å¼ƒ static ç¼“å­˜ï¼Œç¡®ä¿åªè¦æ—¶é—´å˜äº†ï¼Œç»“æœå°±èƒ½è‡ªåŠ¨å˜ã€‚
   
   int total_history = OrdersHistoryTotal();
   double temp_daily_profit = 0.0;
   
   for (int i = 0; i < total_history; i++)
   {
      // å¿…é¡»ä½¿ç”¨ continueï¼Œä¸èƒ½ break
      if (OrderSelect(i, SELECT_BY_POS, MODE_HISTORY) == false) continue;
      
      // A. åŸºç¡€è¿‡æ»¤
      if (OrderSymbol() != Symbol() || OrderMagicNumber() != MagicNumber) continue;
      
      // B. ç±»å‹è¿‡æ»¤ (åªè®¡ç®—äº¤æ˜“å•)
      if (OrderType() > OP_SELL) continue;

      // C. æ ¸å¿ƒæ—¶é—´è¿‡æ»¤ï¼šåªç´¯åŠ â€œä»Šå¤©0ç‚¹â€ä»¥åçš„å•å­
      // å…³é”®ç‚¹ï¼šå¦‚æœåˆ°äº†æ–°çš„ä¸€å¤©ï¼Œtoday_start ä¼šè‡ªåŠ¨å˜å¤§ï¼Œ
      // æ˜¨å¤©çš„å•å­å°±ä¼šå› ä¸ºä¸æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œè€Œè¢«è‡ªåŠ¨è¿‡æ»¤æ‰ã€‚
      // temp_daily_profit è‡ªç„¶å°±å½’é›¶äº†ã€‚
      if (OrderCloseTime() < today_start) continue;

      // D. ç´¯åŠ 
      temp_daily_profit += OrderProfit() + OrderCommission() + OrderSwap();
   }

   // =========================================================
   // 3. æ›´æ–°å…¨å±€å˜é‡ä¸è°ƒè¯•
   // =========================================================
   
   // å¦‚æœå‘ç°æ•°æ®å‘ç”Ÿäº†å˜åŒ– (ä¾‹å¦‚è·¨å¤©äº†ï¼Œæ•°å€¼çªç„¶å½’é›¶)ï¼Œæ‰“å°ä¸€æ¡æ—¥å¿—
   if (g_Today_Realized_PL != temp_daily_profit)
   {
      // åªæœ‰åœ¨æ•°å€¼çœŸæ­£æ”¹å˜æ—¶æ‰æ‰“å°ï¼Œé˜²æ­¢åˆ·å±
      // Print("ğŸ“Š [ç›ˆäºåˆ·æ–°] " + TimeToString(current_time) + 
      //       " | æ—§å€¼: " + DoubleToString(g_Today_Realized_PL, 2) + 
      //       " -> æ–°å€¼: " + DoubleToString(temp_daily_profit, 2));
      
      // ç‰¹åˆ«ç›‘æµ‹ï¼šå¦‚æœå˜æˆäº†0ï¼Œè¯´æ˜è·¨å¤©æˆåŠŸ
      if (g_Today_Realized_PL != 0 && temp_daily_profit == 0)
      {
         Print("ğŸ“… [æ–°çš„ä¸€å¤©] è·¨å¤©è‡ªåŠ¨é‡ç½®æˆåŠŸï¼ä»Šæ—¥ç›ˆäºå·²å½’é›¶ã€‚");
      }
   }

   // å¼ºåˆ¶æ›´æ–°å…¨å±€å˜é‡
   g_Today_Realized_PL = temp_daily_profit;
   g_Last_Daily_Check_Time = current_time;
}