//+------------------------------------------------------------------+
//| L2c: æ–æ³¢é‚£å¥‘åè½¬åŒºåŸŸè¿‡æ»¤ (Context Filter)                       |
//| ä¿®æ­£ï¼šæ£€æŸ¥å¤šä¸ªè‡ªå®šä¹‰æ–æ³¢é‚£å¥‘åŒºåŸŸæ˜¯å¦è¢«è§¦ç¢° (High/Low)            |
//+------------------------------------------------------------------+
bool IsReversalInFibZone(int current_shift, int current_type)
{
    // --- å®šä¹‰éœ€è¦æ£€æŸ¥çš„æ–æ³¢é‚£å¥‘åŒºåŸŸ ---
    // æ ¼å¼: {Level1, Level2}ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è‡ªç”±æ·»åŠ /ä¿®æ”¹
    double FiboLevels[][2] = {
        {1.618, 2.000},
        {2.618, 3.000},
        {4.236, 5.000}
        // æ‚¨å¯ä»¥æ·»åŠ æ›´å¤šåŒºåŸŸï¼Œä¾‹å¦‚ {0.618, 0.786}
    };
    int zones_count = ArraySize(FiboLevels);

    // 1. ç¡®å®šæˆ‘ä»¬è¦æ‰¾çš„å‰ä¸€ä¸ªä¿¡å·ç±»å‹
    int search_type = (current_type == OP_SELL) ? OP_BUY : OP_SELL;

    // 2. å‘å†å²å›æº¯æ‰«æ (æ‰¾åˆ°æœ€è¿‘çš„ä¸€ä¸ªåå‘æœ‰æ•ˆä¿¡å·ä½œä¸ºæ–æ³¢é‚£å¥‘çš„é”šç‚¹)
    int max_history_scan = 100;
    int found_prev_shift = -1;

    KBarSignal prev_data; 
    ZeroMemory(prev_data); 
    
    for (int i = current_shift + 1; i < current_shift + max_history_scan; i++)
    {
        KBarSignal temp_data = GetIndicatorBarData(i);
        bool is_target_found = false;

        if (search_type == OP_BUY)
        {
            if (temp_data.BullishReferencePrice != (double)EMPTY_VALUE && temp_data.BullishReferencePrice != 0.0)
                is_target_found = true;
        }
        else
        {
            if (temp_data.BearishReferencePrice != (double)EMPTY_VALUE && temp_data.BearishReferencePrice != 0.0)
                is_target_found = true;
        }

        if (is_target_found)
        {
            found_prev_shift = i;
            prev_data = temp_data;
            break; 
        }
    }
    
    if (found_prev_shift == -1)
    {
        return false;
    }

    // 3. è®¡ç®—å‰ä¸€ä¸ªä¿¡å·çš„é£é™©æ³¢å¹… (Risk)
    double prev_entry = Close[found_prev_shift];
    double prev_sl = 0;
    double risk = 0;
    
    if (search_type == OP_BUY)
    {
        prev_sl = prev_data.BullishStopLossPrice;
        risk = prev_entry - prev_sl; 
    }
    else
    {
        prev_sl = prev_data.BearishStopLossPrice;
        risk = prev_sl - prev_entry; 
    }
    
    if (risk <= 0) return false;

    // 4. å‡†å¤‡å½“å‰ä¿¡å·çš„ä»·æ ¼æ•°æ®å’Œå®¹å·®
    double current_low  = Low[current_shift];
    double current_high = High[current_shift]; 
    double tolerance = risk * 0.1; // 10% çš„é£é™©è·ç¦»ä½œä¸ºå®¹å·®

    // 5. ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šå¾ªç¯æ£€æŸ¥æ‰€æœ‰å®šä¹‰çš„æ–æ³¢é‚£å¥‘åŒºåŸŸ ğŸš¨
    for (int z = 0; z < zones_count; z++)
    {
        double level1 = FiboLevels[z][0];
        double level2 = FiboLevels[z][1];
        
        double zone_low = 0;
        double zone_high = 0;

        // è®¡ç®—è¯¥åŒºåŸŸçš„ç»å¯¹ä»·æ ¼è¾¹ç•Œ
        if (search_type == OP_BUY) // å‰ä¸€ä¸ªæ˜¯æ¶¨åŠ¿ (å‘ä¸Šå»¶ä¼¸)
        {
            zone_low  = prev_entry + (risk * level1);
            zone_high = prev_entry + (risk * level2);
        }
        else // å‰ä¸€ä¸ªæ˜¯è·ŒåŠ¿ (å‘ä¸‹å»¶ä¼¸)
        {
            // ä¸‹è·Œæ—¶ï¼Œæ•°å€¼è¶Šå°è¶Šè¿œ (prev_entry - risk * level)
            zone_low  = prev_entry - (risk * level2);
            zone_high = prev_entry - (risk * level1);
        }
        
        // 6. åº”ç”¨å®¹å·®ï¼Œè®¡ç®—å®é™…æ£€æŸ¥åŒºåŸŸ
        double check_zone_low  = zone_low - tolerance;
        double check_zone_high = zone_high + tolerance;
        
        // 7. è§¦ç¢°æ£€æŸ¥ (Touching Check)ï¼šK çº¿èŒƒå›´æ˜¯å¦ä¸ç›®æ ‡åŒºåŸŸæœ‰é‡å 
        // åªè¦ K-bar Low <= Zone High AND K-bar High >= Zone Lowï¼Œå³ä¸ºè§¦ç¢°ã€‚
        if (current_low <= check_zone_high && current_high >= check_zone_low)
        {
            string type_str = (current_type == OP_SELL) ? "çœ‹è·Œ" : "çœ‹æ¶¨";
            
            Print(" L2c æ–æ³¢è¿‡æ»¤é€šè¿‡ (è§¦ç¢°): å½“å‰", type_str, "ä¿¡å· @ K[", current_shift, "] è§¦ç¢°å‰å€¼ Fib [",
                  DoubleToString(level1, 3), "-", DoubleToString(level2, 3), 
                  "] åŒºåŸŸ (", DoubleToString(zone_low, _Digits), "-", DoubleToString(zone_high, _Digits), ")");
            
            return true; // åªè¦å‘½ä¸­ä»»æ„ä¸€ä¸ªåŒºåŸŸï¼Œå³è§†ä¸ºé€šè¿‡è¿‡æ»¤
        }
    }
    
    // å¾ªç¯ç»“æŸåï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­ä»»ä½•åŒºåŸŸ
    return false;
}