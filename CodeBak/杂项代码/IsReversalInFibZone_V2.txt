// ä¿®æ”¹æˆåŒºåŸŸè§¦ç¢° é™ä½ä¸¥æ ¼ç¨‹åº¦
bool IsReversalInFibZone_V2(int current_shift, int current_type)
{
   // 1. ç¡®å®šæˆ‘ä»¬è¦æ‰¾çš„å‰ä¸€ä¸ªä¿¡å·ç±»å‹
   // å¦‚æœå½“å‰æ˜¯ SELLï¼Œæˆ‘ä»¬è¦æ‰¾ä¹‹å‰çš„ BUYï¼›åä¹‹äº¦ç„¶ã€‚
   int search_type = (current_type == OP_SELL) ? OP_BUY : OP_SELL;

   // 2. å‘å†å²å›æº¯æ‰«æ (ä»å½“å‰ä¿¡å·çš„å‰ä¸€æ ¹ K çº¿å¼€å§‹)
   // æˆ‘ä»¬é™åˆ¶å›æº¯èŒƒå›´ï¼Œæ¯”å¦‚æœ€å¤šå¾€å‰æ‰¾ 100 æ ¹ï¼Œå¤ªè¿œå°±æ²¡æœ‰å› æœå…³ç³»äº†
   int max_history_scan = 100;
   int found_prev_shift = -1;

   KBarSignal prev_data; // ç”¨äºå­˜å‚¨æ‰¾åˆ°çš„å†å²ä¿¡å·æ•°æ®
   // ğŸš¨ ä¿®æ­£ï¼šåˆå§‹åŒ– prev_data ä»¥è§£å†³ uninitialized variable é”™è¯¯ ğŸš¨
   ZeroMemory(prev_data);

   for (int i = current_shift + 1; i < current_shift + max_history_scan; i++)
   {
      KBarSignal temp_data = GetIndicatorBarData(i);

      // æ£€æŸ¥æ˜¯å¦æœ‰ç”±äº search_type æŒ‡å®šçš„ä¿¡å·
      bool is_target_found = false;

      if (search_type == OP_BUY)
      {
         // æ‰¾çœ‹æ¶¨ä¿¡å· (æœ‰è´¨é‡ä»£ç ï¼Œä¸”æœ‰æœ‰æ•ˆçš„ SL)
         // if (temp_data.BullishReferencePrice > 0 && temp_data.BullishStopLossPrice > 0)
         if (temp_data.BullishReferencePrice != (double)EMPTY_VALUE && temp_data.BullishReferencePrice != 0.0)
            is_target_found = true;
      }
      else
      {
         // æ‰¾çœ‹è·Œä¿¡å·
         // if (temp_data.BearishReferencePrice > 0 && temp_data.BearishStopLossPrice > 0)
         if (temp_data.BearishReferencePrice != (double)EMPTY_VALUE && temp_data.BearishReferencePrice != 0.0)
            is_target_found = true;
      }

      if (is_target_found)
      {
         found_prev_shift = i;
         prev_data = temp_data;
         Print("---->[KTarget_FinderBot.mq4:1098]: shift= ", i, "--", prev_data.BullishStopLossPrice, "--", prev_data.BearishStopLossPrice, "--", prev_data.BullishReferencePrice, "--", prev_data.BearishReferencePrice);
         break; // æ‰¾åˆ°äº†æœ€è¿‘çš„ä¸€ä¸ªåå‘ä¿¡å·ï¼Œåœæ­¢æ‰«æ
      }
   }
   
   // å¦‚æœæ²¡æ‰¾åˆ°å‰ä¸€ä¸ªåå‘ä¿¡å·ï¼Œæ— æ³•åˆ¤æ–­ä¸Šä¸‹æ–‡ï¼Œè§†ç­–ç•¥è€Œå®š (è¿™é‡Œé»˜è®¤è¿”å› false è¿‡æ»¤æ‰ï¼Œæˆ–è€… true æ”¾è¡Œ)
   if (found_prev_shift == -1)
   {
       // Print("æœªæ‰¾åˆ°å‰ç½®åå‘ä¿¡å·ï¼Œæ— æ³•è®¡ç®—æ–æ³¢é‚£å¥‘åŒºåŸŸã€‚");
       return false; // ä¸¥æ ¼æ¨¡å¼ï¼šæ²¡å‚è€ƒå°±ä¸åš
   }

   // 3. è®¡ç®—å‰ä¸€ä¸ªä¿¡å·çš„é£é™©æ³¢å¹… (Risk)
   double prev_entry = Close[found_prev_shift]; // å‡è®¾ä¿¡å· K æ”¶ç›˜ä»·ä¸ºå…¥åœº
   double prev_sl = 0;
   double risk = 0;

   if (search_type == OP_BUY)
   {
      prev_sl = prev_data.BullishStopLossPrice;
      risk = prev_entry - prev_sl; // çœ‹æ¶¨ï¼šå…¥åœº - æ­¢æŸ
   }
   else
   {
      prev_sl = prev_data.BearishStopLossPrice;
      risk = prev_sl - prev_entry; // çœ‹è·Œï¼šæ­¢æŸ - å…¥åœº
   }
   // ç¡®ä¿é£é™©å€¼æœ‰æ•ˆ
   if (risk <= 0) return false;

   // 4. è®¡ç®— 2.618 - 3.00 åŒºåŸŸ
   // æ³¨æ„ï¼šæ‰©å±•æ˜¯æ²¿ç€å‰ä¸€ä¸ªè¶‹åŠ¿æ–¹å‘å»¶ä¼¸çš„
   double zone_low = 0;
   double zone_high = 0;

   if (search_type == OP_BUY)
   {
      // å‰ä¸€ä¸ªæ˜¯æ¶¨åŠ¿ï¼Œç›®æ ‡ä½åœ¨ä¸Šæ–¹
      zone_low  = prev_entry + (risk * 2.618);
      Print("--->[KTarget_FinderBot.mq4:1127]: zone_low: ", zone_low);
      zone_high = prev_entry + (risk * 3.000);
      Print("--->[KTarget_FinderBot.mq4:1129]: zone_high: ", zone_high);
   }
   else
   {
      // å‰ä¸€ä¸ªæ˜¯è·ŒåŠ¿ï¼Œç›®æ ‡ä½åœ¨ä¸‹æ–¹
      // ä¸‹è·Œæ—¶ï¼Œæ•°å€¼è¶Šå°è¶Šè¿œï¼Œæ‰€ä»¥ 3.0 æ˜¯ zone_low (æ•°å€¼å°)ï¼Œ2.618 æ˜¯ zone_high
      zone_low  = prev_entry - (risk * 3.000); 
      zone_high = prev_entry - (risk * 2.618);
   }
   
   /*
   // 1.0 çš„æ£€æŸ¥éå¸¸çš„ä¸¥æ ¼
   // 5. æ£€æŸ¥å½“å‰ä¿¡å·ä»·æ ¼æ˜¯å¦åœ¨åŒºåŸŸå†…
   double current_price = Close[current_shift]; // å½“å‰ä¿¡å· K çº¿çš„æ”¶ç›˜ä»·

   // æ·»åŠ ä¸€ç‚¹å®¹å·® (ä¾‹å¦‚ 10% çš„ Risk è·ç¦»)ï¼Œè¿™å°±æ˜¯æ‚¨è¯´çš„â€œé™„è¿‘â€
   double tolerance = risk * 0.1;

   bool in_zone = false;
   if (current_price >= (zone_low - tolerance) && current_price <= (zone_high + tolerance))
   {
      in_zone = true;
   }

   if (in_zone)
   {
       string type_str = (current_type == OP_SELL) ? "çœ‹è·Œ" : "çœ‹æ¶¨";
       Print(" L2c æ–æ³¢è¿‡æ»¤é€šè¿‡: å½“å‰", type_str, "ä¿¡å· @ ", current_price, 
             " ä½äºå‰å€¼ Fib [2.618-3.0] åŒºåŸŸ (", DoubleToString(zone_low, _Digits), "-", DoubleToString(zone_high, _Digits), ")");
       return true;
   }
   else
   {
       // Print("L2c æ–æ³¢è¿‡æ»¤: å½“å‰ä¿¡å·ä¸åœ¨å‰å€¼ Fib è¡°ç«­åŒºã€‚");
       return false;
   }
   */

   // =========================================================================
   // ğŸš¨ 5. æ ¸å¿ƒä¿®æ­£ï¼šæ£€æŸ¥å½“å‰ä¿¡å· K çº¿æ˜¯å¦è§¦ç¢°äº†åŒºåŸŸ (High/Low) ğŸš¨
   // =========================================================================
   double current_low = Low[current_shift];
   double current_high = High[current_shift];
   // æ·»åŠ å®¹å·® (ä¾‹å¦‚ 10% çš„ Risk è·ç¦»)ï¼Œå³æ‚¨è¯´çš„â€œé™„è¿‘â€
   double tolerance = risk * 0.1;

   // è®¡ç®—å¸¦å®¹å·®çš„æ£€æŸ¥åŒºåŸŸ
   double check_zone_low  = zone_low - tolerance;
   double check_zone_high = zone_high + tolerance;
   
   bool is_touching = false;
   
   // K çº¿èŒƒå›´ [current_low, current_high] æ˜¯å¦ä¸ç›®æ ‡åŒºåŸŸ [check_zone_low, check_zone_high] æœ‰é‡å 
   // åªè¦ K çº¿çš„æœ€ä½ç‚¹ä½äºåŒºåŸŸçš„æœ€é«˜ç‚¹ AND K çº¿çš„æœ€é«˜ç‚¹é«˜äºåŒºåŸŸçš„æœ€ä½ç‚¹ï¼Œå³è§†ä¸ºè§¦ç¢°ã€‚
   if (current_low <= check_zone_high && current_high >= check_zone_low)
   {
      is_touching = true;
   }
   
   if (is_touching)
   {
       string type_str = (current_type == OP_SELL) ? "çœ‹è·Œ" : "çœ‹æ¶¨";
       
       Print(" L2c æ–æ³¢è¿‡æ»¤é€šè¿‡ (è§¦ç¢°): å½“å‰", type_str, "ä¿¡å· @ K[", current_shift, "] è§¦ç¢°å‰å€¼ Fib [2.618-3.0] åŒºåŸŸ (", 
             DoubleToString(zone_low, _Digits), "-", DoubleToString(zone_high, _Digits), ")");
       return true;
   }
   else
   {
       // Print("L2c æ–æ³¢è¿‡æ»¤: å½“å‰ä¿¡å·æœªè§¦ç¢°å‰å€¼ Fib è¡°ç«­åŒºã€‚");
       return false;
   }
}
