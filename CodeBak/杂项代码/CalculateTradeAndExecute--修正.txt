//+------------------------------------------------------------------+
//| å‡½æ•°: è®¡ç®— SL/TP å¹¶æ‰§è¡Œäº¤æ˜“ (L3)
//| èŒè´£: æœ€ç»ˆçš„è®¡ç®—å’Œ OrderSend è°ƒç”¨
//+------------------------------------------------------------------+
void CalculateTradeAndExecute(const KBarSignal &data, int type)
{
    double sl_price = 0;
    double entry_price = Open[0]; [cite_start]// å®é™…å…¥åœºä»· (ç”¨äº OrderSend) [cite: 2]
    double tp_price = 0;
    double reference_price = 0; [cite_start]// æ–æ³¢é‚£å¥‘è®¡ç®—çš„åŸºå‡†ä»· (Close[1]) [cite: 3]
    double risk = 0;
    
    // 1. è·å– SL/Reference Price
    if (type == OP_BUY)
    {
        [cite_start]sl_price = data.BullishStopLossPrice; [cite: 4]
    }
    else if (type == OP_SELL)
    {
        [cite_start]sl_price = data.BearishStopLossPrice; [cite: 6]
    }
    
    // ä¿®æ­£ï¼šå°† reference_price ç¡®å®šä¸º Close[1] (ä¿¡å·ç¡®è®¤ä»·)
    [cite_start]reference_price = Close[1]; [cite: 6]
    
    // 2. ğŸš¨ ä¿®æ­£è®¡ç®—é£é™© (ç”¨äº TP è®¡ç®—çš„ç†è®ºé£é™©æ³¢å¹…) ğŸš¨
    // é£é™© = ä¿¡å·ç¡®è®¤ä»· (Close[1]) åˆ° æ­¢æŸä»· (sl_price) çš„ç†è®ºè·ç¦»
    if (type == OP_BUY)
    {
        // ä¿®æ­£ï¼šåšå¤šç†è®ºé£é™© = Close[1] - SLä»·
        [cite_start]// åŸå§‹ä»£ç : risk = entry_price - sl_price; [cite: 7]
        risk = reference_price - sl_price; 
    }
    else if (type == OP_SELL)
    {
        // ä¿®æ­£ï¼šåšç©ºç†è®ºé£é™© = SLä»· - Close[1]
        [cite_start]// åŸå§‹ä»£ç : risk = sl_price - entry_price; [cite: 8]
        risk = sl_price - reference_price;
    }
    
    // 3. è®¡ç®— TP (å›ºå®šä¸º 1.618 æ–æ³¢é‚£å¥‘çº§åˆ«)
    [cite_start]double tp_level = 1.618; [cite: 9]
    
    if (type == OP_BUY)
    {
        // ğŸš¨ ä¿®æ­£ï¼šTP ä» reference_price (Close[1]) å¼€å§‹å»¶ä¼¸
        [cite_start]// åŸå§‹ä»£ç : tp_price = entry_price + (risk * tp_level); [cite: 10]
        tp_price = reference_price + (risk * tp_level); 
    }
    else if (type == OP_SELL)
    {
        // ğŸš¨ ä¿®æ­£ï¼šTP ä» reference_price (Close[1]) å¼€å§‹å»¶ä¼¸
        [cite_start]// åŸå§‹ä»£ç : tp_price = entry_price - (risk * tp_level); [cite: 11]
        tp_price = reference_price - (risk * tp_level);
    }

    // 1. ç”Ÿæˆä¿¡å· ID (ç”¨äºé˜²é‡å¤å’Œè¿½è¸ª)
    [cite_start]string signal_id = GenerateSignalID(data.OpenTime); [cite: 13]

    // 2. è®¢å•æ³¨é‡Šï¼šåµŒå…¥ ç‰ˆæœ¬æ ‡ç­¾ã€ä¿¡å· ID å’Œåˆå§‹è¿½è¸ªçŠ¶æ€
    string comment = EA_Version_Tag + "|" + [cite_start]signal_id; [cite: 16]
    
    // 4. æ‰§è¡Œäº¤æ˜“ (æ­¤å¤„ä½¿ç”¨å›ºå®šæ‰‹æ•°ï¼Œæœªæ¥éœ€è¦åŠ å…¥èµ„é‡‘ç®¡ç†)
    [cite_start]ExecuteTrade(type, FixedLot, sl_price, tp_price, entry_price, comment); [cite: 17]
    
    Print("äº¤æ˜“æ‰§è¡Œ: ", (type == OP_BUY ? "BUY" : "SELL"),
          " | SL:", DoubleToString(sl_price, _Digits),
          " | TP(1.618):", DoubleToString(tp_price, _Digits),
          [cite_start]" | è´¨é‡:", IntegerToString((int)((type == OP_BUY) ? data.BullishReferencePrice : data.BearishReferencePrice))); [cite: 18]
}