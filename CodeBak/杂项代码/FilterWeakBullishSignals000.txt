//+------------------------------------------------------------------+
//| ä¿¡å·å¼±åŠ¿è¿‡æ»¤ï¼šæ£€æŸ¥çœ‹æ¶¨ä¿¡å·çš„æ”¶ç›˜ä»·æ˜¯å¦ä½äºå‰ä¸€ä¸ªä¿¡å·çš„æ­¢æŸä»· |
//| ï¼ˆç ´åä½ç‚¹æŠ¬å‡ç»“æ„åˆ™è§†ä¸ºæ— æ•ˆï¼‰                                 |
//+------------------------------------------------------------------+
// @param all_bullish_signals[]: æ‰€æœ‰çœ‹æ¶¨ä¿¡å·åˆ—è¡¨ (ä» K[1] å¾€å·¦æ’åˆ—)
// @return: è¿‡æ»¤åçš„çœ‹æ¶¨ä¿¡å·åˆ—è¡¨
// 
FilteredSignal[] FilterWeakBullishSignals(FilteredSignal &all_bullish_signals[])
{
    // å¦‚æœä¿¡å·å°‘äº 2 ä¸ªï¼Œæ— éœ€è¿‡æ»¤
    if (ArraySize(all_bullish_signals) < 2)
    {
        return all_bullish_signals;
    }
    
    // æœ€ç»ˆé€šè¿‡è¿‡æ»¤çš„ä¿¡å·åˆ—è¡¨
    FilteredSignal filtered_list[];
    ArrayResize(filtered_list, 0);

    // å…³é”®ï¼šç”±äºä¿¡å·åˆ—è¡¨æ˜¯ä» K[1] å¾€å·¦ï¼ˆæ–°åˆ°æ—§ï¼‰æ’åºçš„ï¼Œæˆ‘ä»¬éœ€è¦ä»æœ€æ—§çš„ä¿¡å·å¼€å§‹æ¯”è¾ƒã€‚
    // å³ï¼šä»æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´  (æœ€æ—§çš„ä¿¡å·) å¼€å§‹å‘å‰éå†ã€‚
    int last_index = ArraySize(all_bullish_signals) - 1;
    
    // å‡è®¾æœ€æ—§çš„ä¿¡å·ï¼ˆä¿¡å·Aï¼‰æ€»æ˜¯æœ‰æ•ˆçš„ï¼Œå°†å…¶åŠ å…¥åˆ—è¡¨
    ArrayResize(filtered_list, ArraySize(filtered_list) + 1);
    filtered_list[0] = all_bullish_signals[last_index]; 
    
    // é€†åºéå†ï¼Œä»å€’æ•°ç¬¬äºŒä¸ªä¿¡å·å¼€å§‹ï¼Œå‘å‰æ¯”è¾ƒ (ä¿¡å· B)
    for (int i = last_index - 1; i >= 0; i--)
    {
        FilteredSignal current_signal = all_bullish_signals[i];   // ä¿¡å· A (æ›´é è¿‘ K[1])
        FilteredSignal previous_valid = filtered_list[ArraySize(filtered_list) - 1]; // ä¸Šä¸€ä¸ªæœ‰æ•ˆä¿¡å· (ä¿¡å· B - æ›´é è¿‘ K[500])
        
        // -------------------------------------------------------------
        // ğŸš¨ è¿‡æ»¤è§„åˆ™ (çœ‹æ¶¨ä¿¡å·) ğŸš¨
        // ä¿¡å· A çš„æ­¢æŸä»· (current_signal.stop_loss) å¿…é¡»é«˜äº 
        // ä¿¡å· B çš„æ­¢æŸä»· (previous_valid.stop_loss)ã€‚
        // 
        // ä½ çš„åŸå§‹éœ€æ±‚æ˜¯ï¼šä¿¡å· A çš„ Close < ä¿¡å· B çš„ SL 
        // æˆ‘ä»¬é‡‡å–æ›´ä¸¥è°¨çš„è§„åˆ™ï¼šä¿¡å· A çš„ SL (æœ€ä½æ­¢æŸä»·) å¿…é¡»é«˜äº ä¿¡å· B çš„ SLã€‚
        // ï¼ˆå³åä¸€ä¸ªä¿¡å·çš„æ­¢æŸç‚¹å¿…é¡»æŠ¬å‡ï¼Œå¦åˆ™ç»“æ„ç ´åï¼‰
        // -------------------------------------------------------------
        
        // **çœ‹æ¶¨ä¿¡å·å¼±åŠ¿åˆ¤æ–­ï¼š**
        // å¦‚æœå½“å‰ä¿¡å·çš„æ­¢æŸä»· (SL) å°äºæˆ–ç­‰äºå‰ä¸€ä¸ªæœ‰æ•ˆä¿¡å·çš„æ­¢æŸä»· (SL)ï¼Œ
        // åˆ™è¡¨æ˜ä»·æ ¼ä½ç‚¹è¢«ç ´åæˆ–æœªæŠ¬å‡ï¼Œè§†ä¸ºæ— æ•ˆä¿¡å·ã€‚
        if (current_signal.stop_loss <= previous_valid.stop_loss)
        {
            // Print("âŒ å¼±åŠ¿è¿‡æ»¤ï¼šä¿¡å· @ ", TimeToString(current_signal.signal_time), " (SL:", current_signal.stop_loss, ") æœªèƒ½æŠ¬å‡ä½ç‚¹ï¼Œä½äºæˆ–ç­‰äºå‰ä¸€ä¸ªæœ‰æ•ˆä¿¡å· (SL:", previous_valid.stop_loss, ")ã€‚è¿‡æ»¤æ‰ã€‚");
            continue; // è¿‡æ»¤æ‰ä¿¡å· A
        }

        // -------------------------------------------------------------
        // ä¿¡å· A é€šè¿‡è¿‡æ»¤ï¼šå°†å…¶åŠ å…¥æœ‰æ•ˆåˆ—è¡¨ï¼Œæˆä¸ºä¸‹ä¸€ä¸ªæ¯”è¾ƒçš„â€œä¸Šä¸€ä¸ªæœ‰æ•ˆä¿¡å·â€
        // -------------------------------------------------------------
        ArrayResize(filtered_list, ArraySize(filtered_list) + 1);
        filtered_list[ArraySize(filtered_list) - 1] = current_signal;
    }
    
    // æœ€ç»ˆåˆ—è¡¨æ˜¯æ ¹æ®æ—¶é—´ä»æ—§åˆ°æ–°æ’åˆ—çš„ï¼Œå¦‚æœéœ€è¦ä»æ–°åˆ°æ—§æ’åˆ—ï¼Œéœ€è¦ ArrayReverse
    // ä¸ºäº†å’Œ OnTick ä¸»å¾ªç¯çš„ K[1] æ‰«æé¡ºåºä¸€è‡´ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šé€†è½¬å®ƒ
    ArrayReverse(filtered_list); // é€†è½¬åï¼ŒK[1] çš„ä¿¡å·æ’åœ¨æœ€å‰
    
    return filtered_list;
}