//+------------------------------------------------------------------+
//| OnTick: æ ¸å¿ƒé€»è¾‘å¾ªç¯ (æ¯æ¬¡æŠ¥ä»·è·³åŠ¨è§¦å‘)
//+------------------------------------------------------------------+
void OnTick()
{
    // --- 1. æ–° K çº¿æ£€æµ‹æœºåˆ¶ (New Bar Check) ---
    if(Time[0] == g_last_bar_time) return; 
    g_last_bar_time = Time[0]; 

    // --- 2. ğŸš¨ äº¤æ˜“ç®¡ç†æ”¿ç­–ï¼šé˜²æ­¢é‡å¤å¼€ä»“ ğŸš¨
    if (CountOpenTrades(MagicNumber) >= 1) 
    {
        return; 
    }
    
    // --- 3. æ‰¹é‡è·å–ä¿¡å·æ•°æ® (é›†ä¸­ iCustom è°ƒç”¨) ---
    // ğŸš¨ åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ï¼Œè·å– shift=1 (å·²æ”¶ç›˜ K çº¿) çš„æ‰€æœ‰æ•°æ® ğŸš¨
    KBarSignal last_bar_data = GetIndicatorBarData(1); 

    // --- 4. æ‰§è¡Œäº¤æ˜“é€»è¾‘ ---
    
    // 4.1 å¤„ç†ä¹°å…¥ä¿¡å· (ä½¿ç”¨ ReferencePrice åˆ¤æ–­ä¿¡å·å­˜åœ¨)
    if(last_bar_data.BullishReferencePrice != EMPTY_VALUE && last_bar_data.BullishReferencePrice != 0)
    {
        Print(">>> ä¾¦æµ‹åˆ°çœ‹æ¶¨ä¿¡å· @ ", Time[1], "ã€‚SL Price: ", last_bar_data.BullishStopLossPrice);
        
        // A. æ­¢æŸä»·ç›´æ¥è¯»å– Buffer 0 (ç»å¯¹ SL ä»·)
        double sl_price = last_bar_data.BullishStopLossPrice; 
        
        // B. å…¥åœºä»·ï¼šæ–° K çº¿çš„å¼€ç›˜ä»· (Close[1] == Open[0])
        double entry_price = Open[0]; 
        
        // C. è®¡ç®—æ­¢ç›ˆ
        double risk = entry_price - sl_price;
        double tp_price = entry_price + (risk * RewardRatio);

        // D. æ‰§è¡Œå¼€ä»“
        ExecuteTrade(OP_BUY, FixedLot, sl_price, tp_price, entry_price, "K-Target Buy"); 
    }

    // 4.2 å¤„ç†å–å‡ºä¿¡å· (ä½¿ç”¨ ReferencePrice åˆ¤æ–­ä¿¡å·å­˜åœ¨)
    if(last_bar_data.BearishReferencePrice != EMPTY_VALUE && last_bar_data.BearishReferencePrice != 0)
    {
        Print(">>> ä¾¦æµ‹åˆ°çœ‹è·Œä¿¡å· @ ", Time[1], "ã€‚SL Price: ", last_bar_data.BearishStopLossPrice);
        
        // A. æ­¢æŸä»·ç›´æ¥è¯»å– Buffer 1 (ç»å¯¹ SL ä»·)
        double sl_price = last_bar_data.BearishStopLossPrice;
        
        // B. å…¥åœºä»·ï¼šæ–° K çº¿çš„å¼€ç›˜ä»· (Close[1] == Open[0])
        double entry_price = Open[0];
        
        // C. è®¡ç®—æ­¢ç›ˆ
        double risk = sl_price - entry_price;
        double tp_price = entry_price - (risk * RewardRatio);

        // D. æ‰§è¡Œå¼€ä»“
        ExecuteTrade(OP_SELL, FixedLot, sl_price, tp_price, entry_price, "K-Target Sell");
    }
}