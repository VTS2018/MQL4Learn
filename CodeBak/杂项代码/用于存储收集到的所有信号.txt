// KTarget_FinderBot.mq4 (åœ¨ OnTick æˆ–ä¸»å¾ªç¯ä¸­)

// å…¨å±€å˜é‡ï¼šç”¨äºå­˜å‚¨æ”¶é›†åˆ°çš„æ‰€æœ‰ä¿¡å·
FilteredSignal collected_bullish_signals[]; 

// --- ä¿¡å·æ”¶é›†é˜¶æ®µ ---
// 1. æ¸…ç©ºæ•°ç»„ï¼Œå‡†å¤‡é‡æ–°æ”¶é›†
ArrayResize(collected_bullish_signals, 0); 

// 2. å¼€å§‹æ‰«æï¼šä» K[1] å¾€å†å²å·¦ä¾§æ‰«æ Indi_LastScan_Range æ ¹ Kçº¿
for (int shift = 1; shift <= Indi_LastScan_Range; shift++)
{
    // A. æ‰¹é‡è¯»å–æ‰€æœ‰ç¼“å†²åŒºæ•°æ® (åŒ…æ‹¬è´¨é‡ä»£ç å’Œ SL ä»·æ ¼)
    KBarSignal data = GetIndicatorBarData(shift);
    
    // B. æ£€æŸ¥çœ‹æ¶¨ä¿¡å·æ˜¯å¦å­˜åœ¨ä¸”æ»¡è¶³æœ€ä½è´¨é‡è¦æ±‚ (L2a)
    // å‡è®¾ Min_Signal_Quality ä¸ºæœ€ä½è´¨é‡é˜ˆå€¼
    if (data.BullishReferencePrice != (double)EMPTY_VALUE && 
        (int)data.BullishReferencePrice >= Min_Signal_Quality)
    {
        // C. æ£€æŸ¥ SL ä»·æ ¼æ˜¯å¦æœ‰æ•ˆ (Buffer 0)
        if (data.BullishStopLossPrice != (double)EMPTY_VALUE && data.BullishStopLossPrice != 0.0)
        {
            // ğŸš¨ ä¿¡å·åˆæ ¼ï¼Œå°†å…¶æ·»åŠ åˆ°æ”¶é›†æ•°ç»„ä¸­ ğŸš¨
            
            // è·å–å½“å‰æ•°ç»„å¤§å° (æ–°å…ƒç´ ç´¢å¼•)
            int current_size = ArraySize(collected_bullish_signals); 
            // è°ƒæ•´æ•°ç»„å¤§å°
            ArrayResize(collected_bullish_signals, current_size + 1); 

            // å¡«å……ç»“æ„ä½“æ•°æ®
            collected_bullish_signals[current_size].shift = shift;
            collected_bullish_signals[current_size].signal_time = data.OpenTime;
            collected_bullish_signals[current_size].confirmation_close = Close[shift]; // K[shift]çš„æ”¶ç›˜ä»·
            collected_bullish_signals[current_size].stop_loss = data.BullishStopLossPrice; // ç»å¯¹æ­¢æŸä»·
            collected_bullish_signals[current_size].type = OP_BUY;

            // Print("æ”¶é›†åˆ°çœ‹æ¶¨ä¿¡å· @ K[", shift, "] | SL:", data.BullishStopLossPrice);
        }
    }
    
    // âš ï¸ æ³¨æ„ï¼šæ­¤å¤„åº”å»é™¤æ‰€æœ‰ break æˆ– return è¯­å¥ï¼Œç¡®ä¿å¾ªç¯æ‰«æåˆ°åº•
}

// 3. æ”¶é›†å®Œæˆã€‚ç°åœ¨ collected_bullish_signals æ•°ç»„ä¸­åŒ…å«äº†æ‰€æœ‰åˆæ ¼çš„çœ‹æ¶¨ä¿¡å·ã€‚
// æ•°ç»„çš„ç´¢å¼• 0 å­˜å‚¨äº† shift æœ€å°ï¼ˆæœ€æ–°çš„ï¼‰ä¿¡å·ã€‚
// æ•°ç»„çš„æœ€åä¸€ä¸ªç´¢å¼•å­˜å‚¨äº† shift æœ€å¤§ï¼ˆæœ€æ—§çš„ï¼‰ä¿¡å·ã€‚

// --- ä¿¡å·è¿‡æ»¤å’Œæ‰§è¡Œé˜¶æ®µ ---
// æ¥ä¸‹æ¥ï¼Œæ‚¨å°±å¯ä»¥è°ƒç”¨ FilterWeakBullishSignals å‡½æ•°æ¥è¿‡æ»¤ collected_bullish_signals
// ...
// FilteredSignal final_bullish_signals[] = FilterWeakBullishSignals(collected_bullish_signals);
// ...