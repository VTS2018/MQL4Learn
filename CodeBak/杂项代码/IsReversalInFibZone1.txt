//+------------------------------------------------------------------+
//| L2c: æ–æ³¢é‚£å¥‘åè½¬åŒºåŸŸè¿‡æ»¤ (Context Filter)                       |
//| ä¿®æ­£ï¼š1. ä½¿ç”¨ ArrayRange 2. æ–æ³¢é‚£å¥‘æ‰©å±•åŸºå‡†ç‚¹æ”¹ä¸º prev_sl      |
//+------------------------------------------------------------------+
bool IsReversalInFibZone(int current_shift, int current_type)
{
    // ----------------------------------------------------
    // ğŸš¨ ä¿®æ­£ï¼šä½¿ç”¨ ArrayRange(æ•°ç»„å, 0) è·å–è¡Œæ•° ğŸš¨
    // ----------------------------------------------------
    // å‡è®¾ FiboExhaustionLevels å·²åœ¨å…¨å±€èŒƒå›´å®šä¹‰
    int zones_count = ArrayRange(FiboExhaustionLevels, 0); 
    
    // è°ƒè¯•æ‰“å°ï¼šæ­¤æ—¶ zones_count åº”è¯¥æ­£ç¡®æ˜¾ç¤ºè¡Œæ•° (ä¾‹å¦‚ 4)
    // Print("â€¢>[KTarget_FinderBot.mq4:1273]: zones_count: ", zones_count); 

    if (zones_count == 0) return false; 
    
    // 1. ç¡®å®šæˆ‘ä»¬è¦æ‰¾çš„å‰ä¸€ä¸ªä¿¡å·ç±»å‹
    int search_type = (current_type == OP_SELL) ? OP_BUY : OP_SELL;

    // ... (æŸ¥æ‰¾ prev_data çš„é€»è¾‘ï¼Œä»£ç çœç•¥) ...
    int max_history_scan = 100;
    int found_prev_shift = -1;
    KBarSignal prev_data; 
    ZeroMemory(prev_data); 
    
    for (int i = current_shift + 1; i < current_shift + max_history_scan; i++)
    {
      KBarSignal temp_data = GetIndicatorBarData(i);
      bool is_target_found = false;

      if (search_type == OP_BUY)
      {
         if (temp_data.BullishReferencePrice != (double)EMPTY_VALUE && temp_data.BullishReferencePrice != 0.0)
            is_target_found = true;
      }
      else
      {
         if (temp_data.BearishReferencePrice != (double)EMPTY_VALUE && temp_data.BearishReferencePrice != 0.0)
            is_target_found = true;
      }

      if (is_target_found)
      {
         found_prev_shift = i;
         prev_data = temp_data;
         break;
      }
    }
    
    if (found_prev_shift == -1) return false;

    // 3. è®¡ç®—å‰ä¸€ä¸ªä¿¡å·çš„é£é™©æ³¢å¹… (Risk)
    double prev_entry = Close[found_prev_shift]; // é”šç‚¹å…¥åœºä»·
    double prev_sl = 0; // é”šç‚¹æ­¢æŸä»· (æ–æ³¢é‚£å¥‘è®¡ç®—çš„**åŸºå‡†ä»·**)
    
    if (search_type == OP_BUY)
    {
        prev_sl = prev_data.BullishStopLossPrice;
    }
    else
    {
        prev_sl = prev_data.BearishStopLossPrice;
    }
    
    double risk = (search_type == OP_BUY) ? (prev_entry - prev_sl) : (prev_sl - prev_entry);
    if (risk <= 0) return false;

    // 4. å‡†å¤‡å½“å‰ä¿¡å·çš„ä»·æ ¼æ•°æ®å’Œå®¹å·®
    double current_low  = Low[current_shift];
    double current_high = High[current_shift]; 
    
    double tolerance = risk * 0.1;
    tolerance = NormalizeDouble(tolerance, _Digits);

    // 5. æ ¸å¿ƒé€»è¾‘ï¼šå¾ªç¯æ£€æŸ¥æ‰€æœ‰å®šä¹‰çš„æ–æ³¢é‚£å¥‘åŒºåŸŸ 
    for (int z = 0; z < zones_count; z++)
    {
        double level1 = FiboExhaustionLevels[z][0]; 
        double level2 = FiboExhaustionLevels[z][1];
        
        double zone_low = 0;
        double zone_high = 0;

        // è®¡ç®—è¯¥åŒºåŸŸçš„ç»å¯¹ä»·æ ¼è¾¹ç•Œ (åŸºäº **prev_sl** è¿›è¡Œæ‰©å±•)
        if (search_type == OP_BUY) // å‰ä¸€ä¸ªæ˜¯æ¶¨åŠ¿ (å‘ä¸Šå»¶ä¼¸)
        {
            // ğŸš¨ ä¿®æ­£ï¼šåŸºå‡†ä»·ä» prev_entry æ”¹ä¸º prev_sl ğŸš¨
            zone_low  = prev_sl + (risk * level1);
            // Print("---->[KTarget_FinderBot.mq4:1368]: level1: ", level1); // è°ƒè¯•è¯­å¥ï¼Œå»ºè®®åˆ é™¤æˆ–æ³¨é‡Š
            zone_high = prev_sl + (risk * level2);
            // Print("---->[KTarget_FinderBot.mq4:1370]: level2: ", level2); // è°ƒè¯•è¯­å¥ï¼Œå»ºè®®åˆ é™¤æˆ–æ³¨é‡Š
        }
        else // å‰ä¸€ä¸ªæ˜¯è·ŒåŠ¿ (å‘ä¸‹å»¶ä¼¸)
        {
            // ğŸš¨ ä¿®æ­£ï¼šåŸºå‡†ä»·ä» prev_entry æ”¹ä¸º prev_sl ğŸš¨
            zone_low  = prev_sl - (risk * level2); // level2 æ›´å¤§ï¼Œä»·æ ¼æ›´ä½ -> zone_low
            zone_high = prev_sl - (risk * level1); // level1 æ›´å°ï¼Œä»·æ ¼æ›´é«˜ -> zone_high
        }
        
        // ç²¾åº¦ä¿®æ­£
        zone_low  = NormalizeDouble(zone_low, _Digits);
        zone_high = NormalizeDouble(zone_high, _Digits);

        // 6. åº”ç”¨å®¹å·®ï¼Œè®¡ç®—å®é™…æ£€æŸ¥åŒºåŸŸ
        double check_zone_low  = NormalizeDouble(zone_low - tolerance, _Digits);
        double check_zone_high = NormalizeDouble(zone_high + tolerance, _Digits);
        
        // 7. è§¦ç¢°æ£€æŸ¥ (Touching Check)
        if (current_low <= check_zone_high && current_high >= check_zone_low)
        {
            string type_str = (current_type == OP_SELL) ? "çœ‹è·Œ" : "çœ‹æ¶¨";
            
            Print(" L2c æ–æ³¢è¿‡æ»¤é€šè¿‡ (è§¦ç¢°): å½“å‰", type_str, "ä¿¡å· @ K[", current_shift, "] è§¦ç¢°å‰å€¼ Fib [",
                  DoubleToString(level1, 3), "-", DoubleToString(level2, 3), 
                  "] åŒºåŸŸ (", DoubleToString(zone_low, _Digits), "-", DoubleToString(zone_high, _Digits), ")");
            
            return true;
        }
    }
    
    return false;
}