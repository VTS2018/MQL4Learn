//+------------------------------------------------------------------+
//| å‡½æ•°: è®¡ç®— SL/TP å¹¶æ‰§è¡Œäº¤æ˜“ (L3)
//| èŒè´£: æœ€ç»ˆçš„è®¡ç®—å’Œ OrderSend è°ƒç”¨
//+------------------------------------------------------------------+
void CalculateTradeAndExecute(const KBarSignal &data, int type)
{
    double sl_price = 0;
    double entry_price = Open[0]; // å§‹ç»ˆåœ¨æ–°Kçº¿å¼€ç›˜æ—¶å…¥åœº
    double tp_price = 0;
    double reference_price = 0; // æ–æ³¢é‚£å¥‘è®¡ç®—çš„åŸºå‡†ä»· (Close[1])
    double risk = 0;
    
    // 1. è·å– SL/Reference Price
    if (type == OP_BUY)
    {
        sl_price = data.BullishStopLossPrice;
        reference_price = data.BullishReferencePrice; // ğŸš¨ æ³¨æ„ï¼šç°åœ¨æ˜¯è´¨é‡ä»£ç ï¼Œéœ€è¦æ”¹ä¸ºè·å– Close[1]
    }
    else if (type == OP_SELL)
    {
        sl_price = data.BearishStopLossPrice;
        reference_price = data.BearishReferencePrice;
    }
    
    // ğŸš¨ ä¿®æ­£ï¼šç”±äº Buffer 2/3 ç°åœ¨æ˜¯è´¨é‡ä»£ç ï¼Œæˆ‘ä»¬ä¸èƒ½å†ç”¨å®ƒä½œä¸º Reference Priceã€‚
    // æˆ‘ä»¬å¿…é¡»å›åˆ°ä¹‹å‰çš„æ–¹æ³•ï¼šç›´æ¥ä½¿ç”¨ Close[1] ä½œä¸ºæ–æ³¢é‚£å¥‘çš„è®¡ç®—åŸºå‡†ä»·ã€‚
    // å¹¸è¿çš„æ˜¯ï¼ŒReference Price åªæ˜¯ Close[1]ï¼ŒEA å¯ä»¥ç›´æ¥è·å–ã€‚
    reference_price = Close[1]; 
    
    // 2. è®¡ç®—é£é™©
    if (type == OP_BUY)
    {
        risk = entry_price - sl_price;
    }
    else if (type == OP_SELL)
    {
        risk = sl_price - entry_price;
    }
    
    // 3. è®¡ç®— TP (å›ºå®šä¸º 1.618 æ–æ³¢é‚£å¥‘çº§åˆ«)
    // æ–æ³¢é‚£å¥‘è½´çº¿æ˜¯ SLä»·æ ¼ åˆ° Close[1] çš„è·ç¦» (å³ risk)
    // å‡è®¾æˆ‘ä»¬ä½¿ç”¨ 1.618 ä½œä¸ºå›ºå®šæ­¢ç›ˆä½ï¼Œä¸ºå®ç°åŠ¨æ€è¿½è¸ªå‡†å¤‡ã€‚
    double tp_level = 1.618; 
    
    if (type == OP_BUY)
    {
        // TP = æ–æ³¢é‚£å¥‘åŸºå‡†ä»· + è·ç¦» * æ–æ³¢é‚£å¥‘çº§åˆ«
        // æ–æ³¢é‚£å¥‘åŸºå‡†ä»·é€šå¸¸æ˜¯ SL å¯¹åº”çš„ K çº¿çš„ Low/Highï¼Œä½†ç®€åŒ–ä¸º Entry Price
        tp_price = entry_price + (risk * tp_level); 
    }
    else if (type == OP_SELL)
    {
        tp_price = entry_price - (risk * tp_level);
    }

    // 1. ç”Ÿæˆä¿¡å· ID (ç”¨äºé˜²é‡å¤å’Œè¿½è¸ª)
    // string signal_id = TimeToString(data.OpenTime, TIME_DATE | TIME_MINUTES);
    string signal_id = GenerateSignalID(data.OpenTime);

    // 2. è®¢å•æ³¨é‡Šï¼šåµŒå…¥ ç‰ˆæœ¬æ ‡ç­¾ã€ä¿¡å· ID å’Œåˆå§‹è¿½è¸ªçŠ¶æ€ (State 0: åˆšå¼€ä»“)
    // string comment = "[" + EA_Version_Tag + "] | ID:" + signal_id + " | State:0 | Risk:" + DoubleToString(Max_Risk_Per_Trade * 100, 2) + "%";
    // string oldcomment = "Q" + IntegerToString((int)data.BullishReferencePrice) + " Trade";
    // string comment = "[" + EA_Version_Tag + "] | ID:" + signal_id + " | State:0 ";

    // 2. è®¢å•æ³¨é‡Šï¼šåµŒå…¥ ç‰ˆæœ¬æ ‡ç­¾ã€ä¿¡å· ID å’Œåˆå§‹è¿½è¸ªçŠ¶æ€
    string comment = EA_Version_Tag + "|" + signal_id;

    // 4. æ‰§è¡Œäº¤æ˜“ (æ­¤å¤„ä½¿ç”¨å›ºå®šæ‰‹æ•°ï¼Œæœªæ¥éœ€è¦åŠ å…¥èµ„é‡‘ç®¡ç†)
    ExecuteTrade(type, FixedLot, sl_price, tp_price, entry_price, comment);

    Print("äº¤æ˜“æ‰§è¡Œ: ", (type == OP_BUY ? "BUY" : "SELL"),
          " | SL:", DoubleToString(sl_price, _Digits),
          " | TP(1.618):", DoubleToString(tp_price, _Digits),
          " | è´¨é‡:", IntegerToString((int)((type == OP_BUY) ? data.BullishReferencePrice : data.BearishReferencePrice)));
}