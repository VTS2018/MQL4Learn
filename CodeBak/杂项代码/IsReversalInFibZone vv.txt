//+------------------------------------------------------------------+
//| L2c: æ–æ³¢é‚£å¥‘åè½¬åŒºåŸŸè¿‡æ»¤ (Context Filter)                       |
//| ä¿®æ­£ï¼šæ£€æŸ¥å¤šä¸ªè‡ªå®šä¹‰æ–æ³¢é‚£å¥‘åŒºåŸŸæ˜¯å¦è¢«è§¦ç¢° (High/Low)            |
//+------------------------------------------------------------------+
bool IsReversalInFibZone(int current_shift, int current_type)
{
    // --- å®šä¹‰éœ€è¦æ£€æŸ¥çš„æ–æ³¢é‚£å¥‘åŒºåŸŸ ---
    // æ ¼å¼: {Level1, Level2}ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è‡ªç”±æ·»åŠ /ä¿®æ”¹
    double FiboLevels[][2] = {
        {1.618, 1.88},
        {2.618, 2.88},
        {4.236, 4.88},
        {6, 7}
        // æ‚¨å¯ä»¥æ·»åŠ æ›´å¤šåŒºåŸŸï¼Œä¾‹å¦‚ {0.618, 0.786}
    };
    int zones_count = ArraySize(FiboLevels);
    Print("â€¢>[KTarget_FinderBot.mq4:1273]: zones_count: ", zones_count);
    return false;

   // 1. ç¡®å®šæˆ‘ä»¬è¦æ‰¾çš„å‰ä¸€ä¸ªä¿¡å·ç±»å‹
   // å¦‚æœå½“å‰æ˜¯ SELLï¼Œæˆ‘ä»¬è¦æ‰¾ä¹‹å‰çš„ BUYï¼›åä¹‹äº¦ç„¶ã€‚
   int search_type = (current_type == OP_SELL) ? OP_BUY : OP_SELL;

   // 2. å‘å†å²å›æº¯æ‰«æ (ä»å½“å‰ä¿¡å·çš„å‰ä¸€æ ¹ K çº¿å¼€å§‹)
   // æˆ‘ä»¬é™åˆ¶å›æº¯èŒƒå›´ï¼Œæ¯”å¦‚æœ€å¤šå¾€å‰æ‰¾ 100 æ ¹ï¼Œå¤ªè¿œå°±æ²¡æœ‰å› æœå…³ç³»äº†
   int max_history_scan = 100;
   int found_prev_shift = -1;

   KBarSignal prev_data; // ç”¨äºå­˜å‚¨æ‰¾åˆ°çš„å†å²ä¿¡å·æ•°æ®
   // ğŸš¨ ä¿®æ­£ï¼šåˆå§‹åŒ– prev_data ä»¥è§£å†³ uninitialized variable é”™è¯¯ ğŸš¨
   ZeroMemory(prev_data);

   for (int i = current_shift + 1; i < current_shift + max_history_scan; i++)
   {
      KBarSignal temp_data = GetIndicatorBarData(i);

      // æ£€æŸ¥æ˜¯å¦æœ‰ç”±äº search_type æŒ‡å®šçš„ä¿¡å·
      bool is_target_found = false;

      if (search_type == OP_BUY)
      {
         // æ‰¾çœ‹æ¶¨ä¿¡å· (æœ‰è´¨é‡ä»£ç ï¼Œä¸”æœ‰æœ‰æ•ˆçš„ SL)
         // if (temp_data.BullishReferencePrice > 0 && temp_data.BullishStopLossPrice > 0)
         if (temp_data.BullishReferencePrice != (double)EMPTY_VALUE && temp_data.BullishReferencePrice != 0.0)
            is_target_found = true;
      }
      else
      {
         // æ‰¾çœ‹è·Œä¿¡å·
         // if (temp_data.BearishReferencePrice > 0 && temp_data.BearishStopLossPrice > 0)
         if (temp_data.BearishReferencePrice != (double)EMPTY_VALUE && temp_data.BearishReferencePrice != 0.0)
            is_target_found = true;
      }

      if (is_target_found)
      {
         found_prev_shift = i;
         prev_data = temp_data;
         Print("---->[KTarget_FinderBot.mq4:1098]: shift= ", i, "--", prev_data.BullishStopLossPrice, "--", prev_data.BearishStopLossPrice, "--", prev_data.BullishReferencePrice, "--", prev_data.BearishReferencePrice);
         break; // æ‰¾åˆ°äº†æœ€è¿‘çš„ä¸€ä¸ªåå‘ä¿¡å·ï¼Œåœæ­¢æ‰«æ
      }
   }
   
   // å¦‚æœæ²¡æ‰¾åˆ°å‰ä¸€ä¸ªåå‘ä¿¡å·ï¼Œæ— æ³•åˆ¤æ–­ä¸Šä¸‹æ–‡ï¼Œè§†ç­–ç•¥è€Œå®š (è¿™é‡Œé»˜è®¤è¿”å› false è¿‡æ»¤æ‰ï¼Œæˆ–è€… true æ”¾è¡Œ)
   if (found_prev_shift == -1)
   {
       // Print("æœªæ‰¾åˆ°å‰ç½®åå‘ä¿¡å·ï¼Œæ— æ³•è®¡ç®—æ–æ³¢é‚£å¥‘åŒºåŸŸã€‚");
       return false; // ä¸¥æ ¼æ¨¡å¼ï¼šæ²¡å‚è€ƒå°±ä¸åš
   }

   // 3. è®¡ç®—å‰ä¸€ä¸ªä¿¡å·çš„é£é™©æ³¢å¹… (Risk)
   double prev_entry = Close[found_prev_shift]; // å‡è®¾ä¿¡å· K æ”¶ç›˜ä»·ä¸ºå…¥åœº
   double prev_sl = 0;
   double risk = 0;

   if (search_type == OP_BUY)
   {
      prev_sl = prev_data.BullishStopLossPrice;
      risk = prev_entry - prev_sl; // çœ‹æ¶¨ï¼šå…¥åœº - æ­¢æŸ
   }
   else
   {
      prev_sl = prev_data.BearishStopLossPrice;
      risk = prev_sl - prev_entry; // çœ‹è·Œï¼šæ­¢æŸ - å…¥åœº
   }
   // ç¡®ä¿é£é™©å€¼æœ‰æ•ˆ
   if (risk <= 0) return false;

   // =========================================================================
   // ğŸš¨ 5. æ ¸å¿ƒä¿®æ­£ï¼šæ£€æŸ¥å½“å‰ä¿¡å· K çº¿æ˜¯å¦è§¦ç¢°äº†åŒºåŸŸ (High/Low) ğŸš¨
   // =========================================================================
   double current_low = Low[current_shift];
   double current_high = High[current_shift];
   // æ·»åŠ å®¹å·® (ä¾‹å¦‚ 10% çš„ Risk è·ç¦»)ï¼Œå³æ‚¨è¯´çš„â€œé™„è¿‘â€
   double tolerance = risk * 0.1;
   tolerance = NormalizeDouble(tolerance, _Digits);
   Print("--->[KTarget_FinderBot.mq4:1174]: tolerance: ", DoubleToString(tolerance, _Digits));

    // 5. ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šå¾ªç¯æ£€æŸ¥æ‰€æœ‰å®šä¹‰çš„æ–æ³¢é‚£å¥‘åŒºåŸŸ ğŸš¨
    for (int z = 0; z < zones_count; z++)
    {
        double level1 = FiboLevels[z][0];
        double level2 = FiboLevels[z][1];
        
        double zone_low = 0;
        double zone_high = 0;

        // è®¡ç®—è¯¥åŒºåŸŸçš„ç»å¯¹ä»·æ ¼è¾¹ç•Œ
        if (search_type == OP_BUY) // å‰ä¸€ä¸ªæ˜¯æ¶¨åŠ¿ (å‘ä¸Šå»¶ä¼¸)
        {
            zone_low  = prev_sl + (risk * level1);
            zone_high = prev_sl + (risk * level2);
        }
        else // å‰ä¸€ä¸ªæ˜¯è·ŒåŠ¿ (å‘ä¸‹å»¶ä¼¸)
        {
            // ä¸‹è·Œæ—¶ï¼Œæ•°å€¼è¶Šå°è¶Šè¿œ (prev_entry - risk * level)
            zone_low  = prev_sl - (risk * level2);
            zone_high = prev_sl - (risk * level1);
        }

        // ==========================================================
        // ğŸš¨ æ ¸å¿ƒä¿®æ­£ï¼šç«‹å³è¿›è¡Œç²¾åº¦ä¿®æ­£ ğŸš¨
        // ç¡®ä¿ zone_low å’Œ zone_high åœ¨åç»­è®¡ç®—å’Œæ‰“å°ä¸­æ˜¯å¹²å‡€çš„
        // ==========================================================
        zone_low = NormalizeDouble(zone_low, _Digits);
        zone_high = NormalizeDouble(zone_high, _Digits);

        // å…³é”®ä¿®æ­£ 2ï¼šä½¿ç”¨ DoubleToString æ ¼å¼åŒ–è¾“å‡º (è§£å†³æ‰“å°é—®é¢˜)
        Print("--->[KTarget_FinderBot.mq4:1383]: zone_low: ", DoubleToString(zone_low, _Digits));
        Print("--->[KTarget_FinderBot.mq4:1384]: zone_high: ", DoubleToString(zone_high, _Digits));

        // 6. åº”ç”¨å®¹å·®ï¼Œè®¡ç®—å®é™…æ£€æŸ¥åŒºåŸŸ
        double check_zone_low  = NormalizeDouble(zone_low - tolerance, _Digits);
        double check_zone_high = NormalizeDouble(zone_high + tolerance, _Digits);
        
        // 7. è§¦ç¢°æ£€æŸ¥ (Touching Check)ï¼šK çº¿èŒƒå›´æ˜¯å¦ä¸ç›®æ ‡åŒºåŸŸæœ‰é‡å 
        // åªè¦ K-bar Low <= Zone High AND K-bar High >= Zone Lowï¼Œå³ä¸ºè§¦ç¢°ã€‚
        if (current_low <= check_zone_high && current_high >= check_zone_low)
        {
            string type_str = (current_type == OP_SELL) ? "çœ‹è·Œ" : "çœ‹æ¶¨";
            
            Print(" L2c æ–æ³¢è¿‡æ»¤é€šè¿‡ (è§¦ç¢°): å½“å‰", type_str, "ä¿¡å· @ K[", current_shift, "] è§¦ç¢°å‰å€¼ Fib [",
                  DoubleToString(level1, 3), "-", DoubleToString(level2, 3), 
                  "] åŒºåŸŸ (", DoubleToString(zone_low, _Digits), "-", DoubleToString(zone_high, _Digits), ")");
            
            return true; // åªè¦å‘½ä¸­ä»»æ„ä¸€ä¸ªåŒºåŸŸï¼Œå³è§†ä¸ºé€šè¿‡è¿‡æ»¤
        }
    }
    // å¾ªç¯ç»“æŸåï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­ä»»ä½•åŒºåŸŸ
    return false;
}
