//+------------------------------------------------------------------+
//| å‡½æ•°: è®¡ç®— SL/TP å¹¶æ‰§è¡Œäº¤æ˜“ (L3)
//| èŒè´£: æœ€ç»ˆçš„è®¡ç®—å’Œ OrderSend è°ƒç”¨
//+------------------------------------------------------------------+
void CalculateTradeAndExecute(const KBarSignal &data, int type)
{
    double sl_price = 0;
    double entry_price = Open[0]; // å®é™…å…¥åœºä»· (ç”¨äº OrderSend)
    double tp_price = 0;
    double reference_price = 0; // æ–æ³¢é‚£å¥‘è®¡ç®—çš„åŸºå‡†ä»· (Close[1])
    double risk = 0;
    
    // 1. è·å– SL/Reference Price
    if (type == OP_BUY)
    {
        sl_price = data.BullishStopLossPrice;
    }
    else if (type == OP_SELL)
    {
        sl_price = data.BearishStopLossPrice;
    }
    
    [cite_start]// ä¿®æ­£ï¼šå°† reference_price ç¡®å®šä¸º Close[1] (ä¿¡å·ç¡®è®¤ä»·) [cite: 6]
    reference_price = Close[1]; 
    
    // 2. ğŸš¨ ä¿®æ­£è®¡ç®—é£é™© (ç”¨äº TP è®¡ç®—çš„ç†è®ºé£é™©æ³¢å¹…) ğŸš¨
    // é£é™© = ä¿¡å·ç¡®è®¤ä»· (Close[1]) åˆ° æ­¢æŸä»· (sl_price) çš„ç†è®ºè·ç¦»
    if (type == OP_BUY)
    {
        // åšå¤šï¼šç†è®ºé£é™© = Close[1] - SLä»·
        risk = reference_price - sl_price;
    }
    else if (type == OP_SELL)
    {
        // åšç©ºï¼šç†è®ºé£é™© = SLä»· - Close[1]
        risk = sl_price - reference_price;
    }
    
    // 3. è®¡ç®— TP (åŸºäº reference_price å’Œç†è®ºé£é™© risk)
    // æ–æ³¢é‚£å¥‘è½´çº¿æ˜¯ SLä»·æ ¼ åˆ° Close[1] çš„è·ç¦» (å³ risk)
    double tp_level = 1.618; 
    
    if (type == OP_BUY)
    {
        // TP = æ–æ³¢é‚£å¥‘åŸºå‡†ä»· (Close[1]) + ç†è®ºé£é™© * æ–æ³¢é‚£å¥‘çº§åˆ«
        tp_price = reference_price + (risk * tp_level); 
    }
    else if (type == OP_SELL)
    {
        // TP = æ–æ³¢é‚£å¥‘åŸºå‡†ä»· (Close[1]) - ç†è®ºé£é™© * æ–æ³¢é‚£å¥‘çº§åˆ«
        tp_price = reference_price - (risk * tp_level);
    }

    // 1. ç”Ÿæˆä¿¡å· ID (ç”¨äºé˜²é‡å¤å’Œè¿½è¸ª)
    [cite_start]string signal_id = GenerateSignalID(data.OpenTime); [cite: 13]

    // 2. è®¢å•æ³¨é‡Šï¼šåµŒå…¥ ç‰ˆæœ¬æ ‡ç­¾ã€ä¿¡å· ID å’Œåˆå§‹è¿½è¸ªçŠ¶æ€
    string comment = EA_Version_Tag + "|" + [cite_start]signal_id; [cite: 16]
    
    // 4. æ‰§è¡Œäº¤æ˜“ (æ­¤å¤„ä½¿ç”¨å›ºå®šæ‰‹æ•°ï¼Œæœªæ¥éœ€è¦åŠ å…¥èµ„é‡‘ç®¡ç†)
    // æ³¨æ„ï¼šOrderSend å¿…é¡»ä½¿ç”¨å®é™…å…¥åœºä»· entry_price å’Œ sl_price/tp_price
    [cite_start]ExecuteTrade(type, FixedLot, sl_price, tp_price, entry_price, comment); [cite: 17]
    
    Print("äº¤æ˜“æ‰§è¡Œ: ", (type == OP_BUY ? "BUY" : "SELL"),
          " | SL:", DoubleToString(sl_price, _Digits),
          " | TP(1.618):", DoubleToString(tp_price, _Digits),
          " | ç†è®ºé£é™©:", DoubleToString(risk, _Digits), // æ‰“å°ç†è®ºé£é™©æ–¹ä¾¿è°ƒè¯•
          [cite_start]" | è´¨é‡:", IntegerToString((int)((type == OP_BUY) ? data.BullishReferencePrice : data.BearishReferencePrice))); [cite: 18]
}