// KTarget_Test_Bot.mq4

// --- æ–°å¢è¾“å…¥å‚æ•°ï¼šæ‰«æèŒƒå›´ ---
input int    Indi_Scan_Range      = 100; // æ‰«ææœ€è¿‘å¤šå°‘æ ¹ K çº¿

// --- æ ¸å¿ƒç»“æ„ä½“å®šä¹‰ (ä» K_Data.mqh å¤åˆ¶è¿‡æ¥) ---
struct KBarSignal
{
    // ... (åŒ…å« BullishStopLossPrice, BearishStopLossPrice, BullishReferencePrice, BearishReferencePrice ç­‰)
    // ç¡®ä¿æ‚¨å°† K_Data.mqh ä¸­çš„ KBarSignal ç»“æ„ä½“å®šä¹‰å¤åˆ¶åˆ°æ­¤æµ‹è¯• EA çš„é¡¶éƒ¨
    double BullishStopLossPrice; 
    double BearishStopLossPrice;
    double BullishReferencePrice; 
    double BearishReferencePrice;
    datetime OpenTime; 
};

// --- GetIndicatorBarData å‡½æ•° (å·²åœ¨ä¸Šä¸€ä¸ªå›å¤ä¸­æä¾›ï¼Œæ­¤å¤„ä¸é‡å¤) ---
// ... (ç¡®ä¿ GetIndicatorBarData å·²ç»å®šä¹‰åœ¨æµ‹è¯• EA ä¸­) ...


//+------------------------------------------------------------------+
//| Expert Tick å‡½æ•° (å·²ä¿®æ­£ï¼šå®ç°ä¿¡å·æ‰«æ)                            |
//+------------------------------------------------------------------+
void OnTick()
{
    // --- 1. æ–° K çº¿æ£€æµ‹ (ä»…åœ¨æ–° K çº¿æ”¶ç›˜æ—¶æ‰§è¡Œè¯»å–) ---
    if(Time[0] == g_last_bar_time) return; 
    g_last_bar_time = Time[0]; 

    // --- 2. ğŸš¨ æ‰«æå¾ªç¯ï¼šä» shift=1 å¼€å§‹å‘å†å² K çº¿æ‰«æ ğŸš¨
    for(int shift = 1; shift <= Indi_Scan_Range; shift++)
    {
        // A. æ‰¹é‡è¯»å–æ‰€æœ‰ç¼“å†²åŒºæ•°æ®
        KBarSignal data = GetIndicatorBarData(shift);

        // B. æ£€æŸ¥ä¿¡å·è´¨é‡/å­˜åœ¨æ€§ (ä½¿ç”¨ Buffer 2/3 - ReferencePrice)
        // æ³¨æ„ï¼šç°åœ¨ Buffer 2/3 æ˜¯ä¿¡å·è´¨é‡ä»£ç  (3.0/2.0/1.0)
        
        bool bullish_signal_exists = (data.BullishReferencePrice != (double)EMPTY_VALUE && data.BullishReferencePrice != 0.0);
        bool bearish_signal_exists = (data.BearishReferencePrice != (double)EMPTY_VALUE && data.BearishReferencePrice != 0.0);
        
        if (bullish_signal_exists || bearish_signal_exists)
        {
            // C. æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¿¡å·ï¼Œæ‰“å°ç»“æœå¹¶é€€å‡ºå¾ªç¯/å‡½æ•°
            string log_message = ">>> ä¾¦æµ‹åˆ°ä¿¡å· @ Kçº¿ç´¢å¼• shift=" + IntegerToString(shift) + " (æ—¶é—´: " + TimeToString(data.OpenTime) + ") <<<";
            
            if (bullish_signal_exists)
            {
                // åŒæ—¶éªŒè¯ Buffer 0 æ˜¯å¦ä¹Ÿæœ‰æ•ˆ (ç»å¯¹ SL ä»·æ ¼)
                if (data.BullishStopLossPrice != (double)EMPTY_VALUE && data.BullishStopLossPrice != 0.0)
                {
                    log_message += " | çœ‹æ¶¨ SL (Buffer 0): " + DoubleToString(data.BullishStopLossPrice, _Digits);
                    log_message += " | è´¨é‡ (Buffer 2): " + DoubleToString(data.BullishReferencePrice, 1);
                }
            }

            if (bearish_signal_exists)
            {
                // åŒæ—¶éªŒè¯ Buffer 1 æ˜¯å¦ä¹Ÿæœ‰æ•ˆ (ç»å¯¹ SL ä»·æ ¼)
                if (data.BearishStopLossPrice != (double)EMPTY_VALUE && data.BearishStopLossPrice != 0.0)
                {
                    log_message += " | çœ‹è·Œ SL (Buffer 1): " + DoubleToString(data.BearishStopLossPrice, _Digits);
                    log_message += " | è´¨é‡ (Buffer 3): " + DoubleToString(data.BearishReferencePrice, 1);
                }
            }
            
            Print(log_message);
            
            // æ‰¾åˆ°ä¿¡å·åï¼Œæˆ‘ä»¬åœæ­¢æ‰«æï¼ˆå‡è®¾åªéœ€è¦æœ€æ–°ä¿¡å·ï¼‰
            return; 
        }
    }
    
    // å¦‚æœå¾ªç¯ç»“æŸä»æœªæ‰¾åˆ°ä¿¡å·
    Print("æ–° K çº¿ @ ", TimeToString(Time[1]), "ï¼šåœ¨æ‰«æèŒƒå›´å†… (", Indi_Scan_Range, " æ ¹ K çº¿) æœªå‘ç°ä¿¡å·ã€‚");
}