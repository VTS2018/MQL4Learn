/**
 * ç»˜åˆ¶æ–æ³¢é‚£å¥‘æ‰©å±•åŒºåŸŸçš„é«˜äº®çŸ©å½¢
 * @param target_index: P1 (é”šç‚¹Kçº¿) ç´¢å¼•
 * @param P2_index: P2 Kçº¿ç´¢å¼•
 * @param is_bullish: æ˜¯å¦ä¸ºçœ‹æ¶¨æ–æ³¢é‚£å¥‘
 */
void ExecuteDrawFiboRects(int target_index, int P2_index, bool is_bullish, const FiboZone &zones[])
{
    if (Is_EA_Mode) return;
    // è·å– P1 å’Œ P2 çš„ä»·æ ¼å’Œæ—¶é—´
    double P1_price; // å‡è®¾ P1 ä»·æ ¼æ˜¯é”šç‚¹çš„ Open

    // 1. æ ¹æ®çœ‹æ¶¨/çœ‹è·Œç¡®å®š P1 ä¾§çš„ä»·æ ¼é”šå®šç‚¹
    if (is_bullish)
    {
        // çœ‹æ¶¨: ä»·æ ¼é”šå®š K-Target çš„æœ€ä½ä»· (Low)
        P1_price = Low[target_index];
    }
    else // is_bearish
    {
        // çœ‹è·Œ: ä»·æ ¼é”šå®š K-Target çš„æœ€é«˜ä»· (High)
        P1_price = High[target_index];
    }

    double P2_price = Close[P2_index]; // å‡è®¾ P2 ä»·æ ¼æ˜¯ P2 Kçº¿çš„ Close

    // ç¡®å®šçŸ©å½¢åœ¨æ—¶é—´ä¸Šçš„è·¨åº¦ (ä» P1 é”šç‚¹å¼€å§‹ï¼Œåˆ°å½“å‰æœ€æ–° Kçº¿)
    datetime time1 = Time[target_index];

    // çŸ©å½¢åº”ä¸€ç›´å»¶ä¼¸åˆ°æœ€æ–° Kçº¿
    datetime time2 = Time[0];

    //--------------------------------------------
    // å…ˆè°ƒè¯•ä»·æ ¼
    // Print("-->[K_Drawing_Funcs.mqh:600]: P1_price: ", P1_price);
    // Print("-->[K_Drawing_Funcs.mqh:601]: P2_price: ", P2_price);
    // Print("-->[K_Drawing_Funcs.mqh:602]: time1: ", time1);
    // Print("-->[K_Drawing_Funcs.mqh:603]: time2: ", time2);
    //return; ä»·æ ¼å…¨éƒ¨å¯¹åº”å¾—ä¸Š æµ‹è¯•é€šè¿‡
    //--------------------------------------------

    // ç¡®å®šè¦éå†çš„åŒºåŸŸæ•°ç»„
    //const FiboZone& zones[] = is_bullish ? BULLISH_HIGHLIGHT_ZONES : BEARISH_HIGHLIGHT_ZONES;
    int zones_count = ArraySize(zones);
    
    // ç¡®å®šé¢œè‰²
    color rect_color = GetHighlightColorByPeriod(is_bullish);

    //-----
    // 1. è·å–å‘¨æœŸåç§° (ä¾‹å¦‚ "H4", "D1")
    string tf_name = GetTimeframeName(_Period);

    // 2. ç¡®å®šåŒºåŸŸç±»å‹æè¿°
    string area_type = is_bullish ? "çœ‹æ¶¨æ–æ³¢åè½¬-åšç©º-åŒºåŸŸ" : "çœ‹è·Œæ–æ³¢åè½¬-åšå¤š-åŒºåŸŸ";

    // 3. ç»„åˆæœ€ç»ˆçš„è¯´æ˜æ–‡æœ¬
    // ç¤ºä¾‹: "H4 çœ‹è·Œæ–æ³¢åè½¬åŒºåŸŸ"
    string description_text = tf_name + " " + area_type;
    //-----

    // è·å–å‘¨æœŸå¯è§æ€§æ ‡å¿—
    // int tf_flag = GetTimeframeFlag(_Period);
    // Print("--->[K_Drawing_Funcs.mqh:643]: tf_flag: ", tf_flag);


    // éå†æ‰€æœ‰é«˜äº®åŒºåŸŸå¹¶ç»˜åˆ¶çŸ©å½¢
    for (int i = 0; i < zones_count; i++)
    {
        double level1 = zones[i].level1;
        double level2 = zones[i].level2;
        
        // 1. è®¡ç®—ä»·æ ¼åæ ‡
        double price_start = CalculateFiboPrice(P1_price, P2_price, level1);
        // Print("===>[K_Drawing_Funcs.mqh:622]: price_start: ", price_start," level1: ",level1);

        double price_end   = CalculateFiboPrice(P1_price, P2_price, level2);
        // Print("===>[K_Drawing_Funcs.mqh:624]: price_end: ", price_end," level2: ",level2);

        // çŸ©å½¢çš„é¡¶éƒ¨ä»·æ ¼ (ä½œä¸ºæ–‡æœ¬é”šå®šç‚¹)
        double price_top = price_end;

        // 2. å‘½åå¯¹è±¡ï¼Œä½¿ç”¨ç‰¹æ®Šæ ‡è®° "_FiboHL_" æ»¡è¶³å‘¨æœŸåˆ‡æ¢ä¸åˆ é™¤éœ€æ±‚
        string name = g_object_prefix + "Rect_FiboHL_" + (is_bullish ? "B_" : "S_") + GetBarTimeID(target_index) + "#" + DoubleToString(level1, 3) + "_" + DoubleToString(level2, 3);
        // Print("===>[K_Drawing_Funcs.mqh:624]: name: ", name);

        string text_name = name + "_TXT";

        /*
        // 3. åˆ›å»º/æ›´æ–°çŸ©å½¢
        if (ObjectFind(0, name) != -1)
        {
            ObjectDelete(0, name); // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤ï¼Œå†é‡æ–°ç»˜åˆ¶
        }
        
        if (ObjectCreate(0, name, OBJ_RECTANGLE, 0, time1, price_start, time2, price_end))
        {
            // è®¾ç½®å±æ€§
            ObjectSetInteger(0, name, OBJPROP_COLOR, rect_color);
            ObjectSetInteger(0, name, OBJPROP_STYLE, STYLE_SOLID);
            ObjectSetInteger(0, name, OBJPROP_WIDTH, 1);
            
            // ğŸš¨ è®¾ç½®å¡«å……å’ŒèƒŒæ™¯ (FILL and BACK)
            ObjectSetInteger(0, name, OBJPROP_FILL, true);
            ObjectSetInteger(0, name, OBJPROP_BACK, true); // çŸ©å½¢åœ¨ K çº¿åé¢
            
            // ğŸš¨ è®¾ç½®é€æ˜åº¦ (MQL4/MT4 é¢œè‰²å‡½æ•°)
            ObjectSetInteger(0, name, OBJPROP_COLOR, (int)rect_color | (HIGHLIGHT_ALPHA << 24)); // ARGBæ ¼å¼
            
            // å°†å¯¹è±¡è®¾ç½®ä¸ºä¸å¯é€‰ä¸­
            ObjectSetInteger(0, name, OBJPROP_SELECTABLE, false);
            
            // ** å…³é”®è®¾ç½®ï¼šä»…åœ¨å½“å‰å‘¨æœŸå¯è§ **
            ObjectSetInteger(0, name, OBJPROP_TIMEFRAMES, GetTimeframeFlag(_Period)); 
        }
        */

        if (ObjectFind(0, name) != -1) ObjectDelete(0, name);
        if (ObjectFind(0, text_name) != -1) ObjectDelete(0, text_name); // ç¡®ä¿æ—§æ–‡æœ¬å¯¹è±¡è¢«åˆ é™¤

        if (ObjectCreate(0, name, OBJ_RECTANGLE, 0, time1, price_start, time2, price_end))
        {
            ObjectSetInteger(0, name, OBJPROP_COLOR, (int)rect_color | (HIGHLIGHT_ALPHA << 24));
            ObjectSetInteger(0, name, OBJPROP_STYLE, STYLE_SOLID);
            ObjectSetInteger(0, name, OBJPROP_WIDTH, 1);
            ObjectSetInteger(0, name, OBJPROP_FILL, true);
            ObjectSetInteger(0, name, OBJPROP_BACK, true);
            ObjectSetInteger(0, name, OBJPROP_SELECTABLE, true);

            // è®¾ç½®å‘¨æœŸå¯è§æ€§
            int tf_flag = GetTimeframeFlag(_Period);
            if (tf_flag != 0)
                ObjectSetInteger(0, name, OBJPROP_TIMEFRAMES, tf_flag);
            else
                ObjectSetInteger(0, name, OBJPROP_TIMEFRAMES, OBJ_ALL_PERIODS);

            // ObjectSetInteger(0, name, OBJPROP_TIMEFRAMES, OBJ_ALL_PERIODS);
            // ğŸš¨ æ ¸å¿ƒä¿®æ­£ï¼šè®¾ç½® OBJPROP_TEXT ä½œä¸ºå¯¹è±¡åˆ—è¡¨çš„â€œè¯´æ˜â€ ğŸš¨
            ObjectSetString(0, name, OBJPROP_TEXT, description_text);

            string description_text_level = description_text + " " + DoubleToString(level1, 3);
            // 3. ğŸš¨ è°ƒç”¨æ–°å‡½æ•°ç»˜åˆ¶å›¾è¡¨æ–‡æœ¬ ğŸš¨
            DrawFiboHighlightText(text_name, description_text_level, time1, price_top, tf_flag);
        }
        else
        {
            Print("æ— æ³•åˆ›å»º é«˜äº® çŸ©å½¢å¯¹è±¡: ", name, ", é”™è¯¯: ", GetLastError());
            return;
        }
    }
}