int CheckSignalAndFilter(const KBarSignal &data, int signal_shift)
{

   // --- è¿‡æ»¤ A: æ—¶é—´çª—å£å’Œæ—¥å†…é£æ§ (L3) --- (ä¿ç•™æ‚¨çš„åŸå§‹ä»£ç )
   // ...

   int trade_command = OP_NONE;

   // --- è¿‡æ»¤ B: ä¿¡å·è´¨é‡å’Œå¤–éƒ¨ç¯å¢ƒ (L2) --- (æ£€æŸ¥çœ‹æ¶¨/çœ‹è·Œä¿¡å·ï¼Œå¹¶è®¾ç½® trade_command)
   // ... æ‚¨çš„ L2 ä¿¡å·è´¨é‡æ£€æŸ¥é€»è¾‘ ...
   
   // ----------------------------------------------------------------------------------
   // --- L3 è¿‡æ»¤å™¨é›†åˆï¼šåœ¨æ‰§è¡Œäº¤æ˜“å‰çš„æœ€åæ£€æŸ¥ ---
   // ----------------------------------------------------------------------------------
   
   if (trade_command != OP_NONE)
   {
      // 1. ğŸš¨ L3a: ä¿¡å·æ–°é²œåº¦è¿‡æ»¤ (é˜²æ­¢äº¤æ˜“è¿‡æœŸä¿¡å·ï¼Œä¾‹å¦‚ shift=220) ğŸš¨
      if (signal_shift > Max_Signal_Freshness_Shift)
      {
         Print("âŒ L3a è¿‡æ»¤ï¼šä¿¡å·å¤ªæ—§ï¼Œshift=", signal_shift, " è¶…è¿‡æœ€å¤§æ–°é²œåº¦é˜ˆå€¼ ", Max_Signal_Freshness_Shift, "ã€‚é˜»æ­¢å¼€ä»“ã€‚");
         return OP_NONE; // ä¿¡å·å¤ªæ—§ï¼Œé˜»æ­¢
      }
      
      // 2. ğŸš¨ L3b: æœ€å¤§å®¹å¿é£é™©è¿‡æ»¤ (é˜²æ­¢äº¤æ˜“é«˜æˆæœ¬/å¤§æ­¢æŸçš„ä¿¡å·) ğŸš¨
      
      // è·å–å½“å‰å…¥åœºä»·å’Œä¿¡å·æ­¢æŸä»·
      double sl_price;
      double entry_price = Open[0]; // å½“å‰ K çº¿çš„å¼€ç›˜ä»·
      
      if (trade_command == OP_BUY)
      {
         sl_price = data.BullishStopLossPrice;
      }
      else // OP_SELL
      {
         sl_price = data.BearishStopLossPrice;
      }
      
      // è®¡ç®—å®é™…é£é™©è·ç¦» (ç‚¹æ•°)
      // æ³¨æ„ï¼šä½¿ç”¨ MathAbs æ¥è·å–ç»å¯¹è·ç¦»
      double actual_risk_points = MathAbs(entry_price - sl_price) / Point();
      actual_risk_points = NormalizeDouble(actual_risk_points, 0); // å–æ•´
      
      // æ£€æŸ¥é£é™©è·ç¦»æ˜¯å¦è¶…è¿‡é˜ˆå€¼ï¼Œæˆ–æ­¢æŸä»·ä½äºé”™è¯¯ä¸€ä¾§ (sl_price > entry_price for BUY)
      bool risk_too_high = (actual_risk_points > Max_Risk_Distance_Points);
      bool sl_on_wrong_side = (trade_command == OP_BUY && sl_price >= entry_price) || 
                              (trade_command == OP_SELL && sl_price <= entry_price);

      if (risk_too_high || sl_on_wrong_side)
      {
         Print("âŒ L3b è¿‡æ»¤ï¼šé£é™©è·ç¦»è¿‡å¤§ (", actual_risk_points, " ç‚¹)ï¼Œæˆ–æ­¢æŸä½ä½äºé”™è¯¯ä¸€ä¾§ã€‚é˜»æ­¢å¼€ä»“ã€‚");
         Print("  [DEBUG] Entry:", DoubleToString(entry_price, _Digits), " | SL:", DoubleToString(sl_price, _Digits));
         return OP_NONE; // é£é™©è¿‡é«˜æˆ–æ­¢æŸæ— æ•ˆï¼Œé˜»æ­¢
      }
      
      // 3. ğŸš¨ L3c: ä¿¡å·ä½¿ç”¨è¿½è¸ªè¿‡æ»¤ (é˜²é‡å¤äº¤æ˜“) ğŸš¨
      // è¿™æ˜¯æ‚¨åŸæœ‰çš„ IsSignalAlreadyTraded æ£€æŸ¥
      
      string signal_id = GenerateSignalID(data.OpenTime);
      Print("---->[KTarget_FinderBot.mq4:589]: signal_id: ", signal_id);

      if (IsSignalAlreadyTraded(signal_id))
      {
         Print("âŒ L3c è¿‡æ»¤ï¼šä¿¡å·å·²è¢«äº¤æ˜“ï¼Œé˜»æ­¢å¼€ä»“ã€‚ID: ", signal_id);
         return OP_NONE; // ä¿¡å·å·²è¢«äº¤æ˜“ï¼Œé˜»æ­¢
      }
   }
   
   return trade_command;
}