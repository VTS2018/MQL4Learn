// KTarget_FinderBot.mq4

// ... (å…¶ä»–å‡½æ•°ä¿æŒä¸å˜) ...

//+------------------------------------------------------------------+
//| æ‰¹é‡è·å– KTarget_Finder5 æ‰€æœ‰ç¼“å†²åŒºæ•°æ®                          |
//+------------------------------------------------------------------+
KBarSignal GetIndicatorBarData(int shift)
{
    KBarSignal data;
    
    // é›†ä¸­ iCustom è°ƒç”¨ (è¯»å– SL ä»·æ ¼å’Œä¿¡å·ä»·æ ¼)
    data.BullishStopLossPrice = GetIndicatorSignal(0, shift); // Buffer 0 (æ–°çš„ç»å¯¹SLä»·)
    data.BearishStopLossPrice = GetIndicatorSignal(1, shift); // Buffer 1 (æ–°çš„ç»å¯¹SLä»·)
    data.BullishSignalPrice   = GetIndicatorSignal(2, shift); // Buffer 2
    data.BearishSignalPrice   = GetIndicatorSignal(3, shift); // Buffer 3
    
    // é™„åŠ ä¿¡æ¯ï¼šä¿¡å· K çº¿çš„æ”¶ç›˜ä»· (ç”¨äºå…¥åœº)
    data.SignalClosePrice = Close[shift]; 
    
    return data;
}

//+------------------------------------------------------------------+
//| OnTick: æ ¸å¿ƒé€»è¾‘å¾ªç¯ (ä¿®æ­£ä¸ºä½¿ç”¨æ‰¹é‡æ•°æ®)
//+------------------------------------------------------------------+
void OnTick()
{
    if(Time[0] == g_last_bar_time) return; 
    g_last_bar_time = Time[0]; 

    if (CountOpenTrades(MagicNumber) >= 1) return; 
    
    // ğŸš¨ é›†ä¸­è·å–æ‰€æœ‰ä¿¡å·æ•°æ®å’Œ SL ä»·æ ¼ ğŸš¨
    KBarSignal last_bar_data = GetIndicatorBarData(1); // è·å– shift=1 (å·²æ”¶ç›˜ K çº¿) çš„æ•°æ®

    // --- 3. æ‰§è¡Œäº¤æ˜“é€»è¾‘ ---
    
    // 3.1 å¤„ç†ä¹°å…¥ä¿¡å·
    if(last_bar_data.BullishSignalPrice != EMPTY_VALUE && last_bar_data.BullishSignalPrice != 0)
    {
        Print(">>> ä¾¦æµ‹åˆ°çœ‹æ¶¨ä¿¡å· @ ", Time[1]);
        
        // A. æ­¢æŸä»·ç›´æ¥è¯»å– Buffer 0
        double sl_price = last_bar_data.BullishStopLossPrice; 
        
        // B. å…¥åœºä»·ï¼šæ–°çš„é€»è¾‘æ˜¯ Close[1] (å³ Open[0])
        double entry_price = last_bar_data.SignalClosePrice; 
        
        // C. è®¡ç®—æ­¢ç›ˆ
        double risk = entry_price - sl_price;
        double tp_price = entry_price + (risk * RewardRatio);

        // D. æ‰§è¡Œå¼€ä»“ (æ³¨æ„ï¼šExecuteTrade å†…éƒ¨éœ€è¦ä½¿ç”¨ entry_price)
        ExecuteTrade(OP_BUY, FixedLot, sl_price, tp_price, entry_price, "K-Target Buy"); 
    }

    // 3.2 å¤„ç†å–å‡ºä¿¡å·
    if(last_bar_data.BearishSignalPrice != EMPTY_VALUE && last_bar_data.BearishSignalPrice != 0)
    {
        Print(">>> ä¾¦æµ‹åˆ°çœ‹è·Œä¿¡å· @ ", Time[1]);
        
        // A. æ­¢æŸä»·ç›´æ¥è¯»å– Buffer 1
        double sl_price = last_bar_data.BearishStopLossPrice;
        
        // B. å…¥åœºä»·ï¼šæ–°çš„é€»è¾‘æ˜¯ Close[1] (å³ Open[0])
        double entry_price = last_bar_data.SignalClosePrice;
        
        // C. è®¡ç®—æ­¢ç›ˆ
        double risk = sl_price - entry_price;
        double tp_price = entry_price - (risk * RewardRatio);

        // D. æ‰§è¡Œå¼€ä»“
        ExecuteTrade(OP_SELL, FixedLot, sl_price, tp_price, entry_price, "K-Target Sell");
    }
}

//+------------------------------------------------------------------+
//| å‡½æ•°: æ‰§è¡Œäº¤æ˜“ (OrderSend å°è£… - ğŸš¨ éœ€è¦å¢åŠ  entry_price å‚æ•° ğŸš¨)
//+------------------------------------------------------------------+
// å¢åŠ  open_price å‚æ•°ï¼Œç¡®ä¿ä½¿ç”¨ Open[0] (å³ SignalClosePrice)
void ExecuteTrade(int type, double lots, double sl, double tp, double open_price, string comment)
{
   // 1. è§„èŒƒåŒ–ä»·æ ¼
   sl = NormalizeDouble(sl, Digits);
   tp = NormalizeDouble(tp, Digits);
   open_price = NormalizeDouble(open_price, Digits); // ä½¿ç”¨ä¼ å…¥çš„ Open[0] ä»·æ ¼
   
   // 2. å‘é€è®¢å•
   // æ³¨æ„ï¼šç°ä»·å• (OP_BUY/OP_SELL) ä¼ å…¥çš„å¼€ä»“ä»· open_price å®é™…ä¸Šæ˜¯ MT4 å¼•æ“ç”¨äºä»·æ ¼æ£€æŸ¥çš„ã€‚
   // å®é™…å¼€ä»“ä»·ä¾ç„¶æ˜¯ Ask/Bidï¼Œä½†åœ¨æ–° K çº¿å¼€ç›˜æ—¶ï¼ŒAsk/Bid ä¼šéå¸¸æ¥è¿‘ Open[0]ã€‚
   int ticket = OrderSend(Symbol(), type, lots, open_price, Slippage, sl, tp, comment, MagicNumber, 0, clrNONE);
   
   // ... (ç»“æœæ£€æŸ¥é€»è¾‘ä¿æŒä¸å˜) ...
}

// ------------------------------------------------------------------
// ğŸš¨ æ—§çš„ FindStructuralSL å‡½æ•°ç°åœ¨å¯ä»¥åˆ é™¤äº†ï¼Œå› ä¸ºå®ƒå·²ç»è¢«æ‰¹é‡è¯»å–å–ä»£ ğŸš¨
// ------------------------------------------------------------------