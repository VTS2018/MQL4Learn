//+------------------------------------------------------------------+
//| ä¸Šä¸‹æ–‡æ£€æŸ¥ï¼šåŸºäºâ€œè¿‡æ»¤åçš„æœ‰æ•ˆä¿¡å·åˆ—è¡¨â€è¿›è¡Œæ–æ³¢åè½¬æ£€æŸ¥           |
//| é€»è¾‘ï¼šæ£€æŸ¥å½“å‰ä¿¡å·æ˜¯å¦è½åœ¨ A, B, D ä»»æ„ä¸€ä¸ªçš„ Fib æ‰©å±•åŒºå†…       |
//+------------------------------------------------------------------+
bool CheckFibReversalContext(int current_shift, int current_type, 
                             FilteredSignal &valid_history_list[]) // ä¼ å…¥ç»è¿‡ FilterWeak... è¿‡æ»¤åçš„åˆ—è¡¨
{
    double current_high = High[current_shift];
    double current_low  = Low[current_shift];
    double current_close = Close[current_shift];

    int total_valid = ArraySize(valid_history_list);
    
    // éå†æ¯ä¸€ä¸ªæœ‰æ•ˆçš„å†å²åŸºçŸ³ä¿¡å· (D, B, A...)
    for (int i = 0; i < total_valid; i++)
    {
        FilteredSignal base_signal = valid_history_list[i]; // ä¾‹å¦‚ä¿¡å· D, æˆ– B, æˆ– A
        
        // 1. åŸºç¡€æ•°æ®å‡†å¤‡
        double base_risk = 0;
        double base_ref_price = base_signal.confirmation_close;
        
        // è®¡ç®—è¯¥å†å²ä¿¡å·çš„åŸºç¡€é£é™© (Risk)
        // æ³¨æ„ï¼šbase_signal æ˜¯åå‘ä¿¡å· (ä¾‹å¦‚å½“å‰æ˜¯çœ‹è·Œï¼Œhistory æ˜¯çœ‹æ¶¨)
        if (current_type == OP_SELL) // å½“å‰çœ‹è·Œï¼Œbase æ˜¯çœ‹æ¶¨
        {
             base_risk = base_signal.confirmation_close - base_signal.stop_loss;
        }
        else // å½“å‰çœ‹æ¶¨ï¼Œbase æ˜¯çœ‹è·Œ
        {
             base_risk = base_signal.stop_loss - base_signal.confirmation_close;
        }
        
        if (base_risk <= 0) continue;

        // 2. ä»·æ ¼ä½ç½®åˆç­› (L4a): 
        // æ‚¨çš„è¦æ±‚ï¼šçœ‹è·Œä¿¡å·å¿…é¡»é«˜äºå†å²çœ‹æ¶¨ä¿¡å·çš„æ”¶ç›˜ä»· (ä¸èƒ½åœ¨åœ°ä¸‹å®¤è°ˆåè½¬)
        if (current_type == OP_SELL && current_close <= base_ref_price) continue;
        if (current_type == OP_BUY && current_close >= base_ref_price) continue;

        // 3. éå†æ‰€æœ‰å®šä¹‰çš„æ–æ³¢åŒºåŸŸ (1.618-2, 2.618-3, 4.236-5...)
        // è¿™é‡Œä½¿ç”¨å¾ªç¯éå† FiboExhaustionZones æ•°ç»„ (å‡è®¾å·²å®šä¹‰)
        for (int z = 0; z < FIBO_ZONES_COUNT; z++)
        {
            double level1 = FiboExhaustionZones[z].level1;
            double level2 = FiboExhaustionZones[z].level2;
            
            double zone_low, zone_high;
            
            // è®¡ç®—å…·ä½“çš„åŒºåŸŸä»·æ ¼
            if (current_type == OP_SELL) // å†å²æ˜¯çœ‹æ¶¨ï¼Œå‘ä¸Šå»¶ä¼¸
            {
                zone_low  = base_ref_price + (base_risk * level1);
                zone_high = base_ref_price + (base_risk * level2);
            }
            else // å†å²æ˜¯çœ‹è·Œï¼Œå‘ä¸‹å»¶ä¼¸
            {
                zone_low  = base_ref_price - (base_risk * level2);
                zone_high = base_ref_price - (base_risk * level1);
            }
            
            // 4. è§¦ç¢°æ£€æŸ¥ (Touching Check)
            // åªè¦å½“å‰ä¿¡å· K çº¿è§¦ç¢°åˆ°äº†è¿™ä¸ªåŒºåŸŸ
            bool is_touching = false;
            if (current_type == OP_SELL)
            {
                if (current_low <= zone_high && current_high >= zone_low) is_touching = true;
            }
            else
            {
                if (current_high >= zone_low && current_low <= zone_high) is_touching = true;
            }
            
            if (is_touching)
            {
                // ğŸ¯ æ‰¾åˆ°äº†ï¼
                // æ‰“å°è¯¦ç»†çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼šæ˜¯å“ªä¸ªå†å²ä¿¡å·(shift)ï¼Œå“ªä¸ªåŒºåŸŸ
                Print("âœ… [ä¸Šä¸‹æ–‡åŒ¹é…] å½“å‰ä¿¡å· K[", current_shift, "] å‘½ä¸­å†å²æœ‰æ•ˆä¿¡å· K[", base_signal.shift, 
                      "] çš„ Fib åŒºé—´ [", DoubleToString(level1, 3), "-", DoubleToString(level2, 3), "]");
                
                return true; // åªè¦æ»¡è¶³ä»»æ„ä¸€ä¸ªï¼Œå°±è§†ä¸ºæœ‰ä¸Šä¸‹æ–‡æ”¯æŒ
            }
        }
    }
    
    return false; // æ‰«æå®Œæ‰€æœ‰å†å²æœ‰æ•ˆä¿¡å·ï¼Œéƒ½æ²¡æœ‰å‘½ä¸­
}