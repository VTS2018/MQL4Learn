CSL_TradeInfo

//+------------------------------------------------------------------+
//| è¾…åŠ©ç»“æ„ä½“ï¼šç”¨äºä¸´æ—¶å­˜å‚¨å†å²è®¢å•ä¿¡æ¯ (æ”¾åœ¨å‡½æ•°å¤–éƒ¨æˆ–æœ€ä¸Šæ–¹)
//+------------------------------------------------------------------+
struct CSL_TradeInfo
{
   int      ticket;
   datetime close_time;
   double   net_profit; // å‡€åˆ©æ¶¦
};

//+------------------------------------------------------------------+
//| UpdateCSLByHistory V2.0 (å¥å£®ç‰ˆ)
//| åŠŸèƒ½ï¼šæ‰«æå†å²è®°å½•ï¼Œè®¡ç®—è¿ç»­æ­¢æŸæ¬¡æ•°ï¼Œå¹¶æ›´æ–°å…¨å±€é”å®šçŠ¶æ€
//| ç‰¹æ€§ï¼šæŠ—æ‰‹åŠ¨æ’åºå¹²æ‰°ï¼Œè‡ªåŠ¨è®¡ç®—æ‰‹ç»­è´¹å’Œåº“å­˜è´¹
//+------------------------------------------------------------------+
void UpdateCSLByHistory()
{
   // 1. å¦‚æœåŠŸèƒ½æ²¡å¼€ï¼Œç›´æ¥é‡ç½®å¹¶è¿”å›
   if(!Enable_CSL) 
   {
      g_ConsecutiveLossCount = 0;
      g_CSLLockoutEndTime = 0;
      return;
   }

   // åˆå§‹åŒ–è®¡æ•°å™¨
   g_ConsecutiveLossCount = 0;
   
   // å®šä¹‰åŠ¨æ€æ•°ç»„å­˜å‚¨ç­›é€‰å‡ºçš„æœ¬å“ç§å†å²å•
   CSL_TradeInfo trades[];
   
   // =========================================================
   // æ­¥éª¤ 1: å…¨é‡æ‰«æ (Collect) - ä¸ä¾èµ– MT4 æ’åº
   // =========================================================
   int total_history = OrdersHistoryTotal();
   
   for(int i = 0; i < total_history; i++)
   {
      // å¿…é¡»å¾ªç¯æ‰€æœ‰è®¢å•ï¼Œä¸èƒ½å› ä¸ºæ—¶é—´æˆ–è€…è·åˆ© breakï¼Œå› ä¸ºé¡ºåºå¯èƒ½æ˜¯ä¹±çš„
      if(OrderSelect(i, SELECT_BY_POS, MODE_HISTORY) == false) continue;
      
      // A. åŸºç¡€è¿‡æ»¤ï¼šåªçœ‹æœ¬ EAã€æœ¬å“ç§çš„å•å­
      if(OrderSymbol() != Symbol() || OrderMagicNumber() != MagicNumber) continue;
      
      // B. ç±»å‹è¿‡æ»¤ï¼šåªçœ‹å¤šç©ºå• (æ’é™¤ Balance/Credit ç­‰èµ„é‡‘æµæ°´)
      if(OrderType() > OP_SELL) continue;
      
      // C. æ”¶é›†æ•°æ®åˆ°æ•°ç»„
      int size = ArraySize(trades);
      ArrayResize(trades, size + 1);
      
      trades[size].ticket     = OrderTicket();
      trades[size].close_time = OrderCloseTime();
      // å‡€åˆ©æ¶¦ = ç›˜é¢ç›ˆäº + æ‰‹ç»­è´¹ + åº“å­˜è´¹
      trades[size].net_profit = OrderProfit() + OrderCommission() + OrderSwap();
   }
   
   // =========================================================
   // æ­¥éª¤ 2: å†…éƒ¨æ’åº (Sort) - æŒ‰å¹³ä»“æ—¶é—´ä»è¿‘åˆ°è¿œ
   // =========================================================
   int count = ArraySize(trades);
   
   // ä½¿ç”¨ç®€å•çš„å†’æ³¡æ’åº (å› ä¸ºå†å²å•é‡é€šå¸¸ä¸ä¼šé€ æˆæ€§èƒ½ç“¶é¢ˆ)
   for(int i = 0; i < count - 1; i++)
   {
      for(int j = 0; j < count - i - 1; j++)
      {
         // å¦‚æœå‰ä¸€ä¸ªæ¯”åä¸€ä¸ªæ—¶é—´æ—© (Old < New)ï¼Œåˆ™äº¤æ¢
         // æˆ‘ä»¬éœ€è¦ Newest åœ¨ Index 0
         if(trades[j].close_time < trades[j+1].close_time)
         {
            CSL_TradeInfo temp = trades[j];
            trades[j] = trades[j+1];
            trades[j+1] = temp;
         }
      }
   }
   
   // =========================================================
   // æ­¥éª¤ 3: è¿æŸè®¡ç®—ä¸é”å®šé€»è¾‘ (Calculate)
   // =========================================================
   datetime last_loss_time = 0; // è®°å½•æœ€è¿‘ä¸€æ¬¡äºæŸçš„æ—¶é—´
   
   for(int i = 0; i < count; i++)
   {
      // å¦‚æœé‡åˆ°ç›ˆåˆ©å• (å‡€åˆ©æ¶¦ >= 0)
      if(trades[i].net_profit >= 0)
      {
         // è¿æŸè¢«ä¸­æ–­ï¼Œè®¡ç®—ç»“æŸ
         break; 
      }
      else
      {
         // é‡åˆ°äºæŸå•ï¼Œè®¡æ•°å™¨ +1
         g_ConsecutiveLossCount++;
         
         // è®°å½•æœ€æ–°çš„ä¸€ç¬”äºæŸæ—¶é—´ (ç”¨äºè®¡ç®—é”å®šæˆªæ­¢æ—¶é—´)
         if(last_loss_time == 0) last_loss_time = trades[i].close_time;
      }
   }
   
   // =========================================================
   // æ­¥éª¤ 4: æ›´æ–°å…¨å±€é”å®šçŠ¶æ€ (Lockout Logic)
   // =========================================================
   if(g_ConsecutiveLossCount >= CSL_Max_Losses)
   {
      // è¾¾åˆ°è¿æŸä¸Šé™ï¼Œè®¡ç®—é”å®šç»“æŸæ—¶é—´
      // é”å®šç»“æŸæ—¶é—´ = æœ€è¿‘ä¸€ç¬”äºæŸå¹³ä»“æ—¶é—´ + é”å®šå°æ—¶æ•°
      g_CSLLockoutEndTime = last_loss_time + (CSL_Lockout_Duration * 3600);
      
      // è°ƒè¯•æ—¥å¿— (å¯é€‰)
      // Print("ğŸš« è§¦å‘è¿ç»­æ­¢æŸé£æ§! æ¬¡æ•°:", g_ConsecutiveLossCount, 
      //       " è§£é”æ—¶é—´:", TimeToString(g_CSLLockoutEndTime));
   }
   else
   {
      // æœªè¾¾åˆ°è¿æŸä¸Šé™ï¼Œæ¸…é™¤é”å®šçŠ¶æ€
      g_CSLLockoutEndTime = 0;
   }
   
   // æ›´æ–°ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´
   g_LastCSLCheckTime = TimeCurrent();
}