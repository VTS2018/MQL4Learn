//+------------------------------------------------------------------+
//| æ ¸å¿ƒåŠŸèƒ½ï¼šè§£ææ³¨é‡Šå¹¶æ‰§è¡Œæ–æ³¢é‚£å¥‘é˜¶æ¢¯è¿½è¸ª (Fibo Step Trailing)
//+------------------------------------------------------------------+
void ManageOpenTrades()
{
   for(int i = OrdersTotal() - 1; i >= 0; i--)
   {
      if(OrderSelect(i, SELECT_BY_POS, MODE_TRADES) == false) continue;
      if(OrderSymbol() != Symbol() || OrderMagicNumber() != MagicNumber) continue;
      
      // ä»…å¤„ç†æŒä»“å• (æ’é™¤æŒ‚å•)
      if(OrderType() > OP_SELL) continue; 

      /** 1.0
      // =======================================================
      // 1. ä»æ³¨é‡Šä¸­è¿˜åŸ ç†è®ºåæ ‡ (Fibo 0 å’Œ Fibo 1)
      // =======================================================
      string comment = OrderComment();
      
      // æŸ¥æ‰¾æ ‡è®°ä½ç½®
      int pos_E = StringFind(comment, "E:");
      int pos_S = StringFind(comment, "#S:");
      
      // å¦‚æœæ‰¾ä¸åˆ°æ ‡è®°ï¼Œè¯´æ˜è¿™æ˜¯æ—§ç‰ˆæœ¬è®¢å•æˆ–æ‰‹åŠ¨å•ï¼Œè·³è¿‡å¤„ç†
      if (pos_E == -1 || pos_S == -1) continue;
      
      // æå–å­—ç¬¦ä¸²å¹¶è½¬ä¸º double
      // "E:xxxx.x" -> ä» E: åå¼€å§‹æˆªå–ï¼Œç›´åˆ° #S: å‰
      string str_entry = StringSubstr(comment, pos_E + 2, pos_S - (pos_E + 2));
      // "#S:xxxx.x" -> ä» #S: åå¼€å§‹æˆªå–åˆ°æœ«å°¾
      string str_sl    = StringSubstr(comment, pos_S + 3);
      
      double fibo_1_0_price = StringToDouble(str_entry); // ç†è®ºå…¥åœº (Close[1])
      double fibo_0_0_price = StringToDouble(str_sl);    // åŸå§‹æ­¢æŸ
      
      // è®¡ç®—å•ä½è·ç¦» (Risk Unit)
      double unit_dist = MathAbs(fibo_1_0_price - fibo_0_0_price);
      
      // é˜²æ­¢é™¤é›¶æˆ–æå°è·ç¦»é”™è¯¯
      if (unit_dist < Point()) continue;
      */

      // è·å–å½“å‰è®¢å•å·
      int ticket = OrderTicket();

      // =======================================================
      // 1. ä»â€œå½±å­è´¦æœ¬â€è¯»å–ç†è®ºåæ ‡
      // =======================================================
      string var_prefix = ShortenObjectNameBot(WindowExpertName()) + "_";
      string var_name_E = var_prefix + IntegerToString(ticket) + "_E";
      string var_name_S = var_prefix + IntegerToString(ticket) + "_S";

      // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è®°å½•
      if (!GlobalVariableCheck(var_name_E) || !GlobalVariableCheck(var_name_S))
      {
          // å¦‚æœæ‰¾ä¸åˆ°è®°å½•ï¼ˆå¯èƒ½æ˜¯æ‰‹åŠ¨å•æˆ–æ—§ç‰ˆæœ¬å•ï¼‰ï¼Œåˆ™è·³è¿‡æˆ–å°è¯•ç”¨å½“å‰SL/Openå€’æ¨(ä¸æ¨è)
          continue; 
      }

      // è¯»å–æ•°æ®
      double fibo_1_0_price = GlobalVariableGet(var_name_E); // ç†è®ºå…¥åœº (Close[1])
      double fibo_0_0_price = GlobalVariableGet(var_name_S); // åŸå§‹æ­¢æŸ

      // è®¡ç®—å•ä½è·ç¦» (Risk Unit)
      double unit_dist = MathAbs(fibo_1_0_price - fibo_0_0_price);
      if (unit_dist < Point()) continue;

      // =======================================================
      // 2. è®¡ç®—å…³é”®æ–æ³¢é‚£å¥‘é˜¶æ¢¯ä½ (Target Levels)
      // =======================================================
      // å…¬å¼: ç›®æ ‡ä»· = å…¥åœºä»· +/- (è·ç¦» * å€æ•°)
      int dir = (OrderType() == OP_BUY) ? 1 : -1;
      
      double level_1_618 = fibo_1_0_price + dir * (unit_dist * 0.618); // é—¨æ§›
      double level_2_000 = fibo_1_0_price + dir * (unit_dist * 1.000); // 1:1
      double level_2_618 = fibo_1_0_price + dir * (unit_dist * 1.618); // 1:1.618
      double level_3_000 = fibo_1_0_price + dir * (unit_dist * 2.000); // 1:2
      double level_4_236 = fibo_1_0_price + dir * (unit_dist * 3.236); // 1:3.236

      // è·å–å½“å‰å®æ—¶ä»·æ ¼
      double current_price = (OrderType() == OP_BUY) ? Bid : Ask;
      double current_sl    = OrderStopLoss();
      
      // å®šä¹‰ç§»åŠ¨æ­¢æŸçš„ç›®æ ‡ä½ (New SL)
      double new_sl = 0;
      bool modify_needed = false;
      string action_reason = "";

      // =======================================================
      // 3. é˜¶æ¢¯æˆ˜æœ¯é€»è¾‘ (Ladder Logic) - åªè®¸ä¸Šï¼Œä¸è®¸ä¸‹
      // =======================================================
      
      // åœºæ™¯ A: ä»·æ ¼çªç ´ 1.618 -> ç§»åŠ¨æ­¢æŸåˆ° ä¿æœ¬ä½ (Fibo 1.0 + å¾®åˆ©)
      // å¿…é¡»ç¡®ä¿è¿˜æ²¡ç§»åŠ¨è¿‡ (ç°åœ¨çš„SLæ¯”ä¿æœ¬ä½å·®)
      if ( CheckPricePass(current_price, level_1_618, dir) )
      {
         // ä¿æœ¬ä½ = ç†è®ºå…¥åœº + å°‘é‡ç‚¹å·®ä¿æŠ¤
         double break_even = fibo_1_0_price + dir * (MarketInfo(Symbol(), MODE_SPREAD) * Point());
         
         // å¦‚æœå½“å‰æ­¢æŸæ¯”ä¿æœ¬ä½ è¿˜è¦å·® (äºæŸçŠ¶æ€)ï¼Œåˆ™ä¸Šç§»
         if ( (dir == 1 && current_sl < break_even) || (dir == -1 && current_sl > break_even) )
         {
            new_sl = break_even;
            modify_needed = true;
            action_reason = "ä¿æœ¬(>1.618)";
         }
      }
      
      // åœºæ™¯ B: ä»·æ ¼çªç ´ 2.618 -> é”å®š 1:1 åˆ©æ¶¦ (Fibo 2.0)
      if ( CheckPricePass(current_price, level_2_618, dir) )
      {
         // æ£€æŸ¥å½“å‰SLæ˜¯å¦å·²ç»åœ¨ Fibo 2.0 ä¹‹ä¸Šï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è·Ÿè¿›
         if ( (dir == 1 && current_sl < level_2_000 - Point()) || (dir == -1 && current_sl > level_2_000 + Point()) )
         {
            new_sl = level_2_000;
            modify_needed = true;
            action_reason = "é”å®š1:1(>2.618)";
         }
      }

      // åœºæ™¯ C: ä»·æ ¼çªç ´ 4.236 -> é”å®š 1:2 åˆ©æ¶¦ (Fibo 3.0)
      if ( CheckPricePass(current_price, level_4_236, dir) )
      {
         if ( (dir == 1 && current_sl < level_3_000 - Point()) || (dir == -1 && current_sl > level_3_000 + Point()) )
         {
            new_sl = level_3_000;
            modify_needed = true;
            action_reason = "é”å®š1:2(>4.236)";
         }
      }

      // =======================================================
      // 4. æ‰§è¡Œä¿®æ”¹
      // =======================================================
      if (modify_needed && new_sl != 0)
      {
         // è§„èŒƒåŒ–ä»·æ ¼ç²¾åº¦
         new_sl = NormalizeDouble(new_sl, _Digits);
         
         // æ‰§è¡Œä¿®æ”¹
         if (OrderModify(OrderTicket(), OrderOpenPrice(), new_sl, OrderTakeProfit(), 0, clrNONE))
         {
            Print(" [è¿½è¸ªæ­¢æŸ] è®¢å• #", OrderTicket(), " ", action_reason, 
                  " | å½“å‰ä»·:", DoubleToString(current_price, _Digits),
                  " | æ–°æ­¢æŸ:", DoubleToString(new_sl, _Digits));
         }
         else
         {
            Print(" [è¿½è¸ªæ­¢æŸ] ä¿®æ”¹å¤±è´¥ #", OrderTicket(), " Error:", GetLastError());
         }
      }
   }
}

//+------------------------------------------------------------------+
//| âœ… è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥ä»·æ ¼æ˜¯å¦ã€è¶…è¿‡ã€‘äº†æŸæ¡çº¿
//+------------------------------------------------------------------+
bool CheckPricePass(double current, double target, int dir)
{
   if (dir == 1) return (current >= target); // åšå¤šï¼šä»·æ ¼ >= ç›®æ ‡
   else          return (current <= target); // åšç©ºï¼šä»·æ ¼ <= ç›®æ ‡
}

//+------------------------------------------------------------------+
//| âœ… æ¸…ç†å·²å¹³ä»“è®¢å•çš„å½±å­æ•°æ® (å»ºè®®åœ¨ OnTick æˆ– OnTimer ä¸­è°ƒç”¨)
//+------------------------------------------------------------------+
void CleanUpShadowLedger()
{
    // è·å–ç»ˆç«¯æ‰€æœ‰å…¨å±€å˜é‡çš„æ€»æ•°
    int total_vars = GlobalVariablesTotal();
    int deleted_count = 0; // ç»Ÿè®¡ä¸€ä¸‹åˆ äº†å¤šå°‘
    
    // ä»åå‘å‰éå† (å› ä¸ºåˆ é™¤ä¼šæ”¹å˜ç´¢å¼•)
    for(int i = total_vars - 1; i >= 0; i--)
    {
        string var_name = GlobalVariableName(i);
        
        // 1. ç­›é€‰å‡ºå±äºæœ¬ EA çš„å˜é‡ (å‰ç¼€ KT5_)
        string var_prefix = ShortenObjectNameBot(WindowExpertName()) + "_";
        if(StringFind(var_name, var_prefix) == 0)
        {
            // è§£æå‡º Ticket å·
            // æ ¼å¼: KT5_123456_E
            string parts[];
            StringSplit(var_name, '_', parts);
            
            if(ArraySize(parts) == 3)
            {
                int ticket = (int)StringToInteger(parts[1]);
                
                // 2. æ£€æŸ¥è¯¥ Ticket æ˜¯å¦è¿˜åœ¨æŒä»“åˆ—è¡¨ä¸­
                if(IsTradeOpen(ticket) == false)
                {
                    // å¦‚æœè®¢å•ä¸åœ¨æŒä»“ä¸­(å·²å¹³ä»“æˆ–åˆ é™¤)ï¼Œåˆ™åˆ é™¤è¯¥å…¨å±€å˜é‡
                    GlobalVariableDel(var_name);
                    deleted_count++;
                    // Print("ğŸ§¹ [æ¸…ç†] åˆ é™¤å¤±æ•ˆå½±å­æ•°æ®: ", var_name);
                }
            }
        }
    }
    if (deleted_count > 0)
       Print(" [æ¸…ç†æ‰§è¡Œ] å…±åˆ é™¤äº† ", deleted_count, " æ¡å·²å¤±æ•ˆçš„å½±å­è®°å½•ã€‚");
}

//+------------------------------------------------------------------+
//| âœ… è¾…åŠ©ï¼šæ£€æŸ¥è®¢å•æ˜¯å¦å¤„äº Open çŠ¶æ€
//+------------------------------------------------------------------+
bool IsTradeOpen(int ticket)
{
    if(OrderSelect(ticket, SELECT_BY_TICKET))
    {
        if(OrderCloseTime() == 0) return true; // è¿˜åœ¨æŒä»“
    }
    return false; // æ‰¾ä¸åˆ°æˆ–å·²å¹³ä»“
}