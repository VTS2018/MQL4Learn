//+------------------------------------------------------------------+
//| è¾“å…¥å‚æ•°å»ºè®®
//+------------------------------------------------------------------+
input bool   Use_Hedge_Filter       = true;  // å¼€å…³ï¼šæ˜¯å¦å¯ç”¨åå‘è·ç¦»è¿‡æ»¤
input int    Hedge_ATR_Period       = 14;    // ATR è®¡ç®—å‘¨æœŸ
input double Min_Hedge_Dist_ATR     = 0.5;   // æœ€å°è·ç¦»ç³»æ•° (å»ºè®® 0.5 åˆ° 1.0)

//+------------------------------------------------------------------+
//| æ ¸å¿ƒåŠŸèƒ½ï¼šæ£€æŸ¥æ˜¯å¦è·ç¦»åå‘æŒä»“å¤ªè¿‘ (é˜²æ­¢éœ‡è¡ç£¨æŸ)                  |
//| è¿”å›å€¼: true = è·ç¦»è¶³å¤Ÿ(å…è®¸äº¤æ˜“); false = è·ç¦»å¤ªè¿‘(ç¦æ­¢äº¤æ˜“)      |
//+------------------------------------------------------------------+
bool CheckHedgeDistance(int new_signal_type)
{
   // 1. å¦‚æœå¼€å…³å…³é—­ï¼Œç›´æ¥æ”¾è¡Œ
   if (!Use_Hedge_Filter) return true;

   // 2. è·å–å½“å‰çš„ ATR å€¼ (è¡¡é‡å½“å‰å¸‚åœºçš„æ³¢åŠ¨å°ºåº¦)
   // ä½¿ç”¨ shift=1 (ä¸Šä¸€æ ¹æ”¶ç›˜Kçº¿) ä»¥ä¿è¯æ•°å€¼ç¨³å®šï¼Œä¸é—ªçƒ
   double current_atr = iATR(NULL, 0, Hedge_ATR_Period, 1);
   
   // å¼‚å¸¸ä¿æŠ¤
   if (current_atr <= 0) return true;

   // è®¡ç®—æœ€å°å…è®¸çš„ç‰©ç†è·ç¦» (ä»·æ ¼)
   double min_distance = current_atr * Min_Hedge_Dist_ATR;

   // 3. éå†æ‰€æœ‰æŒä»“å•
   int total = OrdersTotal();
   for (int i = 0; i < total; i++)
   {
      if (OrderSelect(i, SELECT_BY_POS, MODE_TRADES))
      {
         // ç­›é€‰æœ¬ EA çš„è®¢å•
         if (OrderSymbol() == Symbol() && OrderMagicNumber() == MagicNumber)
         {
            // 4. å¯»æ‰¾ã€åå‘ã€‘æŒä»“
            // å¦‚æœæ–°ä¿¡å·æ˜¯ BUYï¼Œæˆ‘ä»¬è¦æ£€æŸ¥æœ‰æ²¡æœ‰å¾ˆè¿‘çš„ SELL å•
            // å¦‚æœæ–°ä¿¡å·æ˜¯ SELLï¼Œæˆ‘ä»¬è¦æ£€æŸ¥æœ‰æ²¡æœ‰å¾ˆè¿‘çš„ BUY å•
            if (OrderType() != new_signal_type)
            {
               // è®¡ç®—å½“å‰ä»·æ ¼ä¸é‚£å¼ æŒä»“å•å¼€ä»“ä»·çš„è·ç¦»
               // æ³¨æ„ï¼šè¿™é‡Œç”¨ Close[0] (å½“å‰ä»·) è¿˜æ˜¯ OrderOpenPrice å‡å¯
               // å»ºè®®æ¯”è¾ƒï¼šæ–°ä¿¡å·çš„å…¥åœºä½(Close[0]) vs è€å•å­çš„å…¥åœºä½
               double distance = MathAbs(OrderOpenPrice() - Close[0]);
               
               // 5. åˆ¤å®š
               if (distance < min_distance)
               {
                  // è·ç¦»å¤ªè¿‘ï¼ä¹Ÿå°±æ˜¯æ‚¨é‡åˆ°çš„ ETHUSD åªæœ‰ 1.6 ç¾é‡‘ä»·å·®çš„æƒ…å†µ
                  Print("ğŸ›‘ [éœ‡è¡è¿‡æ»¤] è·ç¦»åå‘æŒä»“å¤ªè¿‘ï¼");
                  Print("   -> åå‘å•å·: ", OrderTicket(), " ç±»å‹: ", (OrderType()==OP_BUY?"BUY":"SELL"));
                  Print("   -> å½“å‰è·ç¦»: ", DoubleToString(distance, _Digits));
                  Print("   -> æœ€å°è¦æ±‚: ", DoubleToString(min_distance, _Digits), " (ATR*", Min_Hedge_Dist_ATR, ")");
                  
                  return false; // ç¦æ­¢äº¤æ˜“
               }
            }
         }
      }
   }
   
   // éå†å®Œå¦‚æœæ²¡æœ‰è§¦å‘æ‹¦æˆªï¼Œè¯´æ˜è·ç¦»éƒ½è¶³å¤Ÿï¼Œæˆ–è€…æ²¡æœ‰åå‘å•
   return true;
}