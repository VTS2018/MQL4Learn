//+------------------------------------------------------------------+
//| UpdateCSLByHistory_V3 (é˜²æ­»é”ä¿®æ­£ç‰ˆ)
//| åŠŸèƒ½ï¼šæ‰«æå†å²è®°å½•ï¼Œè®¡ç®—è¿ç»­æ­¢æŸæ¬¡æ•°ï¼Œå¹¶æ›´æ–°å…¨å±€é”å®šçŠ¶æ€
//| ç‰¹æ€§ï¼šæŠ—æ‰‹åŠ¨æ’åºå¹²æ‰°ï¼Œè‡ªåŠ¨è®¡ç®—æ‰‹ç»­è´¹å’Œåº“å­˜è´¹
//| ä¿®å¤ï¼šè§£å†³äº†"è¿‡æœŸé”å®šæ—¶é—´"å¯¼è‡´çš„æ— é™é‡ç½®æ­»é”é—®é¢˜
//+------------------------------------------------------------------+
void UpdateCSLByHistory_V3()
{
   // 1. å¦‚æœåŠŸèƒ½æ²¡å¼€ï¼Œç›´æ¥é‡ç½®å¹¶è¿”å›
   if(!Enable_CSL) 
   {
      g_ConsecutiveLossCount = 0;
      g_CSLLockoutEndTime = 0;
      return;
   }

   // åˆå§‹åŒ–è®¡æ•°å™¨ (è™½ç„¶ä¸‹é¢ä¼šé‡ç®—ï¼Œä½†ä¿æŒå¥½ä¹ æƒ¯)
   g_ConsecutiveLossCount = 0;
   
   // å®šä¹‰åŠ¨æ€æ•°ç»„å­˜å‚¨ç­›é€‰å‡ºçš„æœ¬å“ç§å†å²å•
   CSL_TradeInfo trades[];
   
   // =========================================================
   // æ­¥éª¤ 1: å…¨é‡æ‰«æ (Collect) - ä¸ä¾èµ– MT4 æ’åº
   // =========================================================
   int total_history = OrdersHistoryTotal();
   
   for(int i = 0; i < total_history; i++)
   {
      // å¿…é¡»å¾ªç¯æ‰€æœ‰è®¢å•ï¼Œä¸èƒ½å› ä¸ºæ—¶é—´æˆ–è€…è·åˆ© breakï¼Œå› ä¸ºé¡ºåºå¯èƒ½æ˜¯ä¹±çš„
      if(OrderSelect(i, SELECT_BY_POS, MODE_HISTORY) == false) continue;
      
      // A. åŸºç¡€è¿‡æ»¤ï¼šåªçœ‹æœ¬ EAã€æœ¬å“ç§çš„å•å­
      if(OrderSymbol() != Symbol() || OrderMagicNumber() != MagicNumber) continue;
      
      // B. ç±»å‹è¿‡æ»¤ï¼šåªçœ‹å¤šç©ºå• (æ’é™¤ Balance/Credit ç­‰èµ„é‡‘æµæ°´)
      if(OrderType() > OP_SELL) continue;
      
      // C. æ”¶é›†æ•°æ®åˆ°æ•°ç»„
      int size = ArraySize(trades);
      ArrayResize(trades, size + 1);
      
      trades[size].ticket     = OrderTicket();
      trades[size].close_time = OrderCloseTime();
      // å‡€åˆ©æ¶¦ = ç›˜é¢ç›ˆäº + æ‰‹ç»­è´¹ + åº“å­˜è´¹
      trades[size].net_profit = OrderProfit() + OrderCommission() + OrderSwap();
   }
   
   // =========================================================
   // æ­¥éª¤ 2: å†…éƒ¨æ’åº (Sort) - æŒ‰å¹³ä»“æ—¶é—´ä»è¿‘åˆ°è¿œ
   // =========================================================
   int count = ArraySize(trades);
   
   // ä½¿ç”¨ç®€å•çš„å†’æ³¡æ’åº (å› ä¸ºå†å²å•é‡é€šå¸¸ä¸ä¼šé€ æˆæ€§èƒ½ç“¶é¢ˆ)
   for(int i = 0; i < count - 1; i++)
   {
      for(int j = 0; j < count - i - 1; j++)
      {
         // å¦‚æœå‰ä¸€ä¸ªæ¯”åä¸€ä¸ªæ—¶é—´æ—© (Old < New)ï¼Œåˆ™äº¤æ¢
         // æˆ‘ä»¬éœ€è¦ Newest åœ¨ Index 0
         if(trades[j].close_time < trades[j+1].close_time)
         {
            CSL_TradeInfo temp = trades[j];
            trades[j] = trades[j+1];
            trades[j+1] = temp;
         }
      }
   }
   
   // =========================================================
   // æ­¥éª¤ 3: è¿æŸè®¡ç®— (Calculate)
   // =========================================================
   // é‡ç½®è®¡æ•°å™¨ï¼Œå¼€å§‹ä¸¥è°¨è®¡ç®—
   g_ConsecutiveLossCount = 0;
   datetime last_loss_time = 0; // è®°å½•æœ€è¿‘ä¸€æ¬¡äºæŸçš„æ—¶é—´
   
   for(int i = 0; i < count; i++)
   {
      // å¦‚æœé‡åˆ°ç›ˆåˆ©å• (å‡€åˆ©æ¶¦ >= 0)
      if(trades[i].net_profit >= 0)
      {
         // è¿æŸè¢«ä¸­æ–­ï¼Œè®¡ç®—ç»“æŸ
         break; 
      }
      else
      {
         // é‡åˆ°äºæŸå•ï¼Œè®¡æ•°å™¨ +1
         g_ConsecutiveLossCount++;
         
         // è®°å½•æœ€æ–°çš„ä¸€ç¬”äºæŸæ—¶é—´ (ç”¨äºè®¡ç®—é”å®šæˆªæ­¢æ—¶é—´)
         // å› ä¸ºæ˜¯å€’åºæ’åˆ—ï¼Œç¬¬ä¸€ä¸ªé‡åˆ°çš„äºæŸå•è‚¯å®šæ˜¯æœ€æ–°çš„
         if(last_loss_time == 0) last_loss_time = trades[i].close_time;
      }
   }
   
   // =========================================================
   // æ­¥éª¤ 4: æ›´æ–°å…¨å±€é”å®šçŠ¶æ€ (Lockout Logic - Fixed V3)
   // =========================================================
   if(g_ConsecutiveLossCount >= CSL_Max_Losses)
   {
      // 1. å…ˆè®¡ç®—å‡º"ç†è®ºä¸Š"åº”è¯¥è§£é”çš„æ—¶é—´
      // å…¬å¼ï¼šæœ€åäºæŸæ—¶é—´ + é”å®šå°æ—¶æ•°
      datetime potential_unlock_time = last_loss_time + (CSL_Lockout_Duration * 3600);
      
      // 2. ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šè¿›è¡Œ"æœªæ¥æ€§"æ£€æŸ¥
      // åªæœ‰å½“è¿™ä¸ªè§£é”æ—¶é—´ æ˜¯"æœªæ¥"çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰æ‰§è¡Œé”å®šã€‚
      // å¦‚æœè§£é”æ—¶é—´å·²ç»æ˜¯"è¿‡å»"äº† (æ¯”å¦‚æ˜¯2020å¹´çš„å•å­)ï¼Œè¯´æ˜åˆ‘æœŸå·²æ»¡ï¼Œä¸è¦å†é”äº†ã€‚
      
      if (potential_unlock_time > TimeCurrent())
      {
         // ç¡®å®éœ€è¦é”å®š
         g_CSLLockoutEndTime = potential_unlock_time;
         
         // è°ƒè¯•æ—¥å¿— (ä»…åœ¨çŠ¶æ€æ”¹å˜æˆ–è°ƒè¯•æ—¶æ‰“å¼€ï¼Œé¿å…åˆ·å±)
         // Print("ğŸš« CSLé£æ§æ¿€æ´»: ", g_ConsecutiveLossCount, "è¿æŸ. é”å®šè‡³: ", TimeToString(g_CSLLockoutEndTime));
      }
      else
      {
         // è™½ç„¶è¿æŸæ¬¡æ•°å¤Ÿäº†ï¼Œä½†æƒ©ç½šæ—¶é—´å·²è¿‡
         g_CSLLockoutEndTime = 0;
      }
   }
   else
   {
      // æœªè¾¾åˆ°è¿æŸä¸Šé™ï¼Œæ¸…é™¤é”å®šçŠ¶æ€
      g_CSLLockoutEndTime = 0;
   }
   
   // æ›´æ–°ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´
   g_LastCSLCheckTime = TimeCurrent();
}