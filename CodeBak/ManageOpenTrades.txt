// åœ¨ CalculateTradeAndExecute_V2 å‡½æ•°æœ«å°¾...

    // ... (å‰é¢çš„è®¡ç®—é€»è¾‘ä¸å˜) ...
    
    // 1. ç”Ÿæˆç²¾ç®€æ³¨é‡Š (åªæ”¾èº«ä»½æ ‡è¯†ï¼Œä¸å†æ”¾ä»·æ ¼)
    // æ ¼å¼: KT5|ä¿¡å·ID|FixLot (ä»…ç”¨äºè®©äººçœ¼çœ‹ç€æ–¹ä¾¿)
    string comment = EA_Version_Tag + "|" + signal_id + "|Auto";

    // 2. å‡†å¤‡ç†è®ºä»·æ ¼æ•°æ®
    double theoretical_entry = Close[1]; // K[1] æ”¶ç›˜ä»·
    double original_sl       = sl_price; // åŸå§‹æ­¢æŸ

    // 3. æ‰§è¡Œäº¤æ˜“å¹¶è·å– Ticket
    int ticket = OrderSend(Symbol(), type, trade_lots, entry_price, Slippage, sl_price, tp_price, comment, MagicNumber, 0, (type==OP_BUY?Blue:Red));

    // 4. ğŸš¨ æ ¸å¿ƒï¼šå¦‚æœä¸‹å•æˆåŠŸï¼Œå»ºç«‹â€œå½±å­è´¦æœ¬â€
    if (ticket > 0)
    {
        // å˜é‡å‘½åè§„åˆ™: å‰ç¼€_è®¢å•å·_ç±»å‹
        string var_name_E = "KT5_" + IntegerToString(ticket) + "_E";
        string var_name_S = "KT5_" + IntegerToString(ticket) + "_S";
        
        // å­˜å‚¨ç†è®ºä»·æ ¼ (GlobalVariableSet å­˜çš„æ˜¯ doubleï¼Œç²¾åº¦è¶³å¤Ÿ)
        GlobalVariableSet(var_name_E, theoretical_entry);
        GlobalVariableSet(var_name_S, original_sl);
        
        Print("âœ… [å½±å­è´¦æœ¬] è®¢å• #", ticket, " æ•°æ®å·²ç»‘å®š: E=", theoretical_entry, " S=", original_sl);
    }
    else
    {
        Print("âŒ ä¸‹å•å¤±è´¥ï¼Œé”™è¯¯ç : ", GetLastError());
    }

--------------------------------------------------------
//+------------------------------------------------------------------+
//| æ ¸å¿ƒåŠŸèƒ½ï¼šè§£ææ³¨é‡Šå¹¶æ‰§è¡Œæ–æ³¢é‚£å¥‘é˜¶æ¢¯è¿½è¸ª (Fibo Step Trailing)       |
//+------------------------------------------------------------------+
void ManageOpenTrades()
{
   for(int i = OrdersTotal() - 1; i >= 0; i--)
   {
      if(OrderSelect(i, SELECT_BY_POS, MODE_TRADES) == false) continue;
      if(OrderSymbol() != Symbol() || OrderMagicNumber() != MagicNumber) continue;
      
      // ä»…å¤„ç†æŒä»“å• (æ’é™¤æŒ‚å•)
      if(OrderType() > OP_SELL) continue; 

      // =======================================================
      // 1. ä»æ³¨é‡Šä¸­è¿˜åŸ ç†è®ºåæ ‡ (Fibo 0 å’Œ Fibo 1)
      // =======================================================
      string comment = OrderComment();
      
      // æŸ¥æ‰¾æ ‡è®°ä½ç½®
      int pos_E = StringFind(comment, "E:");
      int pos_S = StringFind(comment, "#S:");
      
      // å¦‚æœæ‰¾ä¸åˆ°æ ‡è®°ï¼Œè¯´æ˜è¿™æ˜¯æ—§ç‰ˆæœ¬è®¢å•æˆ–æ‰‹åŠ¨å•ï¼Œè·³è¿‡å¤„ç†
      if (pos_E == -1 || pos_S == -1) continue;
      
      // æå–å­—ç¬¦ä¸²å¹¶è½¬ä¸º double
      // "E:xxxx.x" -> ä» E: åå¼€å§‹æˆªå–ï¼Œç›´åˆ° #S: å‰
      string str_entry = StringSubstr(comment, pos_E + 2, pos_S - (pos_E + 2));
      // "#S:xxxx.x" -> ä» #S: åå¼€å§‹æˆªå–åˆ°æœ«å°¾
      string str_sl    = StringSubstr(comment, pos_S + 3);
      
      double fibo_1_0_price = StringToDouble(str_entry); // ç†è®ºå…¥åœº (Close[1])
      double fibo_0_0_price = StringToDouble(str_sl);    // åŸå§‹æ­¢æŸ
      
      // è®¡ç®—å•ä½è·ç¦» (Risk Unit)
      double unit_dist = MathAbs(fibo_1_0_price - fibo_0_0_price);
      
      // é˜²æ­¢é™¤é›¶æˆ–æå°è·ç¦»é”™è¯¯
      if (unit_dist < Point()) continue;

      // =======================================================
      // 2. è®¡ç®—å…³é”®æ–æ³¢é‚£å¥‘é˜¶æ¢¯ä½ (Target Levels)
      // =======================================================
      // å…¬å¼: ç›®æ ‡ä»· = å…¥åœºä»· +/- (è·ç¦» * å€æ•°)
      int dir = (OrderType() == OP_BUY) ? 1 : -1;
      
      double level_1_618 = fibo_1_0_price + dir * (unit_dist * 0.618); // é—¨æ§›
      double level_2_000 = fibo_1_0_price + dir * (unit_dist * 1.000); // 1:1
      double level_2_618 = fibo_1_0_price + dir * (unit_dist * 1.618); // 1:1.618
      double level_3_000 = fibo_1_0_price + dir * (unit_dist * 2.000); // 1:2
      double level_4_236 = fibo_1_0_price + dir * (unit_dist * 3.236); // 1:3.236

      // è·å–å½“å‰å®æ—¶ä»·æ ¼
      double current_price = (OrderType() == OP_BUY) ? Bid : Ask;
      double current_sl    = OrderStopLoss();
      
      // å®šä¹‰ç§»åŠ¨æ­¢æŸçš„ç›®æ ‡ä½ (New SL)
      double new_sl = 0;
      bool modify_needed = false;
      string action_reason = "";

      // =======================================================
      // 3. é˜¶æ¢¯æˆ˜æœ¯é€»è¾‘ (Ladder Logic) - åªè®¸ä¸Šï¼Œä¸è®¸ä¸‹
      // =======================================================
      
      // åœºæ™¯ A: ä»·æ ¼çªç ´ 1.618 -> ç§»åŠ¨æ­¢æŸåˆ° ä¿æœ¬ä½ (Fibo 1.0 + å¾®åˆ©)
      // å¿…é¡»ç¡®ä¿è¿˜æ²¡ç§»åŠ¨è¿‡ (ç°åœ¨çš„SLæ¯”ä¿æœ¬ä½å·®)
      if ( CheckPricePass(current_price, level_1_618, dir) )
      {
         // ä¿æœ¬ä½ = ç†è®ºå…¥åœº + å°‘é‡ç‚¹å·®ä¿æŠ¤
         double break_even = fibo_1_0_price + dir * (MarketInfo(Symbol(), MODE_SPREAD) * Point());
         
         // å¦‚æœå½“å‰æ­¢æŸæ¯”ä¿æœ¬ä½ è¿˜è¦å·® (äºæŸçŠ¶æ€)ï¼Œåˆ™ä¸Šç§»
         if ( (dir == 1 && current_sl < break_even) || (dir == -1 && current_sl > break_even) )
         {
            new_sl = break_even;
            modify_needed = true;
            action_reason = "ä¿æœ¬(>1.618)";
         }
      }
      
      // åœºæ™¯ B: ä»·æ ¼çªç ´ 2.618 -> é”å®š 1:1 åˆ©æ¶¦ (Fibo 2.0)
      if ( CheckPricePass(current_price, level_2_618, dir) )
      {
         // æ£€æŸ¥å½“å‰SLæ˜¯å¦å·²ç»åœ¨ Fibo 2.0 ä¹‹ä¸Šï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è·Ÿè¿›
         if ( (dir == 1 && current_sl < level_2_000 - Point()) || (dir == -1 && current_sl > level_2_000 + Point()) )
         {
            new_sl = level_2_000;
            modify_needed = true;
            action_reason = "é”å®š1:1(>2.618)";
         }
      }

      // åœºæ™¯ C: ä»·æ ¼çªç ´ 4.236 -> é”å®š 1:2 åˆ©æ¶¦ (Fibo 3.0)
      if ( CheckPricePass(current_price, level_4_236, dir) )
      {
         if ( (dir == 1 && current_sl < level_3_000 - Point()) || (dir == -1 && current_sl > level_3_000 + Point()) )
         {
            new_sl = level_3_000;
            modify_needed = true;
            action_reason = "é”å®š1:2(>4.236)";
         }
      }

      // =======================================================
      // 4. æ‰§è¡Œä¿®æ”¹
      // =======================================================
      if (modify_needed && new_sl != 0)
      {
         // è§„èŒƒåŒ–ä»·æ ¼ç²¾åº¦
         new_sl = NormalizeDouble(new_sl, _Digits);
         
         // æ‰§è¡Œä¿®æ”¹
         if (OrderModify(OrderTicket(), OrderOpenPrice(), new_sl, OrderTakeProfit(), 0, clrNONE))
         {
            Print("ğŸš€ [è¿½è¸ªæ­¢æŸ] è®¢å• #", OrderTicket(), " ", action_reason, 
                  " | å½“å‰ä»·:", DoubleToString(current_price, _Digits),
                  " | æ–°æ­¢æŸ:", DoubleToString(new_sl, _Digits));
         }
         else
         {
            Print("âš ï¸ [è¿½è¸ªæ­¢æŸ] ä¿®æ”¹å¤±è´¥ #", OrderTicket(), " Error:", GetLastError());
         }
      }
   }
}

// è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥ä»·æ ¼æ˜¯å¦ã€è¶…è¿‡ã€‘äº†æŸæ¡çº¿
bool CheckPricePass(double current, double target, int dir)
{
   if (dir == 1) return (current >= target); // åšå¤šï¼šä»·æ ¼ >= ç›®æ ‡
   else          return (current <= target); // åšç©ºï¼šä»·æ ¼ <= ç›®æ ‡
}

**********************************************************************************************
void ManageOpenTrades()
{
   for(int i = OrdersTotal() - 1; i >= 0; i--)
   {
      if(OrderSelect(i, SELECT_BY_POS, MODE_TRADES) == false) continue;
      if(OrderSymbol() != Symbol() || OrderMagicNumber() != MagicNumber) continue;

      // è·å–å½“å‰è®¢å•å·
      int ticket = OrderTicket();

      // =======================================================
      // 1. ä»â€œå½±å­è´¦æœ¬â€è¯»å–ç†è®ºåæ ‡
      // =======================================================
      string var_name_E = "KT5_" + IntegerToString(ticket) + "_E";
      string var_name_S = "KT5_" + IntegerToString(ticket) + "_S";

      // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è®°å½•
      if (!GlobalVariableCheck(var_name_E) || !GlobalVariableCheck(var_name_S))
      {
          // å¦‚æœæ‰¾ä¸åˆ°è®°å½•ï¼ˆå¯èƒ½æ˜¯æ‰‹åŠ¨å•æˆ–æ—§ç‰ˆæœ¬å•ï¼‰ï¼Œåˆ™è·³è¿‡æˆ–å°è¯•ç”¨å½“å‰SL/Openå€’æ¨(ä¸æ¨è)
          continue; 
      }

      // è¯»å–æ•°æ®
      double fibo_1_0_price = GlobalVariableGet(var_name_E); // ç†è®ºå…¥åœº (Close[1])
      double fibo_0_0_price = GlobalVariableGet(var_name_S); // åŸå§‹æ­¢æŸ

      // è®¡ç®—å•ä½è·ç¦» (Risk Unit)
      double unit_dist = MathAbs(fibo_1_0_price - fibo_0_0_price);
      if (unit_dist < Point()) continue;

      // =======================================================
      // 2. åç»­çš„æ–æ³¢é‚£å¥‘é˜¶æ¢¯è®¡ç®— (é€»è¾‘å®Œå…¨ä¸å˜)
      // =======================================================
      // ... (ç›´æ¥å¤åˆ¶ä¹‹å‰çš„é˜¶æ¢¯æˆ˜æœ¯é€»è¾‘ï¼Œæ­¤å¤„çœç•¥ä»¥èŠ‚çœç¯‡å¹…) ...
      // ä½¿ç”¨ fibo_1_0_price å’Œ unit_dist è¿›è¡Œè®¡ç®—å³å¯
   }
}