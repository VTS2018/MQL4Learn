// åœ¨ OnTick çš„ä¸»å¾ªç¯å†…éƒ¨
for (int i = 0; i < total_valid; i++)
{
    FilteredSignal signal_item = sorted_valid_signals[i];
    
    // 1. æ£€æŸ¥ä¸Šä¸‹æ–‡ï¼šä¼ å…¥å½“å‰ä¿¡å·ï¼Œä»¥åŠå®Œæ•´çš„æ¸…æ´—è¿‡çš„ä¿¡å·åˆ—è¡¨
    int context_result = CheckSignalContext(
        signal_item.shift, 
        signal_item.type, 
        clean_bulls, // å·²ç»è¿‡æ–°ä½ä¼˜èƒœè¿‡æ»¤çš„çœ‹æ¶¨åˆ—è¡¨
        clean_bears  // å·²ç»è¿‡æ–°ä½ä¼˜èƒœè¿‡æ»¤çš„çœ‹è·Œåˆ—è¡¨
    );
    
    if (context_result > 0) 
    {
        // 2. æ‰§è¡Œæœ€ç»ˆè¿‡æ»¤ï¼ˆé˜²é‡å¤ä¸‹å•ç­‰ï¼‰
        // ... CheckSignalAndFilter(signal_item, context_result);
        
        // 3. æ‰§è¡Œäº¤æ˜“å¹¶é€€å‡º
        // ...
        return;
    }
}
/************************************************************************************************/
// åœ¨ OnTick çš„ "æ ¸å¿ƒæ‰§è¡Œå¾ªç¯" éƒ¨åˆ†

// ... (MergeAndSortSignals ä¹‹å) ...

for (int i = 0; i < total_valid_signals; i++)
{
    FilteredSignal signal_item = sorted_valid_signals[i];
    int current_shift = signal_item.shift;
    KBarSignal full_data = GetIndicatorBarData(current_shift);

    // ----------------------------------------------------
    // ğŸš¨ æ ¸å¿ƒè°ƒç”¨æ›´æ–° ğŸš¨
    // ----------------------------------------------------
    // å°†æ¸…æ´—è¿‡çš„ä¸¤ä¸ªåˆ—è¡¨ä¼ å…¥å‡½æ•°
    int context_result = CheckSignalContext(current_shift, signal_item.type, clean_bulls, clean_bears);
    
    // åˆ¤å®šé€»è¾‘ï¼š
    // å¦‚æœè¿”å› 0ï¼Œè¯´æ˜æ²¡æœ‰ä¸Šä¸‹æ–‡æ”¯æŒï¼Œé€šå¸¸æˆ‘ä»¬é€‰æ‹©ä¸åšï¼Œæˆ–è€…é™ä½æ‰‹æ•°
    // å¦‚æœè¿”å› > 0 (1=åè½¬, 2=å›è¸©)ï¼Œè¯´æ˜æ˜¯ä¼˜è´¨ä¿¡å·
    
    if (context_result > 0) 
    {
        // æ‰§è¡Œäº¤æ˜“
        CalculateTradeAndExecute(full_data, signal_item.type);
        return;
    }
}
/************************************************************************************************/
//+------------------------------------------------------------------+
//| 6. æ–æ³¢é‚£å¥‘ä¸Šä¸‹æ–‡è®¾ç½® (Fibonacci Context Inputs)                 |
//+------------------------------------------------------------------+
input string   __FIBO_CONTEXT__    = "--- Fibo Exhaustion Levels ---";
input string   Fibo_Zone_1         = "1.618, 1.88";     // æ–æ³¢é‚£å¥‘è¡°ç«­åŒº 1 (æ ¼å¼: Level_A, Level_B)
input string   Fibo_Zone_2         = "2.618, 2.88";     // æ–æ³¢é‚£å¥‘è¡°ç«­åŒº 2
input string   Fibo_Zone_3         = "4.236, 4.88";     // æ–æ³¢é‚£å¥‘è¡°ç«­åŒº 3
// å¦‚æœéœ€è¦æ›´å¤šåŒºåŸŸï¼Œå¯ä»¥ä»¿ç…§æ­¤æ ¼å¼ç»§ç»­æ·»åŠ  Fibo_Zone_4, Fibo_Zone_5...

// å®šä¹‰å…¨å±€å­˜å‚¨ç©ºé—´å’Œè®¡æ•°å™¨
#define MAX_FIBO_ZONES 10 // æœ€å¤§æ”¯æŒçš„æ–æ³¢é‚£å¥‘åŒºåŸŸæ•°é‡
double g_FiboExhaustionLevels[MAX_FIBO_ZONES][2]; // å…¨å±€æ•°ç»„ç”¨äºå­˜å‚¨è§£æç»“æœ
int    g_FiboZonesCount = 0;                     // å®é™…åŠ è½½çš„åŒºåŸŸæ•°é‡
/************************************************************************************************/
//+------------------------------------------------------------------+
//| Helper: è§£æå•ä¸ªæ–æ³¢é‚£å¥‘åŒºåŸŸå­—ç¬¦ä¸² (ä¾‹å¦‚ "1.618, 1.88")         |
//+------------------------------------------------------------------+
bool ParseFiboZone(string fibo_str, double &level1, double &level2)
{
    string tokens[];
    // ä½¿ç”¨é€—å·ä½œä¸ºåˆ†éš”ç¬¦åˆ†å‰²å­—ç¬¦ä¸²
    int count = StringSplit(fibo_str, ',', tokens);
    
    // å¿…é¡»æ­£å¥½åŒ…å«ä¸¤ä¸ªçº§åˆ«
    if (count != 2) return false;
    
    // å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°
    level1 = StringToDouble(StringTrim(tokens[0]));
    level2 = StringToDouble(StringTrim(tokens[1]));
    
    // ç®€å•éªŒè¯ï¼šçº§åˆ«ä¸èƒ½å°äºæˆ–ç­‰äº 0
    if (level1 <= 0 || level2 <= 0) return false; 
    
    // æˆåŠŸè§£æ
    return true;
}

//+------------------------------------------------------------------+
//| åˆå§‹åŒ–æ–æ³¢é‚£å¥‘çº§åˆ« (åœ¨ OnInit ä¸­è°ƒç”¨)                           |
//| å°†å¤–éƒ¨è¾“å…¥å­—ç¬¦ä¸²è§£æå¹¶å¡«å……åˆ°å…¨å±€æ•°ç»„ g_FiboExhaustionLevels      |
//+------------------------------------------------------------------+
void InitializeFiboLevels(string zone1, string zone2, string zone3)
{
    g_FiboZonesCount = 0; // é‡ç½®è®¡æ•°å™¨
    
    // å°è¯•è§£æ Zone 1
    if (ParseFiboZone(zone1, g_FiboExhaustionLevels[g_FiboZonesCount][0], g_FiboExhaustionLevels[g_FiboZonesCount][1]))
        g_FiboZonesCount++;

    // å°è¯•è§£æ Zone 2
    if (g_FiboZonesCount < MAX_FIBO_ZONES && ParseFiboZone(zone2, g_FiboExhaustionLevels[g_FiboZonesCount][0], g_FiboExhaustionLevels[g_FiboZonesCount][1]))
        g_FiboZonesCount++;

    // å°è¯•è§£æ Zone 3
    if (g_FiboZonesCount < MAX_FIBO_ZONES && ParseFiboZone(zone3, g_FiboExhaustionLevels[g_FiboZonesCount][0], g_FiboExhaustionLevels[g_FiboZonesCount][1]))
        g_FiboZonesCount++;
        
    // Print("æ–æ³¢é‚£å¥‘ä¸Šä¸‹æ–‡åŒºåŸŸåˆå§‹åŒ–å®Œæˆã€‚å…±åŠ è½½ ", g_FiboZonesCount, " ä¸ªåŒºåŸŸã€‚");
}
/************************************************************************************************/

int my_array[3][4] = {{1, 2, 3, 4}, {5, 6, 7, 8}, {9, 10, 11, 12}};
int rows = ArraySize(my_array); // è·å–è¡Œæ•° (3)

for(int i = 0; i < rows; i++) { // éå†æ¯ä¸€è¡Œ
    int cols = ArraySize(my_array[i]); // è·å–å½“å‰è¡Œçš„åˆ—æ•° (4)
    for(int j = 0; j < cols; j++) { // éå†æ¯ä¸€åˆ—
        // è®¿é—®å…ƒç´ 
        Print("Element at [", i, "][", j, "] is: ", my_array[i][j]);
        // å¯ä»¥è¿›è¡Œå…¶ä»–æ“ä½œï¼Œæ¯”å¦‚èµ‹å€¼
        // my_array[i][j] = my_array[i][j] * 2;
    }
}
/************************************************************************************************/

//+------------------------------------------------------------------+
//| MQL4 ç¼ºå¤±å‡½æ•°ï¼šStringTrim (ç”¨äºç§»é™¤å­—ç¬¦ä¸²é¦–å°¾ç©ºæ ¼)                |
//+------------------------------------------------------------------+
string StringTrim(string str)
{
   int len = StringLen(str);
   if (len == 0) return str;
   
   // ç§»é™¤å¼€å¤´çš„ç©ºæ ¼
   int start = 0;
   while (start < len && StringGetChar(str, start) == ' ')
   {
      start++;
   }
   
   // å¦‚æœæ•´ä¸ªå­—ç¬¦ä¸²éƒ½æ˜¯ç©ºæ ¼
   if (start == len) return "";
   
   // ç§»é™¤æœ«å°¾çš„ç©ºæ ¼
   int end = len - 1;
   while (end > start && StringGetChar(str, end) == ' ')
   {
      end--;
   }
   
   // è¿”å›ä¿®å‰ªåçš„å­å­—ç¬¦ä¸²
   return StringSubstr(str, start, end - start + 1);
}
/************************************************************************************************/
å®ç°è¿ç»­æ­¢æŸçš„åŠŸèƒ½æ§åˆ¶
//+------------------------------------------------------------------+
//| 7. è¿ç»­æ­¢æŸé£é™©ç®¡ç† (Consecutive SL Risk Management)             |
//+------------------------------------------------------------------+
input string   __RISK_CSL__         = "--- Consecutive SL Settings ---";
input bool     Enable_CSL           = true;     // CSL åŠŸèƒ½æ€»å¼€å…³
input int      CSL_Max_Losses       = 3;        // å…è®¸çš„æœ€å¤§è¿ç»­æ­¢æŸæ¬¡æ•° (ä¾‹å¦‚: è¿ç»­æ­¢æŸ3æ¬¡)
input int      CSL_Lockout_Duration = 4;        // äº¤æ˜“é”å®šå°æ—¶æ•° (ä¾‹å¦‚: é”å®š4å°æ—¶)

//+------------------------------------------------------------------+
//| å…¨å±€çŠ¶æ€å˜é‡ (CSL Tracking)                                      |
//+------------------------------------------------------------------+
int    g_ConsecutiveLossCount = 0;   // å½“å‰è¿ç»­æ­¢æŸè®¡æ•°å™¨
datetime g_CSLLockoutEndTime    = 0;   // äº¤æ˜“é”å®šè§£é™¤çš„æ—¶é—´æˆ³ (0è¡¨ç¤ºæœªé”å®š)