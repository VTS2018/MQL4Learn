//+------------------------------------------------------------------+
//| è¾“å…¥å‚æ•°: ç©ºé—´æ£€æŸ¥æ¨¡å—éœ€è¦çš„ æœ€å°ç›ˆäºæ¯”é˜ˆå€¼ (å»ºè®® 1.0 åˆ° 1.5)                        |
//+------------------------------------------------------------------+
input double Min_Reward_Risk_Ratio = 1.0; ç©ºé—´æ£€æŸ¥æ¨¡å—éœ€è¦çš„ æœ€å°ç›ˆäºæ¯”é˜ˆå€¼ (å»ºè®® 1.0 åˆ° 1.5) 

//+------------------------------------------------------------------+
//| æ ¸å¿ƒåŠŸèƒ½ï¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨è¶³å¤Ÿçš„åˆ©æ¶¦ç©ºé—´ (Profit Space Check)
//| è¿”å›å€¼: true = ç©ºé—´å……è¶³; false = ç©ºé—´ä¸è¶³ï¼Œè¿‡æ»¤äº¤æ˜“
//+------------------------------------------------------------------+
bool CheckProfitSpace(int type, double entry_price, double stop_loss_price, FilteredSignal &history_opponents[])
{
    // 1. è®¡ç®—å½“å‰ä¿¡å·çš„é£é™© (Risk)
    double current_risk = MathAbs(entry_price - stop_loss_price);
    
    // å¼‚å¸¸ä¿æŠ¤ï¼šé˜²æ­¢é£é™©ä¸º0å¯¼è‡´é™¤é›¶é”™è¯¯
    if (current_risk <= Point()) return true; // é£é™©æå°ï¼Œé»˜è®¤æ”¾è¡Œ
    
    // 2. å¯»æ‰¾æœ€è¿‘çš„åå‘éšœç¢ç‰© (Nearest Obstacle)
    double target_price = 0.0;
    int opponent_idx = -1;
    
    int total_opponents = ArraySize(history_opponents);
    
    // éå†åå‘ä¿¡å·åˆ—è¡¨ (history_opponents åº”è¯¥æ˜¯æŒ‰ shift æ’åºçš„ï¼Œindex 0 æ˜¯æœ€æ–°çš„)
    for (int i = 0; i < total_opponents; i++)
    {
        FilteredSignal opp = history_opponents[i];
        
        // æˆ‘ä»¬åªå…³å¿ƒé‚£äº›åœ¨å½“å‰ä»·æ ¼"å‰æ–¹"çš„éšœç¢
        if (type == OP_SELL)
        {
            // åšç©ºï¼šéšœç¢ç‰©å¿…é¡»åœ¨å½“å‰ä»·æ ¼ä¸‹æ–¹
            // æˆ‘ä»¬å–åå‘çœ‹æ¶¨ä¿¡å·çš„ã€æœ€ä½ç‚¹(SL)ã€‘ä½œä¸ºæé™ç›®æ ‡
            // å¦‚æœæ‚¨æƒ³ä¿å®ˆä¸€ç‚¹ï¼Œå¯ä»¥å– opp.confirmation_close
            if (opp.stop_loss < entry_price) 
            {
                target_price = opp.stop_loss;
                opponent_idx = i;
                break; // æ‰¾åˆ°äº†æœ€è¿‘çš„ä¸€ä¸ªä¸‹æ–¹æ”¯æ’‘ï¼Œåœæ­¢æœç´¢
            }
        }
        else if (type == OP_BUY)
        {
            // åšå¤šï¼šéšœç¢ç‰©å¿…é¡»åœ¨å½“å‰ä»·æ ¼ä¸Šæ–¹
            // å–åå‘çœ‹è·Œä¿¡å·çš„ã€æœ€é«˜ç‚¹(SL)ã€‘ä½œä¸ºæé™ç›®æ ‡
            if (opp.stop_loss > entry_price)
            {
                target_price = opp.stop_loss;
                opponent_idx = i;
                break; // æ‰¾åˆ°äº†æœ€è¿‘çš„ä¸€ä¸ªä¸Šæ–¹é˜»åŠ›
            }
        }
    }
    
    // 3. å¦‚æœæ‰¾ä¸åˆ°ä»»ä½•å†å²åå‘ä¿¡å·ä½œä¸ºéšœç¢
    if (target_price == 0.0) 
    {
        // è¯´æ˜å‰æ–¹æ˜¯ä¸€ç‰‡å¼€é˜”åœ° (æˆ–è€…å†å²æ•°æ®ä¸è¶³)ï¼Œé»˜è®¤å…è®¸äº¤æ˜“
        // Print(" [ç©ºé—´æ£€æŸ¥] å‰æ–¹æ— éšœç¢ï¼Œé€šè¿‡ã€‚");
        return true; 
    }
    
    // 4. è®¡ç®—å‰©ä½™ç©ºé—´ (Space)
    double available_space = MathAbs(entry_price - target_price);
    
    // 5. è®¡ç®—ç›ˆäºæ¯” (Reward / Risk)
    double ratio = available_space / current_risk;
    
    // 6. è§†è§‰è°ƒè¯• (å¯é€‰)ï¼šåœ¨å›¾è¡¨ä¸Šç”»å‡ºè¿™ä¸€æ®µ ç©ºé—´ å’Œ é£é™© çš„å¯¹æ¯”
    // è¿™é‡Œåªæ‰“å°æ—¥å¿—ï¼Œæ‚¨ä¹Ÿå¯ä»¥è°ƒç”¨ç”»çº¿å‡½æ•°
    string direction = (type == OP_SELL) ? "çœ‹è·Œ" : "çœ‹æ¶¨";
    
    if (ratio < Min_Reward_Risk_Ratio)
    {
        Print("ğŸ›‘ [ç©ºé—´è¿‡æ»¤] ", direction, "ä¿¡å·è¢«æ‹’ç»ï¼é£é™©: ", DoubleToString(current_risk/Point(), 0), 
              "pt | å‰©ä½™ç©ºé—´: ", DoubleToString(available_space/Point(), 0), 
              "pt | ç›ˆäºæ¯”: ", DoubleToString(ratio, 2), " < ", Min_Reward_Risk_Ratio);
        return false; // ç©ºé—´å¤ªå°ï¼Œæ‹’ç»
    }
    
    // ç©ºé—´å……è¶³
    Print("âœ… [ç©ºé—´å……è¶³] ", direction, "ä¿¡å·é€šè¿‡ã€‚ç›ˆäºæ¯”: ", DoubleToString(ratio, 2));
    return true;
}