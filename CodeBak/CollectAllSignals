//+------------------------------------------------------------------+
//| L0: ä¿¡å·æ”¶é›†å™¨ (CollectAllSignals)                               |
//| èŒè´£ï¼šä»æŒ‡æ ‡ç¼“å†²åŒºå…¨é‡æ”¶é›†ä¿¡å·ï¼Œå¹¶æ‰§è¡Œæœ€é«˜æ•ˆçš„ä»·æ ¼åŒºä½è¿‡æ»¤ã€‚       |
//| V2.0 ä¼˜åŒ–ï¼šç¡®ä¿ K[1] ä¿¡å·ä¸è¢«ä»·æ ¼åŒºä½è¿‡æ»¤é”™è¯¯å‰”é™¤ã€‚               |
//+------------------------------------------------------------------+
void CollectAllSignals(FilteredSignal &bullish_list[], FilteredSignal &bearish_list[])
{
    // 1. æ¸…ç©ºæ•°ç»„ï¼Œå‡†å¤‡é‡æ–°æ”¶é›† (æ•°ç»„å°†æŒ‰ shift ä»å°åˆ°å¤§å¡«å……ï¼Œå³ä»æœ€æ–°åˆ°æœ€æ—§)
    ArrayResize(bullish_list, 0); 
    ArrayResize(bearish_list, 0); 

    // ğŸš¨ æ ¸å¿ƒä¿®æ­£ 1ï¼šè·å–ç°ä»·åŸºå‡† (ä½¿ç”¨å½“å‰ K çº¿çš„æ”¶ç›˜ä»· Close[0])
    double current_price = Close[0]; 
    
    // 2. å¼€å§‹æ‰«æï¼šä» K[1] (shift=1) å¾€å†å²å·¦ä¾§æ‰«æ
    for (int shift = 1; shift <= Indi_LastScan_Range; shift++)
    {
        // A. æ‰¹é‡è¯»å–æ‰€æœ‰ç¼“å†²åŒºæ•°æ® (å‡è®¾ GetIndicatorBarData å¯ç”¨)
        KBarSignal data = GetIndicatorBarData(shift); 
        
        // =============================================================
        // ğŸš¨ æ ¸å¿ƒä¿®æ­£ 2ï¼šK[1] ä¿¡å·çš„æ— æ¡ä»¶é€šè¡Œæƒ
        // ç¡®ä¿ K[1] ä¸è¢« K[0] çš„è·³ç©ºä½å¼€/é«˜å¼€é”™è¯¯è¿‡æ»¤
        // =============================================================
        bool is_valid_price_zone = false;

        if (shift == 1) 
        {
            // K[1] (æœ€æ–°ä¿¡å·) å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼Œæ— æ¡ä»¶é€šè¿‡ä»·æ ¼åŒºä½æ£€æŸ¥
            is_valid_price_zone = true; 
        }
        else // K[2] åŠæ›´è€çš„ä¿¡å·ï¼Œå¿…é¡»è¿›è¡Œä»·æ ¼åŒºä½æ£€æŸ¥
        {
            // --- çœ‹æ¶¨ä¿¡å·çš„ä»·æ ¼åŒºä½æ£€æŸ¥ (å¿…é¡»ä½äºç°ä»·) ---
            if (data.BullishReferencePrice != (double)EMPTY_VALUE && data.BullishReferencePrice != 0.0)
            {
                if (Close[shift] < current_price)
                    is_valid_price_zone = true; 
            }
            // --- çœ‹è·Œä¿¡å·çš„ä»·æ ¼åŒºä½æ£€æŸ¥ (å¿…é¡»é«˜äºç°ä»·) ---
            else if (data.BearishReferencePrice != (double)EMPTY_VALUE && data.BearishReferencePrice != 0.0)
            {
                if (Close[shift] > current_price)
                    is_valid_price_zone = true; 
            }
        }

        
        // ---------------------------------------------
        // B. æ£€æŸ¥å¹¶æ·»åŠ çœ‹æ¶¨ä¿¡å· (OP_BUY)
        // ---------------------------------------------
        if (data.BullishReferencePrice != (double)EMPTY_VALUE && 
            (int)data.BullishReferencePrice >= Min_Signal_Quality && // ä¿¡å·è´¨é‡æ£€æŸ¥
            data.BullishStopLossPrice != (double)EMPTY_VALUE && data.BullishStopLossPrice != 0.0)
        {
            // ğŸš¨ å¼•å…¥ä»·æ ¼åŒºä½æ£€æŸ¥
            if (is_valid_price_zone) 
            {
                int current_size = ArraySize(bullish_list); 
                ArrayResize(bullish_list, current_size + 1); 

                bullish_list[current_size].shift = shift;
                bullish_list[current_size].signal_time = data.OpenTime;
                bullish_list[current_size].confirmation_close = Close[shift]; 
                bullish_list[current_size].stop_loss = data.BullishStopLossPrice; 
                bullish_list[current_size].type = OP_BUY;
            }
        }
        
        // ---------------------------------------------
        // C. æ£€æŸ¥å¹¶æ·»åŠ çœ‹è·Œä¿¡å· (OP_SELL)
        // ---------------------------------------------
        if (data.BearishReferencePrice != (double)EMPTY_VALUE && 
            (int)data.BearishReferencePrice >= Min_Signal_Quality && // ä¿¡å·è´¨é‡æ£€æŸ¥
            data.BearishStopLossPrice != (double)EMPTY_VALUE && data.BearishStopLossPrice != 0.0)
        {
            // ğŸš¨ å¼•å…¥ä»·æ ¼åŒºä½æ£€æŸ¥
            if (is_valid_price_zone)
            {
                int current_size = ArraySize(bearish_list); 
                ArrayResize(bearish_list, current_size + 1); 

                bearish_list[current_size].shift = shift;
                bearish_list[current_size].signal_time = data.OpenTime;
                bearish_list[current_size].confirmation_close = Close[shift]; 
                bearish_list[current_size].stop_loss = data.BearishStopLossPrice; 
                bearish_list[current_size].type = OP_SELL;
            }
        }
    }
}